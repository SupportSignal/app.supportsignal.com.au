# Story 0.3: Dead Code Discovery & Cleanup (Functions, Routes, Components, Workers)

## Status
Ready

## Story
**As a** development team maintaining the SupportSignal codebase,
**I want** a systematic discovery and cleanup of unused code across Convex functions, Next.js routes, React components, and Cloudflare Workers,
**so that** we reduce maintenance burden, improve code clarity, and eliminate confusion about which code is actively used in production.

## Acceptance Criteria
- [ ] Complete dead code audit report with categorized findings:
  - **Orphaned Code**: No references (immediate removal candidates)
  - **Questionable Code**: Requires human review with structured questions (stale or POC code)
  - **Active Code**: Production code (document purpose)
- [ ] Analysis across all code layers:
  - Convex functions (queries, mutations, actions)
  - Next.js routes and API endpoints
  - React components and hooks
  - Cloudflare Workers
- [ ] Human-approved cleanup execution:
  - Remove orphaned code after explicit approval
  - Resolve questionable code with human decisions
  - Document active code with purpose comments
- [ ] Validation after cleanup (typecheck, build, tests)
- [ ] Comprehensive audit report documenting findings and actions taken

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**High** - Requires multi-layer analysis with complex dependency tracing across frontend, backend, and edge infrastructure

### Estimated Time
8-12 hours

### Risk Level
**High**

### Risk Factors
- **Breaking Production**: Incorrectly removing code still used in critical paths
- **Hidden Dependencies**: Code referenced indirectly (dynamic imports, string-based references)
- **Cross-Layer Complexity**: Functions calling functions, components using hooks, routes using API endpoints
- **Test Code Confusion**: Distinguishing between production code and test utilities
- **Worker Isolation**: Cloudflare Workers may have separate dependency graphs

### Mitigation Strategy
- **Dependency Tracing First**: Map all code relationships before categorizing
- **Conservative Categorization**: When in doubt, mark as "Questionable" not "Orphaned"
- **Human Approval Gate**: NEVER delete without explicit approval
- **Incremental Validation**: Typecheck + build + test after each removal
- **Backup Strategy**: Git commit before cleanup, easy rollback if issues arise
- **Story 0.2 Handoff**: Use active table list from database audit to validate function usage

## Tasks / Subtasks

- [ ] **Phase 1: Convex Functions Discovery** (AC: 1, 2)
  - [ ] List all Convex functions using `bunx convex function-spec`
  - [ ] For each function, grep for usage in:
    - Frontend (useQuery, useMutation, useAction calls)
    - Other Convex functions (ctx.runQuery, ctx.runMutation, ctx.scheduler)
    - API routes (fetchQuery, fetchMutation)
    - Workers (if applicable)
  - [ ] Check git timestamps for last modification (>2 months = questionable)
  - [ ] Identify early POC functions (created in first month of project)
  - [ ] Cross-reference with active tables from Story 0.2 (functions using orphaned tables = likely orphaned)
  - [ ] Categorize: Orphaned / Questionable / Active

- [ ] **Phase 2: Next.js Routes & API Endpoints Discovery** (AC: 1, 2)
  - [ ] List all app router pages (`apps/web/app/**/page.tsx`)
  - [ ] List all API routes (`apps/web/app/api/**/route.ts`)
  - [ ] For each route, check for:
    - Navigation references (Link, router.push, redirect)
    - Form action references
    - External API calls (fetch to route)
    - Documentation references
  - [ ] Check git timestamps and POC status
  - [ ] Categorize: Orphaned / Questionable / Active

- [ ] **Phase 3: React Components & Hooks Discovery** (AC: 1, 2)
  - [ ] List all components in `apps/web/components/`
  - [ ] List all custom hooks in `apps/web/hooks/` or `apps/web/lib/`
  - [ ] For each component/hook, grep for import statements:
    - Direct imports (`import { Component } from '@/components/...'`)
    - Dynamic imports (`const Component = lazy(() => import(...))`)
  - [ ] Check for ShadCN UI components (part of design system, likely active)
  - [ ] Check git timestamps and POC status
  - [ ] Categorize: Orphaned / Questionable / Active

- [ ] **Phase 4: Cloudflare Workers Discovery** (AC: 1, 2)
  - [ ] List all workers in `apps/workers/`
  - [ ] For each worker, check for:
    - Environment variable references (WORKER_URL patterns)
    - Convex function calls to worker
    - Frontend fetch calls to worker endpoints
    - Deployment status (wrangler list)
  - [ ] Check git timestamps and POC status
  - [ ] Categorize: Orphaned / Questionable / Active

- [ ] **Phase 5: Human Review & Cleanup Execution** (AC: 1, 3, 4)
  - [ ] **For ORPHANED code** (each layer):
    - [ ] Present removal plan to human for approval
    - [ ] **WAIT for explicit approval**
    - [ ] Execute approved deletions (git commit per layer for easy rollback)
    - [ ] Run validation: `bun run typecheck && bun run build && bun test`
    - [ ] Fix any broken references immediately
  - [ ] **For QUESTIONABLE code** (each layer):
    - [ ] Present structured questions to human:
      - **Title**: "[Layer] [Name] - [Brief Purpose]"
      - **Description**: "Last modified: [date]. Created: [early POC / later feature]. Referenced by: [list]"
      - **Question**: "Is this code still needed for [purpose]? Keep or remove?"
    - [ ] **WAIT for human decision**
    - [ ] For "remove" decisions: Delete immediately and validate
    - [ ] For "keep" decisions: Add purpose comment to code
  - [ ] **For ACTIVE code** (documentation only):
    - [ ] Add JSDoc comments with purpose
    - [ ] Document ownership/responsibility if known
    - [ ] No code changes required

- [ ] **Phase 6: Cross-Layer Dependency Validation** (AC: 4)
  - [ ] After all cleanup, run comprehensive validation:
    - [ ] `bun run typecheck` - TypeScript compilation
    - [ ] `bun run lint` - ESLint validation
    - [ ] `bun test` - Unit tests
    - [ ] `bun run build` - Production build
    - [ ] `bun test:e2e` - E2E tests (if applicable)
  - [ ] Verify no broken references introduced
  - [ ] Test critical user flows manually if needed

- [ ] **Phase 7: Reporting & Documentation** (AC: 5)
  - [ ] Document audit findings in story completion notes:
    - Summary statistics (before/after counts per layer)
    - Categorized code list with reasoning
    - Code removed (with human approval timestamps)
    - Code kept with updated documentation
    - Lessons learned for future development
  - [ ] Update story with completion notes

## Documentation Impact Assessment

### Architectural Patterns
- **Dead Code Detection Pattern**: Multi-layer dependency tracing methodology (NEW)
- **Cross-Layer Analysis Strategy**: How to validate code usage across frontend/backend/edge (NEW)
- **Incremental Cleanup Pattern**: Layer-by-layer removal with validation (NEW)

### Documentation Updates Required
- Story completion notes contain all audit findings (no separate audit report needed)
- `docs/patterns/code-cleanup-patterns.md` - Dead code detection methodology (CREATE if valuable)
- `docs/architecture/component-registry.md` - Active component catalog (OPTIONAL)

### Knowledge Capture Opportunities
- **When code can be considered orphaned**: Criteria across different layers (functions vs components vs routes)
- **How to trace dependencies**: Systematic grep patterns and import analysis
- **Hidden dependency patterns**: Dynamic imports, string-based references, scheduler usage
- **Validation sequence**: Comprehensive post-cleanup testing strategy
- **Story handoff pattern**: Using Story 0.2's active table list to validate function cleanup

### Examples to Create
- Dead code detection automation script (if patterns emerge)
- Dependency graph visualization (if useful for future audits)
- Component/function registry template (for ongoing maintenance)

## Story 0.2 Handoff - Deprecated Table Code Removal

### Tables Deprecated in Story 0.2

The following tables were removed from `apps/convex/schema.ts` as part of Story 0.2 database cleanup:

1. **test_messages** - Development test table
2. **chat_messages** + **chat_sessions** - POC chat system (August 2025)
3. **source_documents** + **document_chunks** - POC knowledge ingestion spike (Story 4.2)

**Schema Backup**: `apps/convex/schema.ts.backup-YYYYMMDD-HHMMSS`

### Code Removal Tasks

#### Task 1: Remove test_messages Code

**Files to Update**:
- `apps/convex/queries.ts` - Remove test message queries and mutations

**Functions to Remove**:
```typescript
// In apps/convex/queries.ts:
- export const getTestMessage
- export const getTestMessages
- export const createTestMessage
```

**Validation**:
- Typecheck: `bun run typecheck`
- Build: `bun run build`
- No frontend usage detected

#### Task 2: Remove Chat System Code (chat_messages + chat_sessions)

**Files to Update**:
1. `apps/convex/agent.ts` - Remove chat_messages references
2. `apps/convex/agentActions.ts` - Remove chat_sessions references
3. `apps/web/app/chat/page.tsx` - Remove or update chat UI page

**Investigation Required**:
- Determine if `/chat` route should be completely removed or repurposed
- Check if chat UI components are used elsewhere
- Verify no production features depend on chat system

**Validation**:
- Typecheck: `bun run typecheck`
- Build: `bun run build`
- Manual test: Navigate to `/chat` route (should 404 or show error if removed)

#### Task 3: Document Knowledge Ingestion POC (source_documents + document_chunks)

**IMPORTANT**: These tables are from a POC spike and should be DOCUMENTED, not removed yet.

**Files Involved**:
- `apps/convex/knowledge.ts` - POC implementation
- `apps/convex/knowledgeMutations.ts` - POC mutations
- `tests/convex/knowledge.test.ts` - POC tests
- `tests/convex/knowledgeMutations.test.ts` - POC tests

**Action for Story 0.3**:
1. **Add POC documentation comment** to each file:
   ```typescript
   /**
    * PROOF OF CONCEPT - Knowledge Ingestion System (Story 4.2)
    *
    * This code represents a POC spike for vector-based knowledge ingestion
    * using Cloudflare Vectorize. The tables (source_documents, document_chunks)
    * have been deprecated in Story 0.2.
    *
    * Status: POC only - not production-ready
    * Future: Requires full implementation or removal decision
    */
   ```

2. **DO NOT REMOVE CODE** - Keep for reference and potential future implementation
3. **Update tests** to skip or mark as POC-only if they fail

**Validation**:
- Tests may fail due to missing tables - that's expected
- Document test failures in Story 0.3 completion notes

### Summary of Code Removal

| Table | Files to Update | Action | Priority |
|-------|----------------|--------|----------|
| test_messages | queries.ts | Remove functions | High |
| chat_messages | agent.ts | Remove/investigate | High |
| chat_sessions | agentActions.ts, agent.ts, chat/page.tsx | Remove/investigate | High |
| source_documents | knowledge.ts, knowledgeMutations.ts, tests | Document as POC | Medium |
| document_chunks | knowledge.ts, knowledgeMutations.ts, tests | Document as POC | Medium |

### TypeScript Errors to Fix

**Current Status**: Typecheck FAILS (20 errors from deprecated tables)

**File: apps/convex/agent.ts** (8 errors):
- Line 22: `chat_sessions` table reference
- Line 44: `chat_messages` table reference
- Line 68-69: `chat_sessions` query with index
- Line 87-88: `chat_messages` query with index

**File: apps/convex/knowledge.ts** (10 errors):
- Line 12-13: `source_documents` query with index
- Line 34: `source_documents` table reference
- Line 57-59: `document_chunks` query with index
- Line 84-85: `document_chunks` query with index

**File: apps/convex/queries.ts** (2 errors):
- Line 18: `test_messages` query
- Line 28: `test_messages` insert

### Validation Checklist

After completing code removal:

- [ ] TypeScript compilation passes: `bun run typecheck`
- [ ] Linting passes: `bun run lint`
- [ ] Build succeeds: `bun run build`
- [ ] Unit tests pass (excluding POC tests): `bun test`
- [ ] No broken imports or references
- [ ] Manual testing of affected routes/features
- [ ] Remove schema backup file: `apps/convex/schema.ts.backup-20251006-083657`

### Notes from Story 0.2

- Schema backup created before table removal: `apps/convex/schema.ts.backup-20251006-083657`
- **TODO**: Remove schema backup file after Story 0.3 completes successfully
- All code removal should follow human-in-loop approval pattern
- POC code documentation is preferred over deletion for potential future use
- Comprehensive validation required after each removal

---

## Dev Notes

### Previous Story Insights
[Source: Story 0.2 - Database Schema Audit]

**Key Methodology Lessons from Story 0.2**:
- **Categorization Approach**: Orphaned / Questionable / Active categorization works well
- **Human Approval Gates**: NEVER delete without explicit approval
- **Structured Questions**: Title + Description + Explicit Question format for human decisions
- **Git Timestamps**: >2 months staleness threshold appropriate for young project
- **Early POC Detection**: Code from first month of project likely experimental
- **Incremental Validation**: Validate after each removal to catch issues early
- **Story Handoff**: Use Story 0.2's active table list to validate function usage

### Dependency Tracing Strategy

**Convex Functions - Usage Detection**:
```bash
# Find useQuery/useMutation/useAction calls in frontend
grep -r "useQuery(api\\.FUNCTION_PATH" apps/web/ --include="*.tsx" --include="*.ts"
grep -r "useMutation(api\\.FUNCTION_PATH" apps/web/ --include="*.tsx" --include="*.ts"
grep -r "useAction(api\\.FUNCTION_PATH" apps/web/ --include="*.tsx" --include="*.ts"

# Find Convex function calls in other Convex functions
grep -r "ctx\\.runQuery(api\\.FUNCTION_PATH" apps/convex/ --include="*.ts"
grep -r "ctx\\.runMutation(api\\.FUNCTION_PATH" apps/convex/ --include="*.ts"
grep -r "ctx\\.scheduler\\." apps/convex/ --include="*.ts"

# Find API route usage
grep -r "fetchQuery.*api\\.FUNCTION_PATH" apps/web/app/api/ --include="*.ts"

# Check last modified date
git log -1 --format="%ci" -- apps/convex/path/to/function.ts
```

**Next.js Routes - Usage Detection**:
```bash
# Find Link/navigation references
grep -r "href=\\\"ROUTE_PATH" apps/web/ --include="*.tsx"
grep -r "router\\.push(\\\"ROUTE_PATH" apps/web/ --include="*.tsx"
grep -r "redirect(\\\"ROUTE_PATH" apps/web/ --include="*.tsx"

# Find API route calls
grep -r "fetch(.*\\/api\\/ROUTE_PATH" apps/web/ --include="*.tsx" --include="*.ts"

# Find form actions
grep -r "action=\\\"ROUTE_PATH" apps/web/ --include="*.tsx"

# Check documentation references
grep -r "ROUTE_PATH" docs/ --include="*.md"
```

**React Components - Usage Detection**:
```bash
# Find direct imports
grep -r "import.*COMPONENT_NAME.*from" apps/web/ --include="*.tsx" --include="*.ts"

# Find dynamic imports
grep -r "lazy.*COMPONENT_NAME" apps/web/ --include="*.tsx" --include="*.ts"

# Find component usage (JSX)
grep -r "<COMPONENT_NAME" apps/web/ --include="*.tsx"

# Check if part of UI library (ShadCN components likely active)
grep -r "COMPONENT_NAME" apps/web/components/ui/ --include="*.tsx"
```

**Cloudflare Workers - Usage Detection**:
```bash
# Find environment variable references
grep -r "WORKER_URL" apps/convex/ apps/web/ --include="*.ts" --include="*.tsx"

# Find fetch calls to worker endpoints
grep -r "fetch.*workers\\.dev" apps/ --include="*.ts" --include="*.tsx"

# Check deployment status
cd apps/workers/WORKER_NAME && wrangler list

# Check git timestamps
git log -1 --format="%ci" -- apps/workers/WORKER_NAME/
```

### Categorization Criteria

**Orphaned Code (Safe Removal Candidates)**:
- Zero references across all grep patterns
- Not mentioned in documentation
- No recent git activity (>2 months)
- Not part of core infrastructure (auth, multi-tenant, etc.)

**Questionable Code (Human Review Required)**:
- Referenced in code BUT last modified >2 months ago (before August 2025)
- Created in first month of project (likely proof of concept)
- Unclear current usage (test utility vs production code)
- Referenced only in comments or documentation
- Has dependencies on tables/functions flagged in Story 0.2

**Active Code (Production Use)**:
- Recent code activity (modified in last 2 months)
- Multiple references across codebase
- Part of core user workflows
- Referenced in recent git commits or PRs

### Cross-Layer Validation

**Story 0.2 Handoff Pattern**:
1. Story 0.2 identifies **active tables** (e.g., `incidents`, `companies`, `users`)
2. Story 0.3 searches for Convex functions using those tables
3. Functions using **only active tables** = likely active
4. Functions using **orphaned/deprecated tables** = likely orphaned
5. This cross-validation reduces false positives

**Example**:
```bash
# Story 0.2 determined `test_messages` table is deprecated
# Find all functions using that table:
grep -r "db\\.query('test_messages')" apps/convex/ --include="*.ts"
grep -r "db\\.insert('test_messages')" apps/convex/ --include="*.ts"

# Any functions found are likely orphaned or test-only
```

### Hidden Dependency Patterns

**Dynamic Imports** (often missed by simple grep):
```typescript
// Component example
const DynamicComponent = lazy(() => import('@/components/DynamicComponent'));

// Route example
const module = await import(`./modules/${moduleName}`);
```

**String-based References** (scheduler, API routes):
```typescript
// Convex scheduler
ctx.scheduler.runAfter(0, api.myModule.myFunction);

// API route string construction
const response = await fetch(`/api/${endpoint}`);
```

**Indirect References** (component props):
```typescript
// Component passed as prop
<Layout sidebar={CustomSidebar} />
```

### Audit Report Template Structure

**Required Sections**:

1. **Executive Summary**
   - Total code analyzed (per layer)
   - Orphaned code removed
   - Questionable code reviewed
   - Active code documented
   - Validation results

2. **Convex Functions Findings**
   - Orphaned functions list with reasoning
   - Questionable functions with human decisions
   - Active functions with documented purposes
   - Removal summary with approval timestamps

3. **Next.js Routes Findings**
   - Orphaned routes/API endpoints
   - Questionable routes with decisions
   - Active routes with purposes
   - Navigation cleanup summary

4. **React Components Findings**
   - Orphaned components/hooks
   - Questionable components with decisions
   - Active components (UI library, core features)
   - Component cleanup summary

5. **Cloudflare Workers Findings**
   - Orphaned workers
   - Questionable workers with decisions
   - Active workers with purposes
   - Worker cleanup summary

6. **Cross-Layer Validation Results**
   - Story 0.2 handoff analysis (table → function mapping)
   - Dependency chain validation
   - Broken reference fixes
   - Comprehensive test results

7. **Lessons Learned**
   - Hidden dependency patterns discovered
   - Categorization challenges
   - Validation improvements
   - Recommendations for preventing future dead code

### File Locations

**Code Layers**:
- **Convex Functions**: `apps/convex/` (queries, mutations, actions)
- **Next.js Routes**: `apps/web/app/**/page.tsx`, `apps/web/app/api/**/route.ts`
- **React Components**: `apps/web/components/`, `apps/web/hooks/`, `apps/web/lib/`
- **Cloudflare Workers**: `apps/workers/*/src/`

**Audit Output**: Story completion notes (self-contained documentation)

### Critical Reminders

- **NEVER** delete code without explicit human approval
- **ALWAYS** validate after each layer cleanup (typecheck, build, test)
- **USE Story 0.2 results**: Active table list validates function usage
- **CHECK for hidden dependencies**: Dynamic imports, string references, scheduler calls
- **VERIFY** git timestamps >2 months AND early POC status
- **PREPARE structured questions**: Title + Description + Explicit Question
- **DOCUMENT** reasoning for every categorization decision
- **COMMIT** per layer for easy rollback if issues arise
- **TEST comprehensively**: Unit tests, E2E tests, manual testing if needed

### Pattern Validation

[Source: docs/architecture/coding-standards.md]

**Next.js App Router Patterns**:
- Server Components by default (`app/` directory)
- Client Components with `"use client"` directive
- API routes in `app/api/` with `route.ts` naming

**Convex Function Patterns**:
- Queries: Read-only operations with `query()`
- Mutations: Write operations with `mutation()`
- Actions: External API calls with `action()`

**Component Patterns**:
- ShadCN UI components in `components/ui/`
- Feature components in `components/features/`
- Custom hooks in `hooks/` or `lib/hooks/`

### Testing

**Validation Sequence (MANDATORY after cleanup)**:
```bash
# 1. TypeScript compilation
bun run typecheck  # Must pass with 0 errors

# 2. Linting
bun run lint  # Must pass with 0 warnings

# 3. Unit tests
bun test  # All tests must pass

# 4. Production build
bun run build  # Must complete successfully

# 5. E2E tests (if applicable)
bun test:e2e  # Critical user flows must pass
```

**Testing Strategy**:
- No new tests required for this audit story
- Validation through existing test suite
- Fix any broken tests caused by code removal
- Manual testing of critical flows if needed

[Source: docs/testing/technical/test-strategy-and-standards.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Story created following BMAD formal workflow. Scope: Dead code discovery and cleanup for Convex functions, Next.js routes, React components, and Cloudflare Workers. Builds on Story 0.2 database audit methodology. | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
_[To be populated by dev agent during implementation]_

### Completion Notes List
_[To be populated by dev agent during implementation]_

### File List
_[To be populated by dev agent during implementation]_

## QA Results

### Pattern Compliance Review
_[To be populated by QA agent after implementation]_

### Knowledge Capture Reference
_[To be populated by QA agent after KDD process - links to knowledge base files only]_

### Velocity Data
_[To be populated by QA agent - actual vs estimated time, story point accuracy, complexity validation]_
