# Story 0.7: Authorization UI Consistency - Unauthorized Access Messaging

**Epic**: 0 (Technical Debt & Continuous Improvement)
**Status**: 📋 **Planned**
**Priority**: P1 (High)
**Estimated Effort**: Medium (4-6 hours)
**Category**: User Experience / Technical Debt
**Discovered**: October 13, 2025 - Story 7.5 SAT revealed inconsistent authorization UI patterns

---

## Problem Statement

The application has inconsistent UI patterns for displaying unauthorized access messages across different pages. During Story 7.5 acceptance testing, we discovered three distinct patterns in use:

1. **UnauthorizedAccessCard component** - Consistent, well-designed pattern (5 pages ✅)
2. **Alert component** - Inconsistent, minimal messaging (3 pages ❌)
3. **Custom UI** - Unknown patterns (11+ pages need audit ❓)

This inconsistency creates:
- **Poor user experience** - Different error messages/styling for same permission failures
- **Maintenance burden** - Multiple patterns to update when requirements change
- **Developer confusion** - Unclear which pattern to use when implementing authorization checks
- **Testing complexity** - Multiple UI patterns to test for same business logic

Additionally, the current `UnauthorizedAccessCard` component is hardcoded for `system_admin` roles only, limiting its usefulness for other permission scenarios (company_admin, feature access, authentication failures).

---

## Scope

**Phase 1: Complete Authorization UI Audit**
- Systematically test all admin and restricted pages with 3 user roles:
  - System Administrator (full access)
  - Company Administrator (company-scoped access)
  - Frontline Worker (participant-scoped access)
- Document actual vs expected behavior for each URL
- Categorize UI patterns (UnauthorizedAccessCard, Alert, custom, none)
- Identify permission bugs and security issues

**Phase 2: Component Enhancement**
- Enhance `UnauthorizedAccessCard` to support multiple authorization scenarios:
  - Different role requirements (not just system_admin)
  - Feature access restrictions
  - Authentication vs authorization failures
  - Custom actions and navigation options
- Maintain backward compatibility with existing usages

**Phase 3: Pattern Migration**
- Migrate 3 Alert pages to enhanced UnauthorizedAccessCard
- Fix any custom UI patterns discovered in audit
- Apply consistent pattern to all restricted pages
- Update any permission bugs found during audit

**Phase 4: Documentation & Testing**
- Document authorization UI pattern in coding standards
- Create comprehensive Story Acceptance Test with all URLs
- Update developer guidelines for implementing authorization checks

**Out of Scope**:
- Authorization logic changes (business rules remain unchanged)
- Role hierarchy refactoring
- Permission system redesign

---

## Current Audit Summary

### ✅ Consistent - Using UnauthorizedAccessCard (5 pages)

1. **`/admin/companies`** - system_admin only
2. **`/admin/companies/[id]/edit`** - system_admin OR demo_admin
3. **`/admin/companies/[id]/sites`** - system_admin only
4. **`/admin/companies/[id]/users`** - system_admin only
5. **`/admin/companies/[id]/participants`** - system_admin only

### ❌ Inconsistent - Using Alert Component (3 pages)

6. **`/admin/users`** - "You do not have permission to access global user management"
7. **`/admin/companies/[id]/users/invite`** - "You do not have permission to invite users"
8. **`/users`** - "You do not have permission to access user management"

### ❓ Unknown - Need Comprehensive Audit (11+ pages)

9. **`/admin/page.tsx`** - Has custom unauthorized UI
10. **`/admin/companies/create`** - Unknown authorization pattern
11. **`/admin/developer-tools/export`** - Unknown authorization pattern
12. **`/admin/companies/[id]/participants/create`** - Has role checks
13. **`/admin/companies/[id]/participants/[id]/edit`** - Has role checks
14. **`/dashboard`** - Has permission checks
15. **`/participants`** - Has permission checks
16. **`/showcase`** - Has permission checks
17. Plus additional URLs to be discovered during systematic audit

---

## Acceptance Criteria

### Phase 1: Complete Audit
- [ ] **Comprehensive URL list** - All restricted pages documented with expected permissions
- [ ] **Role-based testing matrix** - Test results for system_admin, company_admin, frontline_worker
- [ ] **Pattern categorization** - Each page categorized by UI pattern used
- [ ] **Bug identification** - Security issues and permission bugs documented
- [ ] **Audit report** - Complete findings in story completion notes

### Phase 2: Component Enhancement
- [ ] **Enhanced UnauthorizedAccessCard** - Supports multiple authorization scenarios
- [ ] **Backward compatibility** - Existing 5 pages work without changes
- [ ] **Flexible messaging** - Not hardcoded to "System administrator" wording
- [ ] **Icon/variant options** - Different visual treatments for different scenarios
- [ ] **Documentation** - Component props and usage examples documented

### Phase 3: Pattern Migration
- [ ] **Alert pages migrated** - 3 Alert pages use UnauthorizedAccessCard
- [ ] **Custom UI standardized** - Unknown patterns replaced with standard component
- [ ] **Permission bugs fixed** - Any issues found in audit resolved
- [ ] **Visual consistency** - All unauthorized pages have consistent look/feel

### Phase 4: Documentation & Testing
- [ ] **Coding standards updated** - Authorization UI pattern documented
- [ ] **Developer guidelines** - Clear instructions for implementing auth checks
- [ ] **Story Acceptance Test** - Comprehensive test covering all URLs and roles
- [ ] **Test execution** - SAT passed with all scenarios validated

### Validation
- [ ] **TypeScript**: `bun run typecheck` passes with zero errors
- [ ] **Linting**: `bun run lint` passes with zero warnings
- [ ] **Tests**: `bun test` passes (all unit tests green)
- [ ] **Build**: `bun run build` completes successfully
- [ ] **CI**: `bun run ci:status` shows SUCCESS
- [ ] **Manual Testing**: Story Acceptance Test executed with all roles

---

## Permission Types Reference

For comprehensive audit testing, document behavior for:

1. **system_admin** - Full system access (all admin pages)
2. **demo_admin** - Limited admin for demos (some admin pages)
3. **company_admin** - Company-scoped management (Epic 9)
4. **frontline_worker** - Participant-scoped access (view own data)
5. **authenticated_user** - Basic authenticated features
6. **unauthenticated** - Public pages only

---

## Story Acceptance Test (SAT)

### Test Environment Setup

**Required Test Users**:
1. **System Administrator** (David) - `david@supportsignal.com.au`
2. **Company Administrator** (TBD - Epic 9) - Company-scoped test user
3. **Frontline Worker** (TBD) - Participant-scoped test user

### Test Execution Process

For EACH URL listed below, execute this workflow:

#### Step 1: System Administrator Testing
1. Sign in as system administrator (david@supportsignal.com.au)
2. Navigate to URL
3. Document:
   - ✅ Page loads successfully OR
   - ❌ Shows unauthorized access (unexpected)
4. If unauthorized, capture UI pattern used

#### Step 2: Company Administrator Testing
1. Sign out
2. Sign in as company administrator
3. Navigate to same URL
4. Document:
   - ✅ Page loads successfully (if expected) OR
   - ✅ Shows UnauthorizedAccessCard (if restricted) OR
   - ❌ Shows Alert or custom UI (needs migration) OR
   - ❌ Crashes or shows ConvexError (bug)
5. Capture UI pattern and messaging

#### Step 3: Frontline Worker Testing
1. Sign out
2. Sign in as frontline worker
3. Navigate to same URL
4. Document:
   - ✅ Page loads successfully (if expected) OR
   - ✅ Shows UnauthorizedAccessCard (if restricted) OR
   - ❌ Shows Alert or custom UI (needs migration) OR
   - ❌ Crashes or shows ConvexError (bug)
5. Capture UI pattern and messaging

### URL Test Matrix

| URL | Expected Roles | System Admin | Company Admin | Frontline Worker | UI Pattern | Notes |
|-----|----------------|--------------|---------------|------------------|------------|-------|
| **Admin - Company Management** |
| `/admin` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ? | Check pattern |
| `/admin/companies` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ✅ UnauthorizedAccessCard | |
| `/admin/companies/create` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ? | Check pattern |
| `/admin/companies/[id]/edit` | system_admin, demo_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ✅ UnauthorizedAccessCard | |
| `/admin/companies/[id]/sites` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ✅ UnauthorizedAccessCard | |
| `/admin/companies/[id]/users` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ✅ UnauthorizedAccessCard | |
| `/admin/companies/[id]/users/invite` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ❌ Alert | Needs migration |
| `/admin/companies/[id]/participants` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ✅ UnauthorizedAccessCard | |
| `/admin/companies/[id]/participants/create` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ? | Check pattern |
| `/admin/companies/[id]/participants/[id]/edit` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ? | Check pattern |
| **Admin - User Management** |
| `/admin/users` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ❌ Alert | Needs migration |
| `/users` | system_admin, company_admin | ✅ Access | ✅ Access (Epic 9) | ❌ Unauthorized | ❌ Alert | Needs migration |
| **Admin - Developer Tools** |
| `/admin/developer-tools/export` | system_admin | ✅ Access | ❌ Unauthorized | ❌ Unauthorized | ? | Check pattern |
| **Application Pages** |
| `/dashboard` | authenticated | ✅ Access | ✅ Access | ✅ Access | ? | Check pattern |
| `/participants` | authenticated | ✅ Access | ✅ Access | ✅ Access | ? | Check pattern |
| `/showcase` | authenticated | ✅ Access | ✅ Access | ✅ Access | ? | Check pattern |
| **Authentication Pages** |
| `/login` | public | ✅ Access | ✅ Access | ✅ Access | N/A | Public page |
| `/reset-password` | public | ✅ Access | ✅ Access | ✅ Access | N/A | Public page |

### Test Data Requirements

**Company IDs for Testing** (use existing test companies):
- Replace `[id]` with actual company ID from development database
- Use consistent test company across all `[id]` URLs

**Participant IDs for Testing**:
- Replace `[id]` with actual participant ID from test company

### Expected Test Results

**Before Migration** (Current State):
- 5 pages with UnauthorizedAccessCard ✅
- 3 pages with Alert component ❌
- 8+ pages with unknown patterns ❓

**After Migration** (Target State):
- ALL pages use UnauthorizedAccessCard consistently ✅
- Zero Alert-based unauthorized messages ✅
- Zero ConvexErrors for unauthorized access ✅
- Clear, consistent messaging for each role ✅

### Failure Scenarios to Watch For

1. **ConvexError after showing UI** - Permission check after query execution (Bug from Story 7.5)
2. **Inconsistent messaging** - Different wording for same permission failure
3. **Missing permission checks** - Page loads when it should be restricted
4. **Wrong UI pattern** - Alert or custom UI instead of UnauthorizedAccessCard
5. **Type errors or crashes** - JavaScript errors in console

---

## Implementation Notes

### Component Enhancement Example

```typescript
interface UnauthorizedAccessCardProps {
  message: string;

  // NEW: Optional role context
  requiredRoles?: Array<'system_admin' | 'demo_admin' | 'company_admin' | 'frontline_worker'>;

  // NEW: Optional icon and variant
  icon?: 'shield' | 'lock' | 'warning';
  variant?: 'warning' | 'error';

  // Existing props
  showHomeButton?: boolean;
  customActions?: React.ReactNode;
}
```

### Migration Priority

**High Priority** (Complete in this story):
- `/admin/users` - Alert → UnauthorizedAccessCard
- `/admin/companies/[id]/users/invite` - Alert → UnauthorizedAccessCard
- `/users` - Alert → UnauthorizedAccessCard

**Medium Priority** (Complete if time allows):
- `/admin/page.tsx` - Custom UI → UnauthorizedAccessCard
- Participant create/edit pages - Standardize pattern
- Dashboard unauthorized states - Document pattern

**Low Priority** (Defer to future):
- Component enhancements for authentication vs authorization
- Role-aware message generation
- Support for feature access restrictions

### Testing Strategy

1. **Manual SAT First** - Execute comprehensive role-based testing
2. **Document Findings** - Capture all issues in story notes
3. **Implement Fixes** - Migrate patterns systematically
4. **Re-test** - Verify all scenarios pass after migration
5. **CI Validation** - Ensure no regressions

---

## Reference Material

### Authorization Audit Report

Complete audit findings documented in **Story 7.5 - Authorization UI Audit (Detailed)** section:
- Detailed page-by-page analysis
- Current component usage breakdown
- Permission type categorization
- Component enhancement recommendations
- Migration priority guidance

### Related Stories

- **Story 7.5** - Company user management where authorization UI consistency issues were discovered
  - See Story 7.5 "Bugs Found During Story Acceptance Testing (SAT)" section
  - Initial authorization audit documented in Story 7.5 completion notes
- **Epic 9** - Company Admin Portal (will introduce company_admin role and new authorization scenarios)

### Coding Patterns

**Authorization Check Pattern** (Story 7.5 lesson):
```typescript
// 1. Check permission BEFORE query definitions
const hasPermission = user && user.role === 'system_admin';

// 2. Include permission in skip condition
const data = useQuery(
  api.query,
  sessionToken && hasPermission ? args : 'skip'
);

// 3. Early return with UnauthorizedAccessCard
if (!hasPermission) {
  return <UnauthorizedAccessCard message="..." />;
}

// 4. Render page content
return <PageContent />;
```

---

## Knowledge Capture Reference

**KDD Documentation**:
- Authorization UI patterns → `docs/patterns/` (if created during implementation)
- Testing methodology → `docs/testing/` (if comprehensive testing approach documented)
- Component examples → `docs/examples/` (if reusable examples extracted)

**Brief Summary**: This story addresses authorization UI consistency issues discovered during Story 7.5 SAT, implementing standardized UnauthorizedAccessCard pattern across all restricted pages.

---

## Story Completion Checklist

- [ ] Phase 1: Complete audit with all URLs tested across 3 roles
- [ ] Phase 2: UnauthorizedAccessCard enhanced with flexible props
- [ ] Phase 3: All inconsistent patterns migrated to standard component
- [ ] Phase 4: Documentation and SAT completed
- [ ] All acceptance criteria met
- [ ] Story Acceptance Test executed and passed
- [ ] CI verification passed (`bun run ci:status`)
- [ ] KDD knowledge capture completed (if applicable)
- [ ] Story marked complete with completion date

---

**Story Created**: October 13, 2025
**Story Completed**: _Pending_
**Completion Date**: _TBD_
