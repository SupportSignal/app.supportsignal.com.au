# Story 0.7: Error Handling Consistency - Authorization & Missing Entity Patterns

**Epic**: 0 (Technical Debt & Continuous Improvement)
**Status**: üìã **Planned**
**Priority**: P1 (High)
**Estimated Effort**: Large (8-12 hours)
**Category**: User Experience / Technical Debt / Backend Architecture
**Discovered**: October 13, 2025 - Story 7.5 SAT revealed inconsistent error handling causing crashes

---

## Problem Statement

The application has two critical error handling inconsistencies discovered during Story 7.5:

### Issue 1: Inconsistent Authorization UI
Three distinct UI patterns for authorization failures:
1. **UnauthorizedAccessCard component** - Consistent, well-designed pattern (5 pages ‚úÖ)
2. **Alert component** - Inconsistent, minimal messaging (3 pages ‚ùå)
3. **Custom UI** - Unknown patterns (11+ pages need audit ‚ùì)

### Issue 2: Backend Error vs Null Handling
Backend query functions inconsistently handle error conditions by **throwing errors** instead of **returning structured responses**, causing:
- **Runtime crashes** before frontend can show graceful UI
- **Ambiguous null returns** - can't distinguish "no permission" from "entity deleted"
- **Poor user experience** - ConvexError stack traces instead of friendly messages

**Root Cause Pattern** (Story 7.5):
1. Backend throws `ConvexError('Company not found')` or `ConvexError('Insufficient permissions')`
2. Frontend tries to check `if (entity === null)` but never gets there
3. Application crashes with unhandled ConvexError before UI can render

This creates:
- **Poor user experience** - Crashes and stack traces instead of friendly error UI
- **Maintenance burden** - Multiple error patterns across backend and frontend
- **Developer confusion** - When to throw vs when to return null/structured errors
- **Testing complexity** - Inconsistent behavior across similar scenarios

---

## Scope

### Phase 1: Backend Error Pattern Audit

Audit all Convex query/mutation functions for error handling patterns:

**1. Entity Query Patterns**
- Search: `ctx.db.get(` across all Convex functions
- Analyze: Error handling after entity fetch (throw vs return null)
- Document: Which entities throw on not found vs return null

**2. Permission Check Patterns**
- Search: `throw new ConvexError` with permission-related messages
- Analyze: When permission checks happen (before/after data fetch)
- Document: Permission error types and consistency

**3. Relationship Query Patterns**
- Search: Queries loading related data (users for company, participants for site)
- Analyze: Assumptions about parent entity existence
- Document: What happens if parent deleted while query runs

**4. Cross-Tenant Access Patterns**
- Search: `company_id` validation logic
- Analyze: company_admin accessing wrong company data
- Document: Error consistency across tenant boundaries

**5. Session/Authentication Patterns**
- Search: Session validation and authentication checks
- Analyze: Invalid/expired session handling
- Document: Authentication error messages and consistency

**Deliverable**: Comprehensive audit report categorizing all error patterns found

### Phase 2: Structured Error Response Design

Design and implement discriminated union error responses:

```typescript
type QueryError = {
  code: 'FORBIDDEN' | 'UNAUTHORIZED' | 'NOT_FOUND' | 'INVALID_SESSION' | 'DELETED';
  message: string;           // Human-readable for UI display
  requiredRole?: string;     // Optional: what role needed
  resource?: string;         // Optional: what resource (for logging)
}

type QueryResult<T> =
  | { success: true; data: T }
  | { success: false; error: QueryError }
```

**Key Decisions**:
- When to throw vs return error result
- Error code taxonomy (add more codes as needed)
- Context to include in error responses
- Backward compatibility strategy

### Phase 3: Frontend UI Audit & Migration

**3a. Authorization UI Audit**
- Systematically test all admin and restricted pages with 3 user roles
- Document UI patterns (UnauthorizedAccessCard, Alert, custom)
- Identify crashes vs graceful error handling

**3b. Component Enhancement**
- Enhance `UnauthorizedAccessCard` to handle structured errors
- Support different error codes (not just permission failures)
- Maintain backward compatibility

**3c. Pattern Migration**
- Migrate 3 Alert pages to UnauthorizedAccessCard
- Update all pages to handle structured error responses
- Fix custom UI patterns discovered in audit

### Phase 4: Backend Migration

**4a. High Priority Migrations**
- Entity detail queries (companies, users, participants, sites)
- Permission check functions (all admin operations)
- Cross-tenant access validations

**4b. Medium Priority Migrations**
- Relationship queries
- List/search queries with filters

**4c. Validation**
- All queries return structured errors
- No ConvexError crashes for expected error conditions
- Consistent error messages across similar scenarios

### Phase 5: Comprehensive Testing

- Execute comprehensive Story Acceptance Test (see SAT section below)
- Multi-tab testing for race conditions
- Role-based permission testing
- Deleted entity testing
- Cross-tenant access testing

**Out of Scope**:
- Authorization logic changes (business rules remain unchanged)
- Role hierarchy refactoring
- Permission system redesign
- Performance optimization

---

## Current Audit Summary

### ‚úÖ Consistent - Using UnauthorizedAccessCard (5 pages)

1. **`/admin/companies`** - system_admin only
2. **`/admin/companies/[id]/edit`** - system_admin OR demo_admin
3. **`/admin/companies/[id]/sites`** - system_admin only
4. **`/admin/companies/[id]/users`** - system_admin only
5. **`/admin/companies/[id]/participants`** - system_admin only

### ‚ùå Inconsistent - Using Alert Component (3 pages)

6. **`/admin/users`** - "You do not have permission to access global user management"
7. **`/admin/companies/[id]/users/invite`** - "You do not have permission to invite users"
8. **`/users`** - "You do not have permission to access user management"

### ‚ùì Unknown - Need Comprehensive Audit (11+ pages)

9. **`/admin/page.tsx`** - Has custom unauthorized UI
10. **`/admin/companies/create`** - Unknown authorization pattern
11. **`/admin/developer-tools/export`** - Unknown authorization pattern
12. **`/admin/companies/[id]/participants/create`** - Has role checks
13. **`/admin/companies/[id]/participants/[id]/edit`** - Has role checks
14. **`/dashboard`** - Has permission checks
15. **`/participants`** - Has permission checks
16. **`/showcase`** - Has permission checks
17. Plus additional URLs to be discovered during systematic audit

---

## Acceptance Criteria

### Phase 1: Complete Audit
- [ ] **Comprehensive URL list** - All restricted pages documented with expected permissions
- [ ] **Role-based testing matrix** - Test results for system_admin, company_admin, frontline_worker
- [ ] **Pattern categorization** - Each page categorized by UI pattern used
- [ ] **Bug identification** - Security issues and permission bugs documented
- [ ] **Audit report** - Complete findings in story completion notes

### Phase 2: Component Enhancement
- [ ] **Enhanced UnauthorizedAccessCard** - Supports multiple authorization scenarios
- [ ] **Backward compatibility** - Existing 5 pages work without changes
- [ ] **Flexible messaging** - Not hardcoded to "System administrator" wording
- [ ] **Icon/variant options** - Different visual treatments for different scenarios
- [ ] **Documentation** - Component props and usage examples documented

### Phase 3: Pattern Migration
- [ ] **Alert pages migrated** - 3 Alert pages use UnauthorizedAccessCard
- [ ] **Custom UI standardized** - Unknown patterns replaced with standard component
- [ ] **Permission bugs fixed** - Any issues found in audit resolved
- [ ] **Visual consistency** - All unauthorized pages have consistent look/feel

### Phase 4: Documentation & Testing
- [ ] **Coding standards updated** - Authorization UI pattern documented
- [ ] **Developer guidelines** - Clear instructions for implementing auth checks
- [ ] **Story Acceptance Test** - Comprehensive test covering all URLs and roles
- [ ] **Test execution** - SAT passed with all scenarios validated

### Validation
- [ ] **TypeScript**: `bun run typecheck` passes with zero errors
- [ ] **Linting**: `bun run lint` passes with zero warnings
- [ ] **Tests**: `bun test` passes (all unit tests green)
- [ ] **Build**: `bun run build` completes successfully
- [ ] **CI**: `bun run ci:status` shows SUCCESS
- [ ] **Manual Testing**: Story Acceptance Test executed with all roles

---

## Permission Types Reference

For comprehensive audit testing, document behavior for:

1. **system_admin** - Full system access (all admin pages)
2. **demo_admin** - Limited admin for demos (some admin pages)
3. **company_admin** - Company-scoped management (Epic 9)
4. **frontline_worker** - Participant-scoped access (view own data)
5. **authenticated_user** - Basic authenticated features
6. **unauthenticated** - Public pages only

---

## Story Acceptance Test (SAT)

### Test Environment Setup

**Prerequisites** - Create BEFORE starting SAT:

**Test Users**:
1. **System Administrator**: `david@supportsignal.com.au` (existing)
2. **Company Administrator**: `companyadmin@testcompany.com` (create new)
   - Role: `company_admin`
   - Company: Test Company A
3. **Frontline Worker**: `worker@testcompany.com` (create new)
   - Role: `frontline_worker`
   - Company: Test Company A

**Test Data**:
1. **Test Company A** (active status)
   - Name: "Test Company Alpha"
   - Must have: 2+ sites, 3+ users, 2+ participants
   - Used for: Normal operations testing

2. **Test Company B** (active status)
   - Name: "Test Company Beta"
   - Must have: 1+ site, 1+ user, 1+ participant
   - Used for: Cross-tenant access testing (Company Admin A trying to access Company B)

3. **Test Company C** (test status)
   - Name: "Test Company Charlie - DELETE ME"
   - Must have: 1+ site, 1+ user, 1+ participant
   - Used for: Deletion testing (will be deleted during SAT)

**Browser Setup**:
- Use Chrome with multiple profiles OR incognito windows for parallel testing
- Keep Developer Console open to catch JavaScript errors

---

### Test Scenarios

Execute ALL scenarios below in order. Document results in a test matrix (see template below).

---

#### Scenario 1: Permission Denied - Role-Based Access Control

**Purpose**: Verify each role sees appropriate authorization errors

**Setup**:
1. Identify 5 admin URLs requiring system_admin role
2. Open all URLs in separate tabs (don't navigate yet)

**Test Steps**:

**1a. Frontline Worker Access (Should Fail)**
1. Sign in as `worker@testcompany.com`
2. Navigate to each admin URL
3. **Expected**: Structured error response showing UnauthorizedAccessCard
4. **Document**: Error message, UI pattern, any crashes

**1b. Company Administrator Access (Should Fail for System Admin Pages)**
1. Sign out, sign in as `companyadmin@testcompany.com`
2. Navigate to same admin URLs
3. **Expected**: Structured error response showing UnauthorizedAccessCard
4. **Document**: Error message, UI pattern, any crashes

**1c. System Administrator Access (Should Succeed)**
1. Sign out, sign in as `david@supportsignal.com.au`
2. Navigate to same admin URLs
3. **Expected**: Pages load successfully
4. **Document**: Any unexpected authorization errors

**Validation**:
- ‚úÖ No ConvexError runtime crashes
- ‚úÖ Consistent UnauthorizedAccessCard UI across all restricted pages
- ‚úÖ Clear error messages indicating required role
- ‚ùå Alert components or custom UI (needs migration)
- ‚ùå JavaScript console errors

---

#### Scenario 2: Cross-Tenant Access Violation

**Purpose**: Verify company_admin cannot access other companies' data

**Setup**:
1. Note Test Company A ID: `___________________`
2. Note Test Company B ID: `___________________`
3. Sign in as `companyadmin@testcompany.com` (Company A admin)

**Test Steps**:

**2a. Own Company Access (Should Succeed - When Epic 9 Implemented)**
1. Navigate to `/admin/companies/[COMPANY_A_ID]/edit`
2. **Expected**: Access allowed (after Epic 9) OR structured error
3. **Document**: Current behavior

**2b. Other Company Access (Should Fail)**
1. Navigate to `/admin/companies/[COMPANY_B_ID]/edit`
2. Navigate to `/admin/companies/[COMPANY_B_ID]/users`
3. Navigate to `/admin/companies/[COMPANY_B_ID]/participants`
4. **Expected**: Structured error with `FORBIDDEN` code
5. **Document**: Error message clarity, UI consistency

**Validation**:
- ‚úÖ Cross-tenant access blocked
- ‚úÖ Error clearly states "You can only view your own company"
- ‚úÖ No data leakage in error messages (don't expose Company B details)
- ‚ùå ConvexError crashes
- ‚ùå Successful access to other company (security bug!)

---

#### Scenario 3: Deleted Entity Handling (Multi-Tab Race Condition)

**Purpose**: Verify graceful handling when entity deleted while page open

**Setup**:
1. Sign in as System Administrator
2. Note Test Company C ID: `___________________`
3. Open 5 tabs with Company C URLs (don't load yet):
   - Tab 1: `/admin/companies/[COMPANY_C_ID]/edit`
   - Tab 2: `/admin/companies/[COMPANY_C_ID]/users`
   - Tab 3: `/admin/companies/[COMPANY_C_ID]/sites`
   - Tab 4: `/admin/companies/[COMPANY_C_ID]/participants`
   - Tab 5: `/admin/companies` (listing page)

**Test Steps**:

**3a. Load All Pages**
1. Navigate all tabs (load Company C pages)
2. **Expected**: All pages load successfully
3. **Document**: Verify data displays correctly

**3b. Delete Company**
1. From Tab 5 (listing page), delete Test Company C
2. **Expected**: Deletion succeeds with cascade

**3c. Refresh Deleted Entity Pages**
1. Refresh Tab 1 (edit page)
2. **Expected**: Structured error with `NOT_FOUND` code, friendly "Company Not Found" UI
3. **Document**: Error message, UI pattern, any crashes

4. Refresh Tab 2 (users page)
5. **Expected**: Same structured error and UI
6. **Document**: Consistency with Tab 1

7. Refresh Tabs 3-4 (sites, participants)
8. **Expected**: Same structured error and UI
9. **Document**: Consistency across all pages

**3d. Navigate to Deleted Company Directly**
1. Manually navigate to `/admin/companies/[DELETED_COMPANY_C_ID]/edit`
2. **Expected**: Immediate "Company Not Found" UI (no loading state, no crash)
3. **Document**: Load time, error handling

**Validation**:
- ‚úÖ No ConvexError crashes on any page
- ‚úÖ Consistent "Not Found" UI across all entity detail pages
- ‚úÖ Friendly error message with "Return to Listing" button
- ‚úÖ No dependent queries execute after entity not found
- ‚ùå Crashes or stack traces
- ‚ùå Infinite loading states

---

#### Scenario 4: Deleted Child Entity (Participant)

**Purpose**: Verify child entity deletion handled gracefully

**Setup**:
1. Sign in as System Administrator
2. Pick a participant from Test Company A
3. Note Participant ID: `___________________`

**Test Steps**:

**4a. Open Participant Pages**
1. Navigate to `/admin/companies/[COMPANY_A_ID]/participants/[PARTICIPANT_ID]/edit`
2. **Expected**: Page loads successfully
3. Keep tab open

**4b. Delete Participant**
1. Open new tab: `/admin/companies/[COMPANY_A_ID]/participants`
2. Delete the participant from listing
3. **Expected**: Deletion succeeds

**4c. Refresh Deleted Participant Page**
1. Return to edit tab, refresh
2. **Expected**: Structured error with `NOT_FOUND`, friendly "Participant Not Found" UI
3. **Document**: Error handling consistency

**Validation**:
- ‚úÖ Same error pattern as deleted company (Scenario 3)
- ‚úÖ Consistent UI across entity types
- ‚ùå Different error handling for child vs parent entities

---

#### Scenario 5: Invalid Session / Authentication

**Purpose**: Verify authentication failures handled gracefully

**Setup**:
1. Sign in as any user
2. Open admin page successfully
3. Keep tab open

**Test Steps**:

**5a. Session Expiration Simulation**
1. Open browser DevTools ‚Üí Application ‚Üí Cookies
2. Delete session cookie OR manually expire it
3. Refresh the page
4. **Expected**: Structured error with `INVALID_SESSION` code, redirects to login
5. **Document**: Error handling, redirect behavior

**5b. Manual Invalid Session**
1. Modify session token in cookie to invalid value
2. Refresh page
3. **Expected**: Same structured error handling
4. **Document**: Consistency with 5a

**Validation**:
- ‚úÖ Structured error response (not crash)
- ‚úÖ Redirect to login page
- ‚úÖ Error message explains session expired
- ‚ùå ConvexError crash
- ‚ùå Stuck in loading state

---

### Test Execution Process (Quick Reference)

For EACH scenario above:

1. **Setup**: Prepare test data and browser state
2. **Execute**: Follow test steps exactly as written
3. **Document**: Record results in test matrix (below)
4. **Validate**: Check all validation criteria
5. **Report**: Document any bugs/crashes/inconsistencies

### URL Test Matrix

| URL | Expected Roles | System Admin | Company Admin | Frontline Worker | UI Pattern | Notes |
|-----|----------------|--------------|---------------|------------------|------------|-------|
| **Admin - Company Management** |
| `/admin` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ? | Check pattern |
| `/admin/companies` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ‚úÖ UnauthorizedAccessCard | |
| `/admin/companies/create` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ? | Check pattern |
| `/admin/companies/[id]/edit` | system_admin, demo_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ‚úÖ UnauthorizedAccessCard | |
| `/admin/companies/[id]/sites` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ‚úÖ UnauthorizedAccessCard | |
| `/admin/companies/[id]/users` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ‚úÖ UnauthorizedAccessCard | |
| `/admin/companies/[id]/users/invite` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ‚ùå Alert | Needs migration |
| `/admin/companies/[id]/participants` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ‚úÖ UnauthorizedAccessCard | |
| `/admin/companies/[id]/participants/create` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ? | Check pattern |
| `/admin/companies/[id]/participants/[id]/edit` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ? | Check pattern |
| **Admin - User Management** |
| `/admin/users` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ‚ùå Alert | Needs migration |
| `/users` | system_admin, company_admin | ‚úÖ Access | ‚úÖ Access (Epic 9) | ‚ùå Unauthorized | ‚ùå Alert | Needs migration |
| **Admin - Developer Tools** |
| `/admin/developer-tools/export` | system_admin | ‚úÖ Access | ‚ùå Unauthorized | ‚ùå Unauthorized | ? | Check pattern |
| **Application Pages** |
| `/dashboard` | authenticated | ‚úÖ Access | ‚úÖ Access | ‚úÖ Access | ? | Check pattern |
| `/participants` | authenticated | ‚úÖ Access | ‚úÖ Access | ‚úÖ Access | ? | Check pattern |
| `/showcase` | authenticated | ‚úÖ Access | ‚úÖ Access | ‚úÖ Access | ? | Check pattern |
| **Authentication Pages** |
| `/login` | public | ‚úÖ Access | ‚úÖ Access | ‚úÖ Access | N/A | Public page |
| `/reset-password` | public | ‚úÖ Access | ‚úÖ Access | ‚úÖ Access | N/A | Public page |

### Test Data Requirements

**Company IDs for Testing** (use existing test companies):
- Replace `[id]` with actual company ID from development database
- Use consistent test company across all `[id]` URLs

**Participant IDs for Testing**:
- Replace `[id]` with actual participant ID from test company

### Expected Test Results

**Before Migration** (Current State):
- 5 pages with UnauthorizedAccessCard ‚úÖ
- 3 pages with Alert component ‚ùå
- 8+ pages with unknown patterns ‚ùì

**After Migration** (Target State):
- ALL pages use UnauthorizedAccessCard consistently ‚úÖ
- Zero Alert-based unauthorized messages ‚úÖ
- Zero ConvexErrors for unauthorized access ‚úÖ
- Clear, consistent messaging for each role ‚úÖ

### Failure Scenarios to Watch For

1. **ConvexError after showing UI** - Permission check after query execution (Bug from Story 7.5)
2. **Inconsistent messaging** - Different wording for same permission failure
3. **Missing permission checks** - Page loads when it should be restricted
4. **Wrong UI pattern** - Alert or custom UI instead of UnauthorizedAccessCard
5. **Type errors or crashes** - JavaScript errors in console

---

## Implementation Notes

### Component Enhancement Example

```typescript
interface UnauthorizedAccessCardProps {
  message: string;

  // NEW: Optional role context
  requiredRoles?: Array<'system_admin' | 'demo_admin' | 'company_admin' | 'frontline_worker'>;

  // NEW: Optional icon and variant
  icon?: 'shield' | 'lock' | 'warning';
  variant?: 'warning' | 'error';

  // Existing props
  showHomeButton?: boolean;
  customActions?: React.ReactNode;
}
```

### Migration Priority

**High Priority** (Complete in this story):
- `/admin/users` - Alert ‚Üí UnauthorizedAccessCard
- `/admin/companies/[id]/users/invite` - Alert ‚Üí UnauthorizedAccessCard
- `/users` - Alert ‚Üí UnauthorizedAccessCard

**Medium Priority** (Complete if time allows):
- `/admin/page.tsx` - Custom UI ‚Üí UnauthorizedAccessCard
- Participant create/edit pages - Standardize pattern
- Dashboard unauthorized states - Document pattern

**Low Priority** (Defer to future):
- Component enhancements for authentication vs authorization
- Role-aware message generation
- Support for feature access restrictions

### Testing Strategy

1. **Manual SAT First** - Execute comprehensive role-based testing
2. **Document Findings** - Capture all issues in story notes
3. **Implement Fixes** - Migrate patterns systematically
4. **Re-test** - Verify all scenarios pass after migration
5. **CI Validation** - Ensure no regressions

---

## Reference Material

### Authorization Audit Report

Complete audit findings documented in **Story 7.5 - Authorization UI Audit (Detailed)** section:
- Detailed page-by-page analysis
- Current component usage breakdown
- Permission type categorization
- Component enhancement recommendations
- Migration priority guidance

### Related Stories

- **Story 7.5** - Company user management where authorization UI consistency issues were discovered
  - See Story 7.5 "Bugs Found During Story Acceptance Testing (SAT)" section
  - Initial authorization audit documented in Story 7.5 completion notes
- **Epic 9** - Company Admin Portal (will introduce company_admin role and new authorization scenarios)

### Coding Patterns

**Authorization Check Pattern** (Story 7.5 lesson):
```typescript
// 1. Check permission BEFORE query definitions
const hasPermission = user && user.role === 'system_admin';

// 2. Include permission in skip condition
const data = useQuery(
  api.query,
  sessionToken && hasPermission ? args : 'skip'
);

// 3. Early return with UnauthorizedAccessCard
if (!hasPermission) {
  return <UnauthorizedAccessCard message="..." />;
}

// 4. Render page content
return <PageContent />;
```

---

## Knowledge Capture Reference

**KDD Documentation**:
- Authorization UI patterns ‚Üí `docs/patterns/` (if created during implementation)
- Testing methodology ‚Üí `docs/testing/` (if comprehensive testing approach documented)
- Component examples ‚Üí `docs/examples/` (if reusable examples extracted)

**Brief Summary**: This story addresses authorization UI consistency issues discovered during Story 7.5 SAT, implementing standardized UnauthorizedAccessCard pattern across all restricted pages.

---

## Story Completion Checklist

- [ ] Phase 1: Complete audit with all URLs tested across 3 roles
- [ ] Phase 2: UnauthorizedAccessCard enhanced with flexible props
- [ ] Phase 3: All inconsistent patterns migrated to standard component
- [ ] Phase 4: Documentation and SAT completed
- [ ] All acceptance criteria met
- [ ] Story Acceptance Test executed and passed
- [ ] CI verification passed (`bun run ci:status`)
- [ ] KDD knowledge capture completed (if applicable)
- [ ] Story marked complete with completion date

---

**Story Created**: October 13, 2025
**Story Completed**: _Pending_
**Completion Date**: _TBD_
