# Story 0.6: Database Export & Analysis System

## Status
Draft

## Story
**As a** system administrator and developer,
**I want** to export database snapshots in JSON format with flexible filtering options,
**so that** I can analyze data patterns using Claude Code and other external AI tools for prompt engineering, debugging, and pattern discovery.

## Acceptance Criteria

1. **Admin Interface**: Developer tools page at `/admin/developer-tools/export`
2. **Full Export**: Download complete database snapshot as JSON
3. **Segmented Exports**: Filter by company, site, worker, participant, or provider
4. **Export Options**: Select specific tables or include all
5. **Data Privacy**: System admin only access (role-based)
6. **File Format**: Well-structured JSON with metadata
7. **Download Handling**: Browser download or copy to clipboard
8. **Performance**: Handle large exports (500+ incidents, 100+ participants)
9. **Documentation**: Usage guide for Claude Code analysis workflows
10. **Security**: No sensitive data exposure in logs/errors

## Estimation & Planning

### Story Points
**5** (Medium Complexity)

### Estimated Complexity
**Medium**

Complexity drivers:
- Convex data export patterns (known technology)
- JSON serialization of database structures
- Admin UI with filtering options
- Role-based security validation
- Performance considerations for large datasets

### Estimated Time
**4-6 hours**

Breakdown:
- Convex export function development: 2-3 hours
- Admin UI with filters: 1-2 hours
- Testing and validation: 1 hour
- Documentation: 30 minutes

### Risk Level
**Low**

Risk factors:
- **Performance**: Large datasets may require streaming (mitigated by starting simple)
- **Data Privacy**: Ensure no sensitive data leaks (mitigated by system admin only access)
- **JSON Size**: Very large exports might hit browser limits (mitigated by table selection)

## Tasks / Subtasks

- [ ] **Backend: Create Convex Export Function** (AC: 2, 3, 4, 8, 10)
  - [ ] Create `apps/convex/exports.ts` with `generateDatabaseExport` query
  - [ ] Implement full database export (all tables)
  - [ ] Implement segmented export filters (company/site/worker/participant/provider)
  - [ ] Add table selection parameter (specific tables or all)
  - [ ] Handle JSON serialization of Convex data structures
  - [ ] Add metadata to export (timestamp, filters applied, record counts)
  - [ ] Implement system admin role validation
  - [ ] Add error handling with no sensitive data exposure

- [ ] **Frontend: Admin Export Interface** (AC: 1, 6, 7)
  - [ ] Create `/admin/developer-tools/export` page
  - [ ] Add export type selector (Full vs Segmented)
  - [ ] Add filter options (company, site, worker, participant, provider dropdowns)
  - [ ] Add table selection checkboxes
  - [ ] Implement "Download as JSON" button
  - [ ] Implement "Copy to Clipboard" button
  - [ ] Add export progress indicator
  - [ ] Display export metadata (record counts, file size estimate)

- [ ] **Security & Permissions** (AC: 5, 10)
  - [ ] Verify system admin role requirement
  - [ ] Test unauthorized access returns 403
  - [ ] Validate no sensitive data in error messages
  - [ ] Add audit logging for export actions

- [ ] **Testing** (AC: 8, 9)
  - [ ] Test full database export with sample data
  - [ ] Test segmented exports with various filters
  - [ ] Test large dataset handling (500+ incidents)
  - [ ] Test table selection combinations
  - [ ] Verify JSON structure and format
  - [ ] Test download and clipboard functionality

- [ ] **Documentation** (AC: 9)
  - [ ] Create usage guide for Claude Code analysis workflows
  - [ ] Document filter options and use cases
  - [ ] Add example Claude Code analysis prompts
  - [ ] Document performance considerations

## Documentation Impact Assessment

**Architectural Patterns**:
- Admin tool development pattern (may establish reusable pattern)
- Convex bulk data export pattern
- System admin feature access pattern

**Documentation Updates Needed**:
- `docs/patterns/admin-tools-pattern.md` - If pattern is reusable
- `docs/examples/admin-export-workflow.md` - Usage examples
- `docs/architecture/admin-features.md` - Admin feature registry

**Knowledge to Capture**:
- JSON serialization strategies for Convex data
- Performance patterns for large exports
- Filter combination approaches
- Claude Code integration examples

## Dev Notes

### Architecture Context

**Tech Stack References**:
- **Backend**: Convex (1.12.x) for real-time backend and database [Source: architecture/tech-stack.md]
- **Frontend**: Next.js (14.2.x) with TypeScript (5.4.x) [Source: architecture/tech-stack.md]
- **UI**: ShadCN/UI components with Tailwind CSS [Source: architecture/tech-stack.md]
- **Validation**: Zod (3.23.x) for schema validation [Source: architecture/tech-stack.md]

**Admin Tool Location**:
- Place in `/admin/developer-tools/` directory structure
- Follow existing admin panel patterns from `/admin/` routes

**Convex Export Function Pattern**:
```typescript
// apps/convex/exports.ts
import { query } from "./_generated/server";
import { v } from "convex/values";

export const generateDatabaseExport = query({
  args: {
    exportType: v.union(v.literal("full"), v.literal("segmented")),
    filters: v.optional(v.object({
      companyId: v.optional(v.id("companies")),
      siteId: v.optional(v.id("sites")),
      // ... other filter options
    })),
    tables: v.optional(v.array(v.string())),
  },
  handler: async (ctx, args) => {
    // 1. Validate system admin role
    // 2. Query tables based on exportType and filters
    // 3. Serialize to JSON with metadata
    // 4. Return structured export object
  },
});
```

**JSON Export Structure**:
```json
{
  "metadata": {
    "exportedAt": "ISO timestamp",
    "exportType": "full|segmented",
    "filtersApplied": {},
    "recordCounts": {
      "incidents": 123,
      "participants": 45,
      // ...
    }
  },
  "data": {
    "incidents": [...],
    "participants": [...],
    // ... other tables
  }
}
```

### Pattern Validation

**Existing Patterns to Follow**:
- **Admin Route Pattern**: Follow `/admin/*` route structure for developer tools
- **Role-Based Access**: Use existing system admin role validation pattern
- **Convex Query Pattern**: Follow standard Convex query definition pattern
- **Error Handling**: Use consistent error handling without exposing sensitive data

**New Patterns to Establish**:
- **Bulk Export Pattern**: May establish reusable pattern for other admin tools
- **Filter Combination Pattern**: Flexible filtering approach for admin queries

### Testing

**Test File Location**: `tests/web/src/admin/developer-tools/export.test.tsx`

**Testing Standards** [Source: architecture/test-strategy-and-standards.md]:
- Unit tests for Convex export function logic
- Integration tests for admin UI and export workflow
- Security tests for unauthorized access
- Performance tests for large dataset handling

**Testing Frameworks**:
- **Jest + React Testing Library**: Component and integration tests
- **Bun Test Runner**: Fast execution
- **Convex Test Helpers**: Backend function testing

**Specific Test Requirements**:
1. Role validation tests (system admin only)
2. Filter combination tests
3. Large dataset performance tests (500+ records)
4. JSON structure validation
5. Download and clipboard functionality tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-09 | 1.0 | Initial story creation | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results

### Pattern Compliance Review
_To be populated by QA Agent_

### Knowledge Capture Reference
_To be populated by QA Agent after story completion_

### Velocity Data
_To be populated by QA Agent after story completion_
