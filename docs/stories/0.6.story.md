# Story 0.6: Database Export & Analysis System

## Status
Read

## Use Worktree
Branch will be: story/0.6

**Worktree Value: true**

## Story
**As a** system administrator and developer,
**I want** to export database snapshots in JSON format with flexible filtering options,
**so that** I can analyze data patterns using Claude Code and other external AI tools for prompt engineering, debugging, and pattern discovery.

## Acceptance Criteria

1. **Schema Definition**: JSON export schema designed and validated with user
2. **Admin Interface**: Developer tools page at `/admin/developer-tools/export`
3. **Full Database Export**: Download complete database snapshot as JSON
4. **Data Privacy**: System admin only access (role-based)
5. **File Format**: Well-structured JSON with metadata and hierarchy
6. **Download Handling**: Browser download with proper filename
7. **Performance**: Handle large exports (500+ incidents, 100+ participants)
8. **Documentation**: Usage guide for Claude Code analysis workflows
9. **Security**: No sensitive data exposure in logs/errors
10. **Optional Enhancement**: User decision on whether to add segmented export filters

## Estimation & Planning

### Story Points
**3** (Small-Medium Complexity)

### Estimated Complexity
**Medium**

Complexity drivers:
- Schema design and user validation (new step)
- Convex data export patterns (known technology)
- JSON serialization with proper hierarchy
- Simple admin UI (just "Export All" button)
- Role-based security validation

### Estimated Time
**3-4 hours**

Breakdown:
- Schema design and validation: 45 minutes
- Convex export function development: 1.5-2 hours
- Simple admin UI: 30-45 minutes
- Testing and validation: 45 minutes
- Documentation: 15 minutes

### Risk Level
**Low**

Risk factors:
- **Schema Design**: Getting hierarchy wrong affects tool usability (mitigated by user validation)
- **Performance**: Large datasets may cause browser issues (mitigated by testing with real data)
- **Data Privacy**: Ensure no sensitive data leaks (mitigated by system admin only access)

## Tasks / Subtasks

- [ ] **Phase 1: Schema Design & Validation** (AC: 1, 5) **CRITICAL - MUST BE FIRST**
  - [ ] Analyze current Convex database tables and relationships
  - [ ] Design JSON export schema with proper hierarchy:
    - Root level: metadata (timestamp, version, record counts)
    - Data level: organized by entity type (companies, sites, participants, incidents, etc.)
    - Relationship preservation (IDs maintained for cross-referencing)
  - [ ] Create sample schema snippet (2-3 tables with 2-3 fields each as example)
  - [ ] Present schema to user for validation with visual hierarchy
  - [ ] Get explicit sign-off on schema structure before proceeding
  - [ ] Document approved schema in Dev Notes

- [ ] **Phase 2: Backend Export Function** (AC: 3, 7, 9)
  - [ ] Create `apps/convex/exports.ts` with `generateDatabaseExport` query
  - [ ] Implement full database export using approved schema
  - [ ] Query all tables (companies, sites, users, participants, incidents, narratives, etc.)
  - [ ] Handle JSON serialization of Convex data structures
  - [ ] Add metadata (timestamp, total records per table)
  - [ ] Implement system admin role validation
  - [ ] Add error handling with no sensitive data exposure
  - [ ] Test with development data (30+ users, 500+ incidents)

- [ ] **Phase 3: Simple Admin UI** (AC: 2, 6)
  - [ ] Create `/admin/developer-tools/export` page
  - [ ] Add single "Export Full Database" button
  - [ ] Display export metadata before download (record counts, estimated size)
  - [ ] Implement browser download with filename: `supportsignal-db-export-YYYY-MM-DD-HHmm.json`
  - [ ] Add loading indicator during export
  - [ ] Show success/error toast notifications

- [ ] **Phase 4: Security & Testing** (AC: 4, 7, 9)
  - [ ] Verify system admin role requirement
  - [ ] Test unauthorized access returns 403
  - [ ] Validate no sensitive data in error messages
  - [ ] Test large dataset handling (500+ incidents, 100+ participants)
  - [ ] Verify JSON structure matches approved schema
  - [ ] Test download functionality across browsers

- [ ] **Phase 5: Optional Enhancement Decision** (AC: 10)
  - [ ] Review completed full export implementation
  - [ ] Present segmentation options to user based on actual schema:
    - Filter by company (for multi-tenant analysis)
    - Filter by site (for location-specific analysis)
    - Filter by date range (for time-series analysis)
    - Filter by entity type (participants, incidents, users)
  - [ ] Get user decision: implement now, defer, or build CLI tools instead
  - [ ] If approved: implement chosen segmentation filters
  - [ ] If deferred: document as future enhancement in story notes

- [ ] **Phase 6: Documentation** (AC: 8)
  - [ ] Create usage guide for Claude Code analysis workflows
  - [ ] Document JSON schema structure and hierarchy
  - [ ] Add example Claude Code analysis prompts
  - [ ] Document any CLI tool recommendations for segmentation

## Documentation Impact Assessment

**Architectural Patterns**:
- Admin tool development pattern (may establish reusable pattern)
- Convex bulk data export pattern
- System admin feature access pattern

**Documentation Updates Needed**:
- `docs/patterns/admin-tools-pattern.md` - If pattern is reusable
- `docs/examples/admin-export-workflow.md` - Usage examples
- `docs/architecture/admin-features.md` - Admin feature registry

**Knowledge to Capture**:
- JSON serialization strategies for Convex data
- Performance patterns for large exports
- Filter combination approaches
- Claude Code integration examples

## Dev Notes

### Architecture Context

**Tech Stack References**:
- **Backend**: Convex (1.12.x) for real-time backend and database [Source: architecture/tech-stack.md]
- **Frontend**: Next.js (14.2.x) with TypeScript (5.4.x) [Source: architecture/tech-stack.md]
- **UI**: ShadCN/UI components with Tailwind CSS [Source: architecture/tech-stack.md]
- **Validation**: Zod (3.23.x) for schema validation [Source: architecture/tech-stack.md]

**Admin Tool Location**:
- Place in `/admin/developer-tools/` directory structure
- Follow existing admin panel patterns from `/admin/` routes

**Convex Export Function Pattern**:
```typescript
// apps/convex/exports.ts
import { query } from "./_generated/server";
import { v } from "convex/values";

export const generateDatabaseExport = query({
  args: {
    exportType: v.union(v.literal("full"), v.literal("segmented")),
    filters: v.optional(v.object({
      companyId: v.optional(v.id("companies")),
      siteId: v.optional(v.id("sites")),
      // ... other filter options
    })),
    tables: v.optional(v.array(v.string())),
  },
  handler: async (ctx, args) => {
    // 1. Validate system admin role
    // 2. Query tables based on exportType and filters
    // 3. Serialize to JSON with metadata
    // 4. Return structured export object
  },
});
```

**JSON Export Structure**:
```json
{
  "metadata": {
    "exportedAt": "ISO timestamp",
    "exportType": "full|segmented",
    "filtersApplied": {},
    "recordCounts": {
      "incidents": 123,
      "participants": 45,
      // ...
    }
  },
  "data": {
    "incidents": [...],
    "participants": [...],
    // ... other tables
  }
}
```

### Pattern Validation

**Existing Patterns to Follow**:
- **Admin Route Pattern**: Follow `/admin/*` route structure for developer tools
- **Role-Based Access**: Use existing system admin role validation pattern
- **Convex Query Pattern**: Follow standard Convex query definition pattern
- **Error Handling**: Use consistent error handling without exposing sensitive data

**New Patterns to Establish**:
- **Bulk Export Pattern**: May establish reusable pattern for other admin tools
- **Filter Combination Pattern**: Flexible filtering approach for admin queries

### Testing

**Test File Location**: `tests/web/src/admin/developer-tools/export.test.tsx`

**Testing Standards** [Source: architecture/test-strategy-and-standards.md]:
- Unit tests for Convex export function logic
- Integration tests for admin UI and export workflow
- Security tests for unauthorized access
- Performance tests for large dataset handling

**Testing Frameworks**:
- **Jest + React Testing Library**: Component and integration tests
- **Bun Test Runner**: Fast execution
- **Convex Test Helpers**: Backend function testing

**Specific Test Requirements**:
1. Role validation tests (system admin only)
2. Filter combination tests
3. Large dataset performance tests (500+ records)
4. JSON structure validation
5. Download and clipboard functionality tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-09 | 1.0 | Initial story creation | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results

### Pattern Compliance Review
_To be populated by QA Agent_

### Knowledge Capture Reference
_To be populated by QA Agent after story completion_

### Velocity Data
_To be populated by QA Agent after story completion_
