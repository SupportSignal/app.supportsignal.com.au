# Story 3.3: Narrative Enhancement & Completion

## Status
On Hold

## Story
**As a** frontline support worker,  
**I want** an AI-enhanced final review step that combines my original narratives with clarification responses into a comprehensive incident summary,  
**so that** I can review and refine a complete incident report before submitting it for analysis workflow handoff.

## Acceptance Criteria

1. **AI Enhancement**: Intelligent combination of original narratives and clarification responses into a cohesive incident summary
2. **Review Interface**: Clean, readable presentation of enhanced narrative content with clear structure and formatting
3. **Edit Functionality**: Users can modify enhanced content with change tracking and preservation of original content
4. **Validation Summary**: Clear checklist showing completion status of all workflow requirements
5. **Handoff Process**: Smooth transition that notifies team leaders of ready-for-analysis incidents
6. **Data Integrity**: All original content preserved alongside enhanced versions for audit purposes
7. **Export Preview**: Preview of final incident report format showing how the enhanced narrative will appear in analysis workflow

## Estimation & Planning

### Story Points
8

### Estimated Complexity  
High

### Estimated Time
1 week

### Risk Level
Medium

## Tasks / Subtasks

- [ ] **Task 3.3.1: AI Narrative Enhancement Backend** (AC: 1, 6)
  - [ ] Subtask 3.3.1.1: Implement AI service for narrative enhancement using Claude SDK
  - [ ] Subtask 3.3.1.2: Create enhanced narrative storage with version history and original preservation
  - [ ] Subtask 3.3.1.3: Add narrative enhancement request management with caching and retry logic
  - [ ] Subtask 3.3.1.4: Implement enhanced content validation and quality metrics tracking

- [ ] **Task 3.3.2: Enhanced Review Interface** (AC: 2, 3, 4)
  - [ ] Subtask 3.3.2.1: Create EnhancedReviewStep component for Step 7 of workflow
  - [ ] Subtask 3.3.2.2: Implement enhanced narrative display with edit capabilities and change tracking
  - [ ] Subtask 3.3.2.3: Add workflow completion checklist with validation summary
  - [ ] Subtask 3.3.2.4: Create responsive design for enhanced content review on all devices

- [ ] **Task 3.3.3: Workflow Completion and Handoff** (AC: 5, 7)
  - [ ] Subtask 3.3.3.1: Implement incident submission with enhanced narrative and status transition
  - [ ] Subtask 3.3.3.2: Add team leader notification system for ready-for-analysis incidents
  - [ ] Subtask 3.3.3.3: Create export preview functionality showing final incident report format
  - [ ] Subtask 3.3.3.4: Add incident handoff audit trail and completion timestamp tracking

- [ ] **Task 3.3.4: Integration Testing and Workflow Validation** (AC: 1-7)
  - [ ] Subtask 3.3.4.1: Integrate enhancement step into existing IncidentCaptureWorkflow
  - [ ] Subtask 3.3.4.2: Add comprehensive unit tests for AI enhancement and review functionality
  - [ ] Subtask 3.3.4.3: Implement integration tests for complete Steps 1-7 workflow
  - [ ] Subtask 3.3.4.4: Add end-to-end testing including handoff process and export preview

## Documentation Impact Assessment

This story completes the Epic 3 incident capture workflow and establishes critical patterns for AI-enhanced content creation and review:

**Architectural Patterns to Establish:**
- AI narrative enhancement and content combination patterns
- Version control and audit trail systems for AI-modified content
- Workflow completion and handoff patterns between Epic workflows
- Export and preview patterns for enhanced content presentation

**Documentation Updates Needed:**
- AI enhancement patterns in architecture documentation
- Workflow completion and handoff strategies
- Export and preview system documentation
- Version control patterns for AI-enhanced content

**Knowledge Capture:**
- AI prompt engineering for narrative enhancement and summarization
- User experience patterns for reviewing and editing AI-enhanced content
- Workflow completion validation and handoff automation patterns

## Dev Notes

### Previous Story Insights
From Story 3.1 and 3.2 completion:
- **Authentication Pattern**: Use `auth_session_token` for session management
- **Auto-save Pattern**: Implement 30-second auto-save with visual feedback established in NarrativeGrid
- **Workflow Integration**: `IncidentCaptureWorkflow.tsx` orchestrates multi-step process (Steps 1-6 implemented)
- **AI Integration**: Proven AI question generation patterns from Story 3.2 clarification system
- **Error Handling**: Implement graceful degradation with user-friendly error messages
- **Responsive Design**: 2x2 grid â†’ single column pattern for mobile compatibility

### Data Models [Source: apps/convex/schema.ts]

**Enhanced Narratives Storage:**
```typescript
enhanced_narratives: defineTable({
  incident_id: v.id("incidents"),
  original_content: v.string(), // Combined original narratives
  clarification_responses: v.string(), // Combined clarification answers
  enhanced_content: v.string(), // AI-enhanced combined narrative
  enhancement_version: v.number(), // Version tracking for edits
  ai_model: v.optional(v.string()), // "claude/claude-3-sonnet"
  enhancement_prompt: v.optional(v.string()),
  processing_time_ms: v.number(),
  quality_score: v.optional(v.number()), // AI-assessed quality metrics
  user_edited: v.boolean(), // Track if user modified AI content
  user_edits: v.optional(v.string()), // Store user modifications
  created_at: v.number(),
  updated_at: v.number(),
})
  .index("by_incident", ["incident_id"])
  .index("by_version", ["incident_id", "enhancement_version"])
```

**Incident Workflow Completion:**
```typescript
// Extension to existing incidents table
incidents: defineTable({
  // ... existing fields from Story 3.1 ...
  
  // Enhancement completion fields
  enhanced_narrative_id: v.optional(v.id("enhanced_narratives")),
  workflow_completed_at: v.optional(v.number()),
  submitted_by: v.optional(v.id("users")),
  submitted_at: v.optional(v.number()),
  handoff_status: v.union(
    v.literal("draft"),
    v.literal("ready_for_analysis"),
    v.literal("in_analysis"),
    v.literal("analysis_complete")
  ),
  completion_checklist: v.optional(v.object({
    metadata_complete: v.boolean(),
    narratives_complete: v.boolean(),
    clarifications_complete: v.boolean(),
    enhancement_complete: v.boolean(),
    validation_passed: v.boolean(),
  })),
})
```

**Workflow Handoff Notifications:**
```typescript
workflow_handoffs: defineTable({
  incident_id: v.id("incidents"),
  from_workflow: v.string(), // "incident_capture"
  to_workflow: v.string(), // "incident_analysis"
  handoff_data: v.any(), // Enhanced narrative and completion summary
  team_leader_notified: v.boolean(),
  notification_sent_at: v.optional(v.number()),
  handoff_accepted: v.boolean(),
  handoff_accepted_by: v.optional(v.id("users")),
  handoff_accepted_at: v.optional(v.number()),
  created_at: v.number(),
})
  .index("by_incident", ["incident_id"])
  .index("by_to_workflow", ["to_workflow"])
  .index("by_team_leader_notification", ["team_leader_notified"])
```

### API Specifications

**Required Convex Functions:**

#### AI Enhancement Functions:
```typescript
// apps/convex/aiEnhancement.ts
export const enhanceIncidentNarrative = action({
  args: {
    sessionToken: v.string(),
    incident_id: v.id("incidents"),
  },
  handler: async (ctx, args) => {
    // 1. Gather original narratives and clarification responses
    // 2. Generate AI-enhanced narrative using Claude SDK
    // 3. Store enhanced content with version tracking
    // 4. Return enhanced narrative for user review
  }
});

export const updateEnhancedNarrative = mutation({
  args: {
    sessionToken: v.string(),
    enhanced_narrative_id: v.id("enhanced_narratives"),
    user_edited_content: v.string(),
  },
  handler: async (ctx, args) => {
    // Save user edits to enhanced narrative
    // Update version tracking and edit history
    // Return updated enhanced narrative
  }
});
```

#### Workflow Completion Functions:
```typescript
export const validateWorkflowCompletion = query({
  args: { 
    sessionToken: v.string(),
    incident_id: v.id("incidents") 
  },
  handler: async (ctx, args) => {
    // Check completion status of all workflow steps
    // Return validation checklist with missing requirements
  }
});

export const submitIncidentForAnalysis = mutation({
  args: {
    sessionToken: v.string(),
    incident_id: v.id("incidents"),
    enhanced_narrative_id: v.id("enhanced_narratives"),
  },
  handler: async (ctx, args) => {
    // Mark incident as submitted and ready for analysis
    // Create handoff notification for team leaders
    // Update incident status and workflow completion
  }
});
```

### Component Specifications

**Page Integration:**
- Extend existing `apps/web/components/incidents/IncidentCaptureWorkflow.tsx`
- Add Step 7 to wizard framework

**New UI Components:**
- `apps/web/components/incidents/EnhancedReviewStep.tsx` - Step 7 component
- `apps/web/components/incidents/EnhancedNarrativeDisplay.tsx` - Enhanced content display
- `apps/web/components/incidents/CompletionChecklist.tsx` - Workflow validation checklist
- `apps/web/components/incidents/ExportPreview.tsx` - Final report preview
- `apps/web/components/incidents/WorkflowSubmission.tsx` - Final submission interface

**AI Integration:**
- `apps/web/lib/ai/narrative-enhancement-service.ts` - Client-side enhancement service
- `apps/convex/lib/ai/narrative-enhancer.ts` - Server-side AI narrative enhancement
- `apps/convex/lib/ai/prompt-templates.ts` - Enhancement prompt templates

### File Locations

**Frontend Implementation:**
- `apps/web/components/incidents/EnhancedReviewStep.tsx` - Step 7 component
- `apps/web/components/incidents/EnhancedNarrativeDisplay.tsx` - Enhanced content display
- `apps/web/lib/ai/` - AI enhancement utilities
- `apps/web/types/enhancement.ts` - TypeScript interfaces

**Backend Implementation:**
- `apps/convex/aiEnhancement.ts` - Enhancement and completion functions
- `apps/convex/lib/ai/narrative-enhancer.ts` - AI service integration
- `apps/convex/lib/ai/prompt-templates.ts` - Enhancement prompt system

### Technical Constraints

**AI Service Integration** [Source: docs/architecture/tech-stack.md]:
- Use Claude SDK for backend AI communication
- Implement retry logic for AI service failures
- Cache enhanced narratives to avoid regeneration costs
- Use correlation IDs for request tracking

**Performance Requirements**:
- Narrative enhancement: <15 seconds per incident
- Export preview generation: <3 seconds
- Auto-save enhanced edits every 30 seconds (consistent with previous stories)
- Support offline editing with sync on reconnection

**Data Preservation** [Source: coding standards]:
- All original content must be preserved for audit purposes
- Version tracking for all AI enhancements and user edits
- Complete audit trail of workflow completion and handoff

**Error Handling Strategy** [Source: docs/architecture/error-handling-strategy.md]:
- Graceful degradation when AI services unavailable
- User-friendly error messages for enhancement failures
- Fallback to manual narrative review when AI enhancement fails
- Comprehensive logging for debugging AI enhancement issues

### Pattern Validation

**Repository Pattern** [Source: docs/architecture/coding-standards.md]:
- All data access through repository pattern
- No direct database access from components
- Centralized AI service configuration

**TypeScript Requirements** [Source: docs/architecture/coding-standards.md]:
- Strict mode compliance required
- No `any` type usage - define proper interfaces
- Full type safety for AI request/response data

**Correlation ID Requirements**:
- All AI requests must include correlation IDs  
- Link AI logs to incident and user context
- Enable end-to-end request tracing

### Testing

**Testing Standards** [Source: docs/testing/technical/test-strategy-and-standards.md]:

**Test File Locations:**
- Unit tests: `tests/web/components/incidents/` - UI component testing
- Integration tests: `tests/convex/ai-enhancement/` - AI enhancement workflow testing  
- E2E tests: `tests/e2e/workflow-completion/` - Complete Steps 1-7 user flow

**Testing Frameworks:**
- **Jest + RTL**: Component behavior testing with proper AI service mocking
- **Convex Testing**: Backend function testing with mock AI responses
- **Playwright**: E2E testing of complete incident capture workflow

**AI Service Testing Patterns:**
- Mock AI responses for unit tests
- Use deterministic AI responses in integration tests  
- Test error scenarios (AI unavailable, malformed responses)
- Validate enhancement quality and user edit preservation

**Coverage Requirements:**
- Unit tests: 85%+ coverage for enhancement and review components
- Integration tests: 100% coverage of AI enhancement and workflow completion
- E2E tests: Complete Steps 1-7 user journey with handoff verification

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-12 | 1.0 | Initial story creation for Epic 3 narrative enhancement and completion | Bob (Scrum Master) |
| 2025-08-12 | 1.1 | Story status changed to Ready - dependencies resolved with Story 3.4 completion | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*

### Pattern Compliance Review
*To be filled by QA agent*

### Knowledge Capture
*To be filled by QA agent*  

### Velocity Data
*To be filled by QA agent*