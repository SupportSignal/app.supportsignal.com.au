# Story 4.2: Workflow Continuation System

## Story Details

**Priority**: HIGH  
**Epic**: Epic 4: Incident Management & Listing  
**Estimated Effort**: 4-5 days  
**Status**: NOT STARTED

## User Story

As a **user with incident creation permissions**, when I visit the new incident page, I want to see my incomplete incidents and choose to continue existing work or start fresh, so that I don't create duplicate incidents or lose progress on partially completed work.

## Business Value

Prevents workflow abandonment and duplicate incident creation while providing seamless workflow continuation.

**Impact**:
- Reduces duplicate incident creation by providing clear workflow continuation options
- Improves user efficiency by eliminating time lost searching for incomplete work
- Decreases workflow abandonment by making incomplete incidents easily discoverable
- Enhances user experience by providing intelligent workflow guidance

## Technical Foundation

Building on Story 4.1's incident listing foundation:
- Leverages `getMyIncompleteIncidents()` query for personal incident discovery
- Extends existing `/new-incident` route with conditional modal logic
- Reuses incident status tracking from foundational listing system
- Integrates with existing workflow routing and state management

## Acceptance Criteria

### AC1: Conditional Modal Display Logic
**Requirements**:
- Modal triggered **ONLY** when user has incomplete incidents
- If no incomplete incidents exist → Direct to new incident creation (no modal)
- If incomplete incidents exist → Show "Continue Existing" vs "Start New Incident" modal
- Improves UX by eliminating unnecessary modal interruption

**Technical Implementation**:
```typescript
// Query incomplete incidents on page load
const incompleteIncidents = useQuery(api.incidents.getMyIncompleteIncidents);

// Conditional modal rendering logic
const shouldShowModal = incompleteIncidents && incompleteIncidents.length > 0;
```

**Validation Criteria**:
- [ ] Modal only appears when user has incomplete incidents
- [ ] No modal shown when user has no incomplete incidents
- [ ] Direct navigation to incident creation when no incomplete incidents
- [ ] Modal renders within 1 second of page load

### AC2: Personal Incident Preview
**Requirements**:
- Incident summary cards showing: Participant, Date Started, Current Step
- Progress indicator (e.g., "Step 3 of 7 - During Event Narrative")
- Last modified timestamp for context
- Quick preview of incident content (first 100 characters)

**UI Specifications**:
```typescript
interface IncidentPreviewCard {
  participant: string;
  dateStarted: string;
  currentStep: number;
  stepDescription: string;
  lastModified: string;
  contentPreview: string; // First 100 characters
  progressPercentage: number;
}
```

**Visual Requirements**:
- Card-based layout showing maximum 3-4 incomplete incidents
- Progress bars showing completion percentage
- Clear visual hierarchy with participant name as primary identifier
- Mobile-responsive design for all users

**Validation Criteria**:
- [ ] All required fields displayed correctly in preview cards
- [ ] Progress indicators accurately reflect current workflow step
- [ ] Content preview shows meaningful incident context
- [ ] Last modified timestamp provides temporal context

### AC3: Seamless Workflow Integration
**Requirements**:
- "Continue" button resumes exact workflow step where user left off
- "Start New" proceeds to fresh incident creation
- "Maybe Later" option closes modal and allows normal navigation

**Routing Logic**:
```typescript
// Continue existing incident
router.push(`/new-incident?id=${incidentId}&step=${currentStep}`);

// Start new incident
router.push('/new-incident');
```

**State Management**:
- Preserve existing incident state when continuing
- Clear form state when starting new incident
- Handle modal dismissal without affecting navigation

**Validation Criteria**:
- [ ] Continue button resumes at exact workflow step
- [ ] Start New creates fresh incident with clean form state
- [ ] Maybe Later closes modal and allows normal page navigation

### AC4: Performance and UX
**Requirements**:
- Modal loads quickly (<1 second) with minimal data
- Mobile-responsive design for all users
- Keyboard navigation support (Enter to continue, Esc to close)

**Performance Targets**:
- Modal render time: <500ms
- Data fetch time: <1 second
- Total time to interaction: <1.5 seconds

**Accessibility Requirements**:
- ARIA labels for screen readers
- Keyboard navigation support
- Focus management for modal interaction
- High contrast visual design

**Mobile Optimization**:
- Touch-friendly button sizes (minimum 44px)
- Optimized layout for small screens
- Fast interaction response times
- Simplified content for mobile context

**Validation Criteria**:
- [ ] Modal loads within performance targets
- [ ] Responsive design works on mobile devices
- [ ] Keyboard navigation functions correctly
- [ ] Accessibility standards met

## Implementation Tasks

### Task 4.2.1: Backend API Development
**Objective**: Create the API foundation for workflow continuation functionality

**Implementation Steps**:
1. **Extend Convex queries for incomplete incidents**:
   ```typescript
   // convex/incidents.ts
   export const getMyIncompleteIncidents = query({
     args: {},
     handler: async (ctx) => {
       const { user } = await requirePermission(ctx, args.sessionToken, PERMISSIONS.VIEW_MY_INCIDENTS);
       
       return await ctx.db
         .query("incidents")
         .withIndex("by_user_company", (q) =>
           q.eq("userId", user._id).eq("companyId", user.companyId)
         )
         .filter((q) => 
           q.or(
             q.eq(q.field("status"), "draft"),
             q.eq(q.field("status"), "capture_pending")
           )
         )
         .order("desc")
         .take(10); // Limit to recent incomplete incidents
     },
   });
   ```

2. **Add current step tracking to incident schema**:
   ```typescript
   // convex/schema.ts - extend incident table
   currentStep: v.optional(v.number()), // 1-7 for workflow steps
   stepDescription: v.optional(v.string()), // Human readable step name
   contentPreview: v.optional(v.string()), // First 100 chars for preview
   ```

3. **Create workflow step resolution helper**:
   ```typescript
   // convex/incidents.ts
   export const getWorkflowStepInfo = (step: number) => {
     const stepMap = {
       1: "Basic Information",
       2: "Before Event",
       3: "During Event", 
       4: "After Event",
       5: "Q&A Session",
       6: "AI Enhancement",
       7: "Review & Submit"
     };
     return stepMap[step] || "Unknown Step";
   };
   ```

**Acceptance Criteria**:
- [ ] `getMyIncompleteIncidents` query returns user's incomplete incidents only
- [ ] Company-scoped data filtering enforced (no cross-company data)
- [ ] Current step and progress information included in response
- [ ] Query performance optimized for mobile usage (<1 second)

### Task 4.2.2: Continue Workflow Modal Component
**Objective**: Build the core modal component for workflow continuation

**Implementation Steps**:
1. **Create modal component structure**:
   ```typescript
   // components/incidents/ContinueWorkflowModal.tsx
   interface ContinueWorkflowModalProps {
     isOpen: boolean;
     onClose: () => void;
     incompleteIncidents: IncidentPreview[];
     onContinue: (incidentId: string) => void;
     onStartNew: () => void;
   }
   ```

2. **Build incident preview cards**:
   ```typescript
   // components/incidents/IncidentPreviewCard.tsx
   interface IncidentPreviewCardProps {
     participant: string;
     dateStarted: Date;
     currentStep: number;
     lastModified: Date;
     contentPreview: string;
     onContinue: () => void;
   }
   ```

3. **Implement progress indicators**:
   - Visual progress bar showing completion percentage
   - Step indicator showing "Step X of 7 - [Description]"
   - Last modified relative time display

4. **Add accessibility features**:
   - ARIA labels and roles
   - Keyboard navigation (Tab, Enter, Escape)
   - Focus management
   - Screen reader compatibility

**Acceptance Criteria**:
- [ ] Modal displays incomplete incidents in card format
- [ ] Progress indicators show accurate completion status
- [ ] All action buttons (Continue, Start New, Maybe Later) function correctly
- [ ] Accessibility features implemented and tested
- [ ] Mobile-responsive design verified

### Task 4.2.3: New Incident Page Integration
**Objective**: Integrate the continue workflow modal into the existing new incident page

**Implementation Steps**:
1. **Update `/new-incident` page with modal logic**:
   ```typescript
   // app/new-incident/page.tsx
   const incompleteIncidents = useQuery(api.incidents.getMyIncompleteIncidents);
   const shouldShowModal = incompleteIncidents?.length > 0;
   ```

2. **Add URL parameter handling**:
   ```typescript
   // Handle ?id=incident_id&step=X parameters for continuation
   const searchParams = useSearchParams();
   const continueIncidentId = searchParams.get('id');
   const continueStep = searchParams.get('step');
   ```

3. **Implement routing logic**:
   - Continue button: Navigate with incident ID and step parameters
   - Start New: Navigate to clean incident form
   - Maybe Later: Close modal, stay on current page

4. **Add state management for modal**:
   - Track modal open/closed state
   - Handle modal dismissal
   - Preserve navigation context

**Acceptance Criteria**:
- [ ] Modal automatically appears when appropriate (incomplete incidents exist)
- [ ] URL parameters for incident continuation work correctly
- [ ] Navigation routing works for all modal actions
- [ ] No modal shown when no incomplete incidents

### Task 4.2.4: Workflow State Continuation
**Objective**: Enable seamless continuation of incomplete incident workflows

**Implementation Steps**:
1. **Extend incident form to load existing data**:
   ```typescript
   // Load existing incident data when continuing
   const existingIncident = useQuery(api.incidents.getIncident, 
     continueIncidentId ? { id: continueIncidentId } : "skip"
   );
   ```

2. **Implement step-specific form population**:
   - Pre-populate form fields with existing incident data
   - Set correct step in workflow progression
   - Handle partial data gracefully

3. **Add form state management**:
   - Differentiate between new and continued incidents
   - Handle form validation for partially complete data
   - Preserve unsaved changes during continuation

4. **Implement progress tracking**:
   - Update incident's current step as user progresses
   - Track completion percentage
   - Update last modified timestamp

**Acceptance Criteria**:
- [ ] Existing incident data loads correctly when continuing
- [ ] Form pre-populates with saved information
- [ ] Workflow resumes at correct step
- [ ] Progress tracking updates as user continues
- [ ] Form validation handles partial data appropriately

### Task 4.2.5: Performance Optimization and Testing
**Objective**: Ensure the continuation system meets performance targets and quality standards

**Implementation Steps**:
1. **Performance optimization**:
   - Optimize modal render time (<500ms)
   - Minimize data fetching for incomplete incidents
   - Implement loading states for better perceived performance
   - Add error handling for network issues

2. **Mobile optimization**:
   - Test on various mobile screen sizes
   - Optimize touch targets for finger navigation
   - Ensure fast interaction response times
   - Test with slow network conditions

3. **Comprehensive testing**:
   - Unit tests for modal logic and state management
   - Integration tests for workflow continuation
   - E2E tests for complete user journeys
   - Accessibility testing with screen readers

4. **Edge case handling**:
   - Handle incidents deleted by another user
   - Manage concurrent editing scenarios
   - Handle network failures gracefully
   - Test with various incomplete incident states

**Acceptance Criteria**:
- [ ] Performance targets met (modal <1s, interaction <1.5s)
- [ ] Mobile experience optimized and tested
- [ ] Comprehensive test coverage implemented
- [ ] Edge cases handled appropriately
- [ ] Error handling provides clear user feedback

## Dependencies

### Prerequisites
- **Story 4.1**: Incident listing foundation must be complete
  - `getMyIncompleteIncidents` query implementation
  - Incident status tracking system
  - Company-scoped data filtering patterns

### Technical Dependencies
- **Existing Incident Capture Workflow**: Continue functionality builds on Epic 3's incident creation system
- **Authentication System**: User session management for personal incident access
- **Permission System**: Role-based access control for users with incident creation permissions

### External Dependencies
- **Mobile Testing Devices**: Physical devices for mobile optimization testing
- **User Acceptance Testing**: User feedback on workflow UX from all roles with incident creation permissions

## Security Considerations

### Data Access Control
- **Company Boundary Enforcement**: Incomplete incidents query must respect company boundaries
- **User Context Verification**: Ensure continued incidents belong to the requesting user
- **Permission Validation**: Verify user has CREATE_INCIDENT and VIEW_MY_INCIDENTS permissions for incident access

### Data Privacy
- **Content Preview Limitation**: Limit preview content to non-sensitive information (first 100 characters)
- **Session Management**: Secure handling of incident ID parameters in URLs
- **Data Minimization**: Only fetch necessary data for modal display

## Risk Analysis

### Technical Risks
- **Modal Performance**: Complex modal with multiple incident cards may load slowly
  - *Mitigation*: Limit to 10 most recent incidents, implement lazy loading
- **State Management Complexity**: Managing modal state alongside form state
  - *Mitigation*: Use clear state separation and well-defined interfaces

### User Experience Risks
- **Modal Interruption Fatigue**: Users may find modal disruptive to workflow
  - *Mitigation*: Only show modal when incomplete incidents exist, provide "Maybe Later" option
- **Mobile Usability**: Modal may be difficult to use on small screens
  - *Mitigation*: Extensive mobile testing and touch-optimized design

### Business Risks
- **Workflow Disruption**: Changes to familiar `/new-incident` flow
  - *Mitigation*: Phased rollout with user training and feedback collection
- **Decreased New Incident Creation**: Users may always continue instead of starting fresh
  - *Mitigation*: Monitor metrics and ensure "Start New" option is prominent and easy to use

## Success Metrics

### User Adoption
- **Workflow Continuation Rate**: >60% of incomplete incidents resumed vs. abandoned
- **Modal Usage**: >80% of users with incomplete incidents use continue functionality
- **User Satisfaction**: Modal rated >4/5 for helpfulness across all user roles

### Performance Metrics
- **Modal Load Time**: <1 second from page load to interactive modal
- **Continue Success Rate**: >95% of continue actions successfully resume workflow
- **Mobile Performance**: Modal functions smoothly on mobile devices

### Business Impact
- **Duplicate Reduction**: <5% duplicate incidents created (compare to baseline)
- **Completion Rate**: Increase in incident completion rate by 20%
- **User Efficiency**: Reduce time to resume incomplete work by 75%

## Definition of Done

### Feature Completion
- [ ] All acceptance criteria validated and working
- [ ] Modal displays incomplete incidents correctly
- [ ] Continue, Start New, and Maybe Later actions function properly
- [ ] URL bypass parameter implemented for power users
- [ ] Performance targets met (<1 second modal load)

### Quality Assurance
- [ ] Unit tests cover modal logic and state management
- [ ] Integration tests verify workflow continuation
- [ ] E2E tests validate complete user journeys
- [ ] Mobile testing completed on iOS and Android devices
- [ ] Accessibility testing passed with screen readers

### User Validation
- [ ] Testing with all roles (users with CREATE_INCIDENT permission) confirms improved workflow experience
- [ ] Modal UX validated as helpful rather than disruptive
- [ ] Continue functionality successfully resumes incomplete incidents
- [ ] No regression in existing new incident creation workflow

### Documentation
- [ ] User guide updated with continue workflow instructions
- [ ] Technical documentation covers new API endpoints
- [ ] Troubleshooting guide includes common modal issues

---

**Story 4.2 creates the bridge between incomplete incident discovery and seamless workflow continuation, completing the user experience foundation needed for effective incident management in Epic 4.**