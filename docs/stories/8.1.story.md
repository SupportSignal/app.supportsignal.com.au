# Story 8.1: Convex Environment Separation & Production Connection

## Status
Ready

## Story
**As a** system administrator,
**I want** to establish proper environment separation between development and production Convex deployments,
**so that** production and development systems have isolated databases and configuration, eliminating shared data issues and ensuring production reliability.

## Acceptance Criteria

1. **Verify Production Deployment**: Confirm `graceful-shrimp-355` production deployment exists and is accessible via Convex dashboard and CLI
2. **Update Source-of-Truth Configuration**: Update `~/.env-configs/app.supportsignal.com.au.env` with correct production Convex deployment values (requires human)
3. **Regenerate Environment Files**: Use `bun run sync-env --deployment=production` to generate proper environment configuration
4. **Update Cloudflare Pages Environment**: Configure production environment variables to use `graceful-shrimp-355.convex.cloud` instead of shared `beaming-gull-639`
5. **Test Data Isolation**: Verify complete separation between dev and production databases with no shared data access
6. **Data Migration**: Migrate essential production data (companies, users, sessions) from shared deployment if needed
7. **Environment Validation**: Confirm both environments work independently with correct database access

## Estimation & Planning

### Story Points
**5**

### Estimated Complexity
**Medium-High**

### Estimated Time
**2-3 days**

### Risk Level
**High**

**Risk Factors:**
- Production data migration and potential data loss
- Production downtime during deployment switching
- Convex deployment access and permissions
- Environment variable coordination across multiple services

## Tasks / Subtasks

- [ ] **Production Deployment Verification** (AC: 1)
  - [ ] Verify `graceful-shrimp-355` deployment exists in Convex dashboard
  - [ ] Test Convex CLI access to production deployment
  - [ ] Document current production deployment schema and functions
  - [ ] Verify deployment permissions and access controls

- [ ] **Environment Management System Update** (AC: 2, 3)
  - [ ] **HUMAN REQUIRED**: Update `~/.env-configs/app.supportsignal.com.au.env` with production values
  - [ ] Change `CONVEX_DEPLOYMENT` from `dev:beaming-gull-639` to `prod:graceful-shrimp-355`
  - [ ] Change `NEXT_PUBLIC_CONVEX_URL` from `beaming-gull-639.convex.cloud` to `graceful-shrimp-355.convex.cloud`
  - [ ] Run `bun run sync-env --deployment=production` to regenerate environment files
  - [ ] Verify `.env.source-of-truth.local` reflects correct production values

- [ ] **Data Assessment & Migration Planning** (AC: 6)
  - [ ] Audit current shared database for production vs development data
  - [ ] Identify essential production data for migration (companies, users, sessions)
  - [ ] Create data migration scripts for essential tables
  - [ ] Plan rollback strategy in case of migration failures

- [ ] **Cloudflare Pages Environment Configuration** (AC: 4)
  - [ ] Update production environment variables in Cloudflare Pages dashboard
  - [ ] Use regenerated environment values from sync-env script
  - [ ] Update related Convex environment variables for production
  - [ ] Verify environment variable propagation to deployment

- [ ] **Data Migration Execution** (AC: 4)
  - [ ] Backup current shared database state
  - [ ] Execute data migration to production deployment
  - [ ] Verify data integrity after migration
  - [ ] Test critical user flows with migrated data

- [ ] **Environment Isolation Testing** (AC: 5, 7)
  - [ ] Test development environment still uses `beaming-gull-639`
  - [ ] Test production environment uses `graceful-shrimp-355`
  - [ ] Verify no cross-environment data access
  - [ ] Test authentication and user sessions in both environments

- [ ] **Verification Commands** (AC: 7)
  - [ ] Run `cat apps/web/.env.local | grep CONVEX_URL` to verify correct production URL
  - [ ] Run `cat apps/convex/.env.local | grep CONVEX_DEPLOYMENT` to verify deployment
  - [ ] Run `grep -n "graceful-shrimp" ~/.env-configs/app.supportsignal.com.au.env` to verify source changes
  - [ ] Test production site loads with new environment configuration

## Documentation Impact Assessment

**Architectural Patterns:**
- **Environment separation** patterns for Convex multi-deployment architecture
- **Data migration** patterns for production database transitions
- **Configuration management** patterns for multi-environment deployments
- **Deployment verification** patterns for infrastructure changes

**Documentation Updates Needed:**
- `docs/architecture/deployment-architecture.md` - Environment separation patterns
- `docs/technical-guides/convex-deployment-management.md` - Deployment procedures
- `docs/technical-guides/environment-configuration.md` - Environment variable management
- `docs/operations/data-migration-procedures.md` - Data migration playbooks

**Knowledge Capture:**
- Convex multi-deployment management patterns
- Production data migration strategies
- Environment isolation verification procedures
- Cloudflare Pages environment configuration management

**Examples to Create:**
- Complete environment separation implementation
- Data migration scripts and procedures
- Environment validation testing patterns

## Dev Notes

### Architecture Context

**Current Environment Problem:**
Both development (localhost:3200) and production (app.supportsignal.com.au) are using the same Convex deployment (`beaming-gull-639.convex.cloud`), causing:
- Shared database between environments
- Development data mixed with production data
- Risk of accidental production data corruption
- Configuration issues leading to localhost URLs in production

**Target Architecture:**
- **Development**: `dev:beaming-gull-639.convex.cloud` (current, keep as-is)
- **Production**: `prod:graceful-shrimp-355.convex.cloud` (target deployment)

**Deployment Information:**
- **Current MCP Status**: Only `ownDev:beaming-gull-639` visible in Convex MCP
- **Production Target**: `graceful-shrimp-355` deployment mentioned but needs verification
- **Access Requirements**: Convex dashboard and CLI access to both deployments

### Environment Management System Architecture

**Environment Configuration Flow**:
1. **Source-of-Truth** (human-managed): `~/.env-configs/app.supportsignal.com.au.env`
2. **Generated Files** (auto-generated): `.env.source-of-truth.local` via `bun run sync-env`
3. **Application Files** (auto-generated): `apps/web/.env.local`, `apps/convex/.env.local`

**Critical Issue Identified**:
The source-of-truth file currently has **identical dev and production values**:
```
| CONVEX | CONVEX_DEPLOYMENT | dev:beaming-gull-639 | dev:beaming-gull-639 |
| NEXTJS,CONVEX,GITHUB | NEXT_PUBLIC_CONVEX_URL | https://beaming-gull-639.convex.cloud | https://beaming-gull-639.convex.cloud |
```

**Required Source-of-Truth Updates** (HUMAN REQUIRED):
```
| CONVEX | CONVEX_DEPLOYMENT | dev:beaming-gull-639 | prod:graceful-shrimp-355 |
| NEXTJS,CONVEX,GITHUB | NEXT_PUBLIC_CONVEX_URL | https://beaming-gull-639.convex.cloud | https://graceful-shrimp-355.convex.cloud |
```

### **Complete sync-env.js Operations Guide**

**Testing Commands** (Always run these first):
```bash
# Test current dev environment (safe)
bun run sync-env --deployment=dev --dry-run --verbose

# Test what production would generate (safe)
bun run sync-env --deployment=production --dry-run --verbose
```

**Environment Sync Process**:
```bash
# Development environment
bun run sync-env --deployment=dev

# Production environment (generates local files only)
bun run sync-env --deployment=production
```

**Key Features**:
- ✅ **Automatic Backups**: Creates `~/.env-configs/backups/app.supportsignal.com.au/`
- ✅ **Safety**: `--dry-run` flag for testing without changes
- ✅ **Verbose Output**: `--verbose` flag for detailed process info
- ✅ **Multi-File Generation**: Creates web, convex, and worker .env files

**Exact Manual Changes Required**:

**File**: `~/.env-configs/app.supportsignal.com.au.env`

**Line 16** - Change:
```
| CONVEX | CONVEX_DEPLOYMENT | dev:beaming-gull-639 | dev:beaming-gull-639 |
```
**TO**:
```
| CONVEX | CONVEX_DEPLOYMENT | dev:beaming-gull-639 | prod:graceful-shrimp-355 |
```

**Line 17** - Change:
```
| NEXTJS,CONVEX,GITHUB | NEXT_PUBLIC_CONVEX_URL | https://beaming-gull-639.convex.cloud | https://beaming-gull-639.convex.cloud |
```
**TO**:
```
| NEXTJS,CONVEX,GITHUB | NEXT_PUBLIC_CONVEX_URL | https://beaming-gull-639.convex.cloud | https://graceful-shrimp-355.convex.cloud |
```

**Line 23** - Change:
```
| LOG_WORKER | ALLOWED_ORIGINS | https://beaming-gull-639.convex.cloud,http://localhost:3200 | https://beaming-gull-639.convex.cloud,http://localhost:3200 |
```
**TO**:
```
| LOG_WORKER | ALLOWED_ORIGINS | https://beaming-gull-639.convex.cloud,http://localhost:3200 | https://graceful-shrimp-355.convex.cloud,https://app.supportsignal.com.au |
```

### Data Migration Strategy

**Essential Production Tables to Migrate:**
- `companies` - Production company data
- `users` - Production user accounts
- `sessions` - Active user sessions
- `password_reset_tokens` - Active password reset requests
- Critical incident data (if any exists in production)

**Migration Approach:**
1. **Assessment Phase**: Identify production vs development data in shared database
2. **Backup Phase**: Full backup of current shared database
3. **Migration Phase**: Export production data and import to `graceful-shrimp-355`
4. **Validation Phase**: Verify data integrity and functionality
5. **Cleanup Phase**: Remove production data from development deployment

### Technical Implementation Requirements

**Convex Deployment Management:**
- Use `bunx convex env list` to verify available deployments
- Use `CONVEX_DEPLOYMENT=prod:graceful-shrimp-355` for production operations
- Verify schema deployment to production deployment
- Test function deployment and execution

**Environment Variable Update Process:**
1. **Cloudflare Pages Dashboard**: Update production environment variables
2. **Trigger Redeployment**: Force rebuild to pick up new environment variables
3. **Verification**: Test production site loads with new Convex connection
4. **Monitoring**: Watch for any connection errors or data access issues

### Pattern Validation

**Environment Separation Patterns:**
- Follow established multi-environment patterns from architecture documentation
- Ensure proper isolation between dev and production data
- Implement proper environment detection and configuration management
- Maintain separate deployment pipelines for each environment

**Data Migration Patterns:**
- Use established backup and migration procedures
- Implement data validation and integrity checks
- Document migration procedures for future reference
- Create rollback procedures for migration failures

### Testing Standards

**Test Requirements:**
- **Location**: `tests/integration/environment-separation/` for environment tests
- **Frameworks**: Manual testing for environment configuration, automated tests for data isolation
- **Coverage**: Environment variable propagation, data isolation, authentication flows
- **Validation**: Production and development environment independence

**Testing Patterns:**
- Test both environments independently after changes
- Verify no cross-environment data access
- Test critical user flows in both environments
- Monitor for any environment configuration errors

**Testing Standards Reference:**
- Follow patterns established in `docs/testing/technical/testing-patterns.md`
- Use pragmatic testing approach for infrastructure changes
- Document environment testing procedures for future use

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-28 | 1.0 | Initial story creation from Epic 8 requirements | Bob (SM Agent) |
| 2025-01-28 | 1.1 | Added environment management system requirements after discovering source-of-truth configuration issues | Bob (SM Agent) |
| 2025-01-28 | 1.2 | Added comprehensive sync-env.js operational details with exact commands and file changes | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results

### Pattern Compliance Review
*To be populated by QA agent*

### Knowledge Capture
*To be populated by QA agent*

### Velocity Data
*To be populated by QA agent*