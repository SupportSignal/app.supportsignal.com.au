# Story 7.4: Initial Participant Setup (System Admin)

## Status
Approved

## Use Worktree
false

## Story
**As a** system administrator,
**I want** to quickly add 5-10 sample participants with basic NDIS information and site assignments to a newly created company,
**so that** the company can immediately start using the incident capture workflow.

## Acceptance Criteria

1. **Schema Update**: Add `site_id` field to participants table with required indexes
2. **Participant Form**: System admin interface at `/admin/companies/{id}/participants/create`
3. **Basic Fields**: First name, last name, NDIS number, DOB, support level
4. **Site Selection**: Dropdown showing company's sites (required field)
5. **Auto-Selection Logic**: If company has only one site, automatically default to that site; if multiple sites, require manual selection
6. **Site Validation**: Cannot create participant without selecting a site
7. **Company Association**: Participants automatically linked to correct company
8. **NDIS Number Validation**: Basic format validation for NDIS numbers
9. **Success Feedback**: Confirmation after participant creation using toast notifications
10. **Participant List**: View created participants with site information
11. **Site Filter**: Filter participants by site in listing
12. **Migration Script**: Link all existing participants to their company's Primary site

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**Medium-High**

### Estimated Time
**3-4 days**

### Risk Level
**Medium**

**Risk Factors:**
- Schema migration complexity (adding site_id to existing participants)
- Data migration for existing participants (linking to Primary sites)
- Site dropdown population and validation
- NDIS number format validation requirements

**Mitigation Strategies:**
- Follow established migration pattern from Story 7.3
- Use existing sites created in Story 7.3
- Implement comprehensive validation before allowing participant creation
- Test migration script on development environment before production

## Tasks / Subtasks

### Phase 1: Schema Update and Migration (AC: 1, 11)
- [ ] **Task 1.1**: Update participants schema in `apps/convex/schema.ts`
  - [ ] Add `site_id: v.id("sites")` field (required)
  - [ ] Add index: `by_site` on `site_id`
  - [ ] Add index: `by_company_and_site` on `company_id` and `site_id`
  - [ ] Deploy schema changes to Convex development
  - [ ] Verify schema deployment using Convex dashboard
- [ ] **Task 1.2**: Create migration script for existing participants
  - [ ] Create file: `apps/convex/participants/migration.ts`
  - [ ] Implement `linkToPrimarySites` internalMutation
  - [ ] For each participant without `site_id`:
    - Query participant's `company_id`
    - Find company's Primary site
    - Update `participant.site_id` with Primary site ID
  - [ ] Log all migration operations for audit trail
  - [ ] Return summary: { updated: number, skipped: number, total: number }
- [ ] **Task 1.3**: Test and run migration
  - [ ] Run migration in development: `bunx convex run participants/migration:linkToPrimarySites`
  - [ ] Verify all participants have `site_id` populated
  - [ ] Check Convex dashboard for data integrity
  - [ ] Run migration in production when ready

### Phase 2: Backend CRUD Functions (AC: 3, 4, 5, 6, 7)
- [ ] **Task 2.1**: Create `apps/convex/participants/admin.ts` for system admin operations
  - [ ] `listParticipants(sessionToken, companyId, siteId?)` query
    - System admin auth check
    - Optional site filtering
    - Include site information in response
    - Sort by last_name, first_name
  - [ ] `createParticipant(sessionToken, companyId, siteId, firstName, lastName, ndisNumber, dateOfBirth, supportLevel)` mutation
    - System admin permission check
    - Validate all required fields
    - Validate NDIS number format (basic format check)
    - Validate site belongs to company
    - Set created_at, created_by, updated_at, updated_by
    - Return participant ID
  - [ ] `getParticipantById(sessionToken, participantId)` query
    - System admin auth
    - Include site information
  - [ ] All functions use `requirePermission` with `PERMISSIONS.MANAGE_COMPANY`
- [ ] **Task 2.2**: Implement validation logic
  - [ ] NDIS number format validation (basic 9-digit format)
  - [ ] Site validation (site must belong to company)
  - [ ] Required field validation (first name, last name, DOB, support level, site)
  - [ ] Clear ConvexError messages for validation failures
- [ ] **Task 2.3**: Test backend functions
  - [ ] Test participant creation with valid data
  - [ ] Test validation failures (missing fields, invalid NDIS number, wrong site)
  - [ ] Test list participants with and without site filter
  - [ ] Test get participant by ID

### Phase 3: Frontend Participant List (AC: 9, 10)
- [ ] **Task 3.1**: Create participant list page at `apps/web/app/admin/companies/[id]/participants/page.tsx`
  - [ ] Use `export const runtime = 'edge';` for Cloudflare Pages
  - [ ] System admin auth protection
  - [ ] Query participants using `api['participants/admin'].listParticipants`
  - [ ] Display table with columns: Name, NDIS Number, DOB, Support Level, Site, Status
  - [ ] Add "Add Participant" button
  - [ ] Add site filter dropdown (All Sites + individual sites)
  - [ ] Link to participant creation page
- [ ] **Task 3.2**: Add navigation tab to company admin interface
  - [ ] Update company layout to include "Participants" tab
  - [ ] Tab should appear alongside "Users" and "Sites" tabs
  - [ ] Show participant count badge if possible

### Phase 4: Frontend Participant Creation Form (AC: 2, 3, 4, 5, 6, 7, 8, 9)
- [ ] **Task 4.1**: Create participant creation page at `apps/web/app/admin/companies/[id]/participants/create/page.tsx`
  - [ ] Use `export const runtime = 'edge';` for Cloudflare Pages
  - [ ] System admin auth protection
  - [ ] Form fields:
    - First Name (required, text input)
    - Last Name (required, text input)
    - NDIS Number (required, text input with format hint)
    - Date of Birth (required, date picker)
    - Support Level (required, dropdown: high/medium/low)
    - Site (required, dropdown populated from company's sites)
  - [ ] Submit button: "Create Participant"
  - [ ] Cancel button: Navigate back to participants list
- [ ] **Task 4.2**: Implement form submission with validation
  - [ ] Client-side validation for required fields
  - [ ] NDIS number format validation
  - [ ] Call `api['participants/admin'].createParticipant` mutation
  - [ ] Handle success: `toast.success('Participant created successfully')`
  - [ ] Handle errors: Extract clean message from `error.data?.message`
  - [ ] Display errors using `toast.error(errorMessage)`
  - [ ] Reset form and navigate to participants list on success
- [ ] **Task 4.3**: Implement site dropdown with auto-selection logic (AC: 5)
  - [ ] Query company's sites using `api['sites/admin'].listSites`
  - [ ] Display site names in dropdown
  - [ ] **Auto-selection**: If company has exactly 1 site, automatically set as default value
  - [ ] **Manual selection**: If company has 2+ sites, require user to select from dropdown
  - [ ] Show "No sites available" message if company has no sites
  - [ ] Make site field required (cannot submit without selection)
  - [ ] Use `useEffect` to auto-populate siteId when sites query returns single site

### Phase 5: Testing and Validation (AC: All)
- [ ] **Task 5.1**: Manual testing
  - [ ] Create new participant with valid data
  - [ ] Verify participant appears in list with correct site
  - [ ] Test site filtering in participant list
  - [ ] Test validation errors (missing fields, invalid NDIS number)
  - [ ] Verify toast notifications appear correctly
  - [ ] Test migration script with existing data
- [ ] **Task 5.2**: Edge case testing
  - [ ] Company with no sites (should prevent participant creation)
  - [ ] Invalid NDIS number formats
  - [ ] Duplicate NDIS numbers (if validation added)
  - [ ] Site dropdown with many sites (10+ sites)

## Documentation Impact Assessment

**Architectural Patterns**:
- Migration script pattern for adding required foreign keys to existing data
- Multi-step form validation pattern (client + server)
- Site-based filtering and organization pattern
- NDIS number validation pattern

**Documentation Updates**:
- May need pattern documentation for data migration with required foreign keys
- Example of site dropdown population and validation
- NDIS number format validation rules and pattern

**Knowledge Capture**:
- Migration strategy for adding required relationships to existing data
- Site-based participant organization approach
- System admin CRUD patterns for participants

## Dev Notes

### Previous Story Insights

**From Story 7.3 (Site Management)**:
- Successfully implemented site management CRUD operations
- All companies now have at least one site (Primary site created)
- Sites table structure: `{ company_id, name, created_at, created_by, updated_at }`
- Migration pattern established: `internalMutation` returns summary object
- Toast notifications configured: `<Toaster richColors position="top-right" />` in layout
- Bracket notation required for subdirectory APIs: `api['sites/admin'].listSites`

**Key Learning from Story 7.3**:
- Check foundational infrastructure before complex solutions (Toaster component must exist)
- Use ConvexError with structured messages: `{ message, code }`
- Frontend error extraction: `error.data?.message || 'Fallback message'`
- Edge runtime export required: `export const runtime = 'edge';`

### Pattern Validation

**Established Patterns to Follow**:

1. **Convex Subdirectory API Pattern** [Source: docs/patterns/backend-patterns.md]
   ```typescript
   // Frontend: Use bracket notation with .default for subdirectory exports
   const participants = useQuery(api['participants/admin'].listParticipants, { ... });
   const createParticipant = useMutation(api['participants/admin'].createParticipant);
   ```

2. **Migration Script Pattern** [Source: Story 7.3, apps/convex/sites/migration.ts]
   ```typescript
   export const linkToPrimarySites = internalMutation({
     args: {},
     handler: async (ctx) => {
       // 1. Query entities needing migration
       // 2. For each entity, update with required relationship
       // 3. Log operations for audit trail
       // 4. Return summary: { updated, skipped, total }
     }
   });
   ```

3. **Toast Notification Pattern** [Source: docs/patterns/sonner-toast-configuration.md]
   ```typescript
   import { toast } from 'sonner';

   try {
     await createParticipant({ ... });
     toast.success('Participant created successfully');
   } catch (error: any) {
     const errorMessage = error.data?.message || 'Failed to create participant';
     toast.error(errorMessage);
   }
   ```

4. **Authentication Pattern** [Source: docs/patterns/backend-patterns.md]
   ```typescript
   import { requirePermission, PERMISSIONS } from '../permissions';

   export const createParticipant = mutation({
     args: { sessionToken: v.string(), ... },
     handler: async (ctx, args) => {
       const { user } = await requirePermission(
         ctx,
         args.sessionToken,
         PERMISSIONS.MANAGE_COMPANY
       );
       // ... participant creation logic
     }
   });
   ```

### Data Models

**Participants Table Schema** (UPDATED for Story 7.4):
```typescript
participants: defineTable({
  company_id: v.id("companies"),
  site_id: v.id("sites"),              // NEW FIELD - REQUIRED
  first_name: v.string(),
  last_name: v.string(),
  date_of_birth: v.string(),
  ndis_number: v.string(),
  contact_phone: v.optional(v.string()),
  emergency_contact: v.optional(v.string()),
  support_level: v.union(
    v.literal("high"),
    v.literal("medium"),
    v.literal("low")
  ),
  care_notes: v.optional(v.string()),
  status: v.union(
    v.literal("active"),
    v.literal("inactive"),
    v.literal("discharged")
  ),
  created_at: v.number(),
  created_by: v.id("users"),
  updated_at: v.number(),
  updated_by: v.id("users"),
})
  .index("by_company", ["company_id"])
  .index("by_site", ["site_id"])                    // NEW INDEX
  .index("by_company_and_site", ["company_id", "site_id"])  // NEW INDEX
  .index("by_ndis_number", ["ndis_number"])
  .index("by_status", ["status"])
  .index("by_name", ["last_name", "first_name"])
```

**Sites Table Schema** [Source: apps/convex/schema.ts - Story 7.3]:
```typescript
sites: defineTable({
  company_id: v.id("companies"),
  name: v.string(),
  created_at: v.number(),
  created_by: v.id("users"),
  updated_at: v.optional(v.number()),
})
  .index("by_company", ["company_id"])
  .index("by_name", ["company_id", "name"])
```

### API Specifications

**Backend Functions Location**: `apps/convex/participants/admin.ts`

**Function Signatures**:

```typescript
// List participants for a company with optional site filter
export const listParticipants = query({
  args: {
    sessionToken: v.string(),
    companyId: v.id("companies"),
    siteId: v.optional(v.id("sites"))
  },
  handler: async (ctx, args) => {
    // Returns: Array<Participant & { site: Site }>
  }
});

// Create new participant
export const createParticipant = mutation({
  args: {
    sessionToken: v.string(),
    companyId: v.id("companies"),
    siteId: v.id("sites"),
    firstName: v.string(),
    lastName: v.string(),
    ndisNumber: v.string(),
    dateOfBirth: v.string(),
    supportLevel: v.union(v.literal("high"), v.literal("medium"), v.literal("low"))
  },
  handler: async (ctx, args) => {
    // Returns: { participantId: Id<"participants"> }
  }
});

// Get participant by ID with site info
export const getParticipantById = query({
  args: {
    sessionToken: v.string(),
    participantId: v.id("participants")
  },
  handler: async (ctx, args) => {
    // Returns: Participant & { site: Site }
  }
});
```

**Migration Function** [Source: docs/prd/epic-7.md]:
```typescript
// apps/convex/participants/migration.ts
export const linkToPrimarySites = internalMutation({
  args: {},
  handler: async (ctx) => {
    // 1. Query all participants
    // 2. For each participant without site_id:
    //    - Find participant's company_id
    //    - Find company's Primary site
    //    - Update participant.site_id = primary_site._id
    // 3. Return { updated: number, skipped: number, total: number }
  }
});
```

### Component Specifications

**Participant List Page**: `apps/web/app/admin/companies/[id]/participants/page.tsx`

```typescript
'use client';
export const runtime = 'edge';

export default function ParticipantsListPage({ params }: { params: { id: string } }) {
  const { user, sessionToken } = useAuth();
  const companyId = params.id as Id<'companies'>;
  const [selectedSiteId, setSelectedSiteId] = useState<Id<'sites'> | null>(null);

  // Queries
  const company = useQuery(
    api['companies/getCompanyDetails'].default,
    { sessionToken: sessionToken || '', companyId }
  );

  const sites = useQuery(
    api['sites/admin'].listSites,
    { sessionToken: sessionToken || '', companyId }
  );

  const participants = useQuery(
    api['participants/admin'].listParticipants,
    {
      sessionToken: sessionToken || '',
      companyId,
      siteId: selectedSiteId || undefined
    }
  );

  // UI Components: Table, Site Filter Dropdown, Add Participant Button
}
```

**Participant Creation Page**: `apps/web/app/admin/companies/[id]/participants/create/page.tsx`

```typescript
'use client';
export const runtime = 'edge';

export default function CreateParticipantPage({ params }: { params: { id: string } }) {
  const { user, sessionToken } = useAuth();
  const companyId = params.id as Id<'companies'>;

  // Form state
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    ndisNumber: '',
    dateOfBirth: '',
    supportLevel: 'medium' as 'high' | 'medium' | 'low',
    siteId: '' as Id<'sites'> | ''
  });

  // Queries
  const sites = useQuery(
    api['sites/admin'].listSites,
    { sessionToken: sessionToken || '', companyId }
  );

  // Auto-select site if company has exactly one site (AC: 5)
  useEffect(() => {
    if (sites && sites.length === 1 && !formData.siteId) {
      setFormData(prev => ({ ...prev, siteId: sites[0]._id }));
    }
  }, [sites, formData.siteId]);

  // Mutations
  const createParticipant = useMutation(api['participants/admin'].createParticipant);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    try {
      await createParticipant({
        sessionToken: sessionToken!,
        companyId,
        siteId: formData.siteId as Id<'sites'>,
        firstName: formData.firstName.trim(),
        lastName: formData.lastName.trim(),
        ndisNumber: formData.ndisNumber.trim(),
        dateOfBirth: formData.dateOfBirth,
        supportLevel: formData.supportLevel
      });

      toast.success('Participant created successfully');
      router.push(`/admin/companies/${companyId}/participants`);
    } catch (error: any) {
      const errorMessage = error.data?.message || 'Failed to create participant';
      toast.error(errorMessage);
    }
  };

  // UI Components:
  // - Form with validation
  // - Site dropdown (auto-populated if single site, manual selection if multiple)
  // - Submit/Cancel buttons
}
```

### File Locations

**Backend Files**:
- `apps/convex/participants/admin.ts` - CRUD operations for participant management
- `apps/convex/participants/migration.ts` - Migration script for linking participants to sites
- `apps/convex/schema.ts` - Update participants table definition (add site_id field and indexes)

**Frontend Files**:
- `apps/web/app/admin/companies/[id]/participants/page.tsx` - Participant list page
- `apps/web/app/admin/companies/[id]/participants/create/page.tsx` - Participant creation page

**Test Files** [Source: docs/testing/technical/test-strategy-and-standards.md]:
- `tests/convex/participants/admin.test.ts` - Backend function tests
- `tests/convex/participants/migration.test.ts` - Migration script tests

### Testing

**Testing Standards** [Source: docs/testing/technical/test-strategy-and-standards.md]:

**Test Location**: All tests go in centralized `tests/` directory, NOT in app directories

**Backend Testing**:
- Location: `tests/convex/participants/`
- Framework: Jest with Convex testing utilities
- Coverage: CRUD operations, validation rules, migration script
- Key scenarios:
  - Create participant with valid data
  - Validation failures (missing site, invalid NDIS number)
  - Site relationship validation (site must belong to company)
  - Migration script idempotency (run twice, should skip already updated)
  - List participants with and without site filter

**Frontend Testing**:
- Location: `tests/web/admin/participants/` (if needed for complex components)
- Framework: Jest + React Testing Library
- Use path aliases: `@/components` not `../../../../apps/web/components`
- Pragmatic testing: Test behavior, not implementation details

**Migration Testing Strategy**:
1. Test in development first with existing data
2. Verify idempotency (run twice, should skip already updated participants)
3. Check Convex dashboard for data integrity
4. Validate all participants have site_id populated
5. Document rollback procedures if needed

**Test Commands**:
```bash
# Backend tests
bun test tests/convex/participants/

# All tests
bun test

# From project root (ALWAYS run from root)
pwd  # Verify: /Users/davidcruwys/dev/clients/supportsignal/app.supportsignal.com.au
```

### Technical Constraints

**Schema Deployment Order** [Source: docs/prd/epic-7.md - Migration Strategy]:

**CRITICAL**: This story implements Phase 3 of the Epic 7 migration:

**Prerequisites** (Already completed in Story 7.3):
- ✅ Phase 1: Sites table created and deployed
- ✅ Phase 2: Primary sites created for all companies

**Story 7.4 Implementation Order**:
1. **Schema Update**: Add `site_id` to participants table
2. **Deploy Schema**: `bunx convex deploy` (development first)
3. **Migration**: Run `linkToPrimarySites` mutation to populate site_id for existing participants
4. **Validation**: Verify all participants have site_id
5. **Frontend Implementation**: Build participant creation and listing UI

**Convex Deployment Commands**:
```bash
# Development
bunx convex deploy

# Production (after development testing)
CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex deploy

# Run migration (development)
bunx convex run participants/migration:linkToPrimarySites

# Run migration (production)
CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex run participants/migration:linkToPrimarySites
```

**Validation Rules**:
- All fields required: first name, last name, NDIS number, DOB, support level, site
- NDIS number format: Basic 9-digit validation (format: 123456789)
- Site must belong to the company (validate company_id matches)
- Site must exist before creating participants
- Support level must be one of: high, medium, low

**Error Handling** [Source: docs/patterns/backend-patterns.md, Story 7.3]:
```typescript
import { ConvexError } from 'convex/values';

// Structured error messages for clean frontend display
throw new ConvexError({
  message: 'Site not found or does not belong to this company',
  code: 'INVALID_SITE'
});

throw new ConvexError({
  message: 'NDIS number must be 9 digits',
  code: 'INVALID_NDIS_NUMBER'
});

throw new ConvexError({
  message: 'All fields are required: first name, last name, NDIS number, DOB, support level, site',
  code: 'MISSING_REQUIRED_FIELDS'
});
```

**NDIS Number Validation**:
- Format: 9 digits (e.g., 123456789)
- Basic validation: `/^\d{9}$/`
- May need enhancement for real NDIS number format in future

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 7 requirements | Bob (Scrum Master) |
| 2025-10-10 | 1.1 | Added auto-selection logic for single-site companies (AC: 5) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results

### Pattern Compliance Review
_To be populated after implementation_

### Knowledge Capture Reference
_To be populated after KDD process completion_

### Velocity Data
_To be populated after story completion_
