# Story 7.4: Initial Participant Setup (System Admin)

## Status
Completed

**Completion Date:** October 11, 2025

## Use Worktree
false

## Story
**As a** system administrator,
**I want** to quickly add 5-10 sample participants with basic NDIS information and site assignments to a newly created company,
**so that** the company can immediately start using the incident capture workflow.

## Acceptance Criteria

1. **Schema Update**: Add `site_id` field to participants table with required indexes
2. **Participant Form**: System admin interface at `/admin/companies/{id}/participants/create`
3. **Basic Fields**: First name, last name, NDIS number, DOB, support level
4. **Site Selection**: Dropdown showing company's sites (required field)
5. **Auto-Selection Logic**: If company has only one site, automatically default to that site; if multiple sites, require manual selection
6. **Site Validation**: Cannot create participant without selecting a site
7. **Company Association**: Participants automatically linked to correct company
8. **NDIS Number Validation**: Basic format validation for NDIS numbers
9. **Success Feedback**: Confirmation after participant creation using toast notifications
10. **Participant List**: View created participants with site information
11. **Site Filter**: Filter participants by site in listing
12. **Migration Script**: Link all existing participants to their company's Primary site

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**Medium-High**

### Estimated Time
**3-4 days**

### Risk Level
**Medium**

**Risk Factors:**
- Schema migration complexity (adding site_id to existing participants)
- Data migration for existing participants (linking to Primary sites)
- Site dropdown population and validation
- NDIS number format validation requirements

**Mitigation Strategies:**
- Follow established migration pattern from Story 7.3
- Use existing sites created in Story 7.3
- Implement comprehensive validation before allowing participant creation
- Test migration script on development environment before production

## Tasks / Subtasks

### Phase 1: Schema Update and Migration (AC: 1, 11)
- [x] **Task 1.1**: Update participants schema in `apps/convex/schema.ts`
  - [x] Add `site_id: v.optional(v.id("sites"))` field (optional for migration compatibility)
  - [x] Add index: `by_site` on `site_id`
  - [x] Add index: `by_company_and_site` on `company_id` and `site_id`
  - [x] Deploy schema changes to Convex development
  - [x] Verify schema deployment using Convex dashboard
- [x] **Task 1.2**: Create migration script for existing participants
  - [x] Create file: `apps/convex/participants/migration.ts`
  - [x] Implement `linkToPrimarySites` internalMutation
  - [x] For each participant without `site_id`:
    - Query participant's `company_id`
    - Find company's Primary site
    - Update `participant.site_id` with Primary site ID
  - [x] Log all migration operations for audit trail
  - [x] Return summary: { updated: number, skipped: number, total: number }
- [x] **Task 1.3**: Test and run migration
  - [x] Run migration in development: `bunx convex run participants/migration:linkToPrimarySites`
  - [x] Verify all participants have `site_id` populated
  - [x] Check Convex dashboard for data integrity
  - [x] Run migration in production when ready

### Phase 2: Backend CRUD Functions (AC: 3, 4, 5, 6, 7)
- [x] **Task 2.1**: Create `apps/convex/participants/admin.ts` for system admin operations
  - [x] `listParticipants(sessionToken, companyId, siteId?)` query
    - System admin auth check
    - Optional site filtering
    - Include site information in response
    - Sort by last_name, first_name
  - [x] `createParticipant(sessionToken, companyId, siteId, firstName, lastName, ndisNumber, dateOfBirth, supportLevel)` mutation
    - System admin permission check
    - Validate all required fields
    - Validate NDIS number format (basic format check)
    - Validate site belongs to company
    - Set created_at, created_by, updated_at, updated_by
    - Return participant ID
  - [x] `getParticipantById(sessionToken, participantId)` query
    - System admin auth
    - Include site information
  - [x] All functions use `requirePermission` with `PERMISSIONS.MANAGE_COMPANY`
- [x] **Task 2.2**: Implement validation logic
  - [x] NDIS number format validation (basic 9-digit format)
  - [x] Site validation (site must belong to company)
  - [x] Required field validation (first name, last name, DOB, support level, site)
  - [x] Clear ConvexError messages for validation failures
- [x] **Task 2.3**: Test backend functions
  - [x] Test participant creation with valid data
  - [x] Test validation failures (missing fields, invalid NDIS number, wrong site)
  - [x] Test list participants with and without site filter
  - [x] Test get participant by ID

### Phase 3: Frontend Participant List (AC: 9, 10)
- [x] **Task 3.1**: Create participant list page at `apps/web/app/admin/companies/[id]/participants/page.tsx`
  - [x] Use `export const runtime = 'edge';` for Cloudflare Pages
  - [x] System admin auth protection
  - [x] Query participants using `api['participants/admin'].listParticipants`
  - [x] Display table with columns: Name, NDIS Number, DOB, Support Level, Site, Status
  - [x] Add "Add Participant" button
  - [x] Add site filter dropdown (All Sites + individual sites)
  - [x] Link to participant creation page
- [x] **Task 3.2**: Add navigation tab to company admin interface
  - [x] Update company layout to include "Participants" tab
  - [x] Tab should appear alongside "Users" and "Sites" tabs
  - [x] Show participant count badge if possible

### Phase 4: Frontend Participant Creation Form (AC: 2, 3, 4, 5, 6, 7, 8, 9)
- [x] **Task 4.1**: Create participant creation page at `apps/web/app/admin/companies/[id]/participants/create/page.tsx`
  - [x] Use `export const runtime = 'edge';` for Cloudflare Pages
  - [x] System admin auth protection
  - [x] Form fields:
    - First Name (required, text input)
    - Last Name (required, text input)
    - NDIS Number (required, text input with format hint)
    - Date of Birth (required, date picker)
    - Support Level (required, dropdown: high/medium/low)
    - Site (required, dropdown populated from company's sites)
  - [x] Submit button: "Create Participant"
  - [x] Cancel button: Navigate back to participants list
- [x] **Task 4.2**: Implement form submission with validation
  - [x] Client-side validation for required fields
  - [x] NDIS number format validation
  - [x] Call `api['participants/admin'].createParticipant` mutation
  - [x] Handle success: `toast.success('Participant created successfully')`
  - [x] Handle errors: Extract clean message from `error.data?.message`
  - [x] Display errors using `toast.error(errorMessage)`
  - [x] Reset form and navigate to participants list on success
- [x] **Task 4.3**: Implement site dropdown with auto-selection logic (AC: 5)
  - [x] Query company's sites using `api['sites/admin'].listSites`
  - [x] Display site names in dropdown
  - [x] **Auto-selection**: If company has exactly 1 site, automatically set as default value
  - [x] **Manual selection**: If company has 2+ sites, require user to select from dropdown
  - [x] Show "No sites available" message if company has no sites
  - [x] Make site field required (cannot submit without selection)
  - [x] Use `useEffect` to auto-populate siteId when sites query returns single site
  - [x] Clear validation error when auto-selecting site (bug fix)

### Phase 5: Testing and Validation (AC: All)
- [x] **Task 5.1**: Manual testing
  - [x] Create new participant with valid data
  - [x] Verify participant appears in list with correct site
  - [x] Test site filtering in participant list
  - [x] Test validation errors (missing fields, invalid NDIS number)
  - [x] Verify toast notifications appear correctly
  - [x] Test migration script with existing data
- [x] **Task 5.2**: Edge case testing
  - [x] Company with no sites (should prevent participant creation)
  - [x] Invalid NDIS number formats
  - [x] Duplicate NDIS numbers (validation implemented)
  - [x] Site dropdown with many sites (10+ sites)

## Documentation Impact Assessment

**Architectural Patterns**:
- Migration script pattern for adding required foreign keys to existing data
- Multi-step form validation pattern (client + server)
- Site-based filtering and organization pattern
- NDIS number validation pattern

**Documentation Updates**:
- May need pattern documentation for data migration with required foreign keys
- Example of site dropdown population and validation
- NDIS number format validation rules and pattern

**Knowledge Capture**:
- Migration strategy for adding required relationships to existing data
- Site-based participant organization approach
- System admin CRUD patterns for participants

## Dev Notes

### Previous Story Insights

**From Story 7.3 (Site Management)**:
- Successfully implemented site management CRUD operations
- All companies now have at least one site (Primary site created)
- Sites table structure: `{ company_id, name, created_at, created_by, updated_at }`
- Migration pattern established: `internalMutation` returns summary object
- Toast notifications configured: `<Toaster richColors position="top-right" />` in layout
- Bracket notation required for subdirectory APIs: `api['sites/admin'].listSites`

**Key Learning from Story 7.3**:
- Check foundational infrastructure before complex solutions (Toaster component must exist)
- Use ConvexError with structured messages: `{ message, code }`
- Frontend error extraction: `error.data?.message || 'Fallback message'`
- Edge runtime export required: `export const runtime = 'edge';`

### Pattern Validation

**Established Patterns to Follow**:

1. **Convex Subdirectory API Pattern** [Source: docs/patterns/backend-patterns.md]
   ```typescript
   // Frontend: Use bracket notation with .default for subdirectory exports
   const participants = useQuery(api['participants/admin'].listParticipants, { ... });
   const createParticipant = useMutation(api['participants/admin'].createParticipant);
   ```

2. **Migration Script Pattern** [Source: Story 7.3, apps/convex/sites/migration.ts]
   ```typescript
   export const linkToPrimarySites = internalMutation({
     args: {},
     handler: async (ctx) => {
       // 1. Query entities needing migration
       // 2. For each entity, update with required relationship
       // 3. Log operations for audit trail
       // 4. Return summary: { updated, skipped, total }
     }
   });
   ```

3. **Toast Notification Pattern** [Source: docs/patterns/sonner-toast-configuration.md]
   ```typescript
   import { toast } from 'sonner';

   try {
     await createParticipant({ ... });
     toast.success('Participant created successfully');
   } catch (error: any) {
     const errorMessage = error.data?.message || 'Failed to create participant';
     toast.error(errorMessage);
   }
   ```

4. **Authentication Pattern** [Source: docs/patterns/backend-patterns.md]
   ```typescript
   import { requirePermission, PERMISSIONS } from '../permissions';

   export const createParticipant = mutation({
     args: { sessionToken: v.string(), ... },
     handler: async (ctx, args) => {
       const { user } = await requirePermission(
         ctx,
         args.sessionToken,
         PERMISSIONS.MANAGE_COMPANY
       );
       // ... participant creation logic
     }
   });
   ```

### Data Models

**Participants Table Schema** (UPDATED for Story 7.4):
```typescript
participants: defineTable({
  company_id: v.id("companies"),
  site_id: v.id("sites"),              // NEW FIELD - REQUIRED
  first_name: v.string(),
  last_name: v.string(),
  date_of_birth: v.string(),
  ndis_number: v.string(),
  contact_phone: v.optional(v.string()),
  emergency_contact: v.optional(v.string()),
  support_level: v.union(
    v.literal("high"),
    v.literal("medium"),
    v.literal("low")
  ),
  care_notes: v.optional(v.string()),
  status: v.union(
    v.literal("active"),
    v.literal("inactive"),
    v.literal("discharged")
  ),
  created_at: v.number(),
  created_by: v.id("users"),
  updated_at: v.number(),
  updated_by: v.id("users"),
})
  .index("by_company", ["company_id"])
  .index("by_site", ["site_id"])                    // NEW INDEX
  .index("by_company_and_site", ["company_id", "site_id"])  // NEW INDEX
  .index("by_ndis_number", ["ndis_number"])
  .index("by_status", ["status"])
  .index("by_name", ["last_name", "first_name"])
```

**Sites Table Schema** [Source: apps/convex/schema.ts - Story 7.3]:
```typescript
sites: defineTable({
  company_id: v.id("companies"),
  name: v.string(),
  created_at: v.number(),
  created_by: v.id("users"),
  updated_at: v.optional(v.number()),
})
  .index("by_company", ["company_id"])
  .index("by_name", ["company_id", "name"])
```

### API Specifications

**Backend Functions Location**: `apps/convex/participants/admin.ts`

**Function Signatures**:

```typescript
// List participants for a company with optional site filter
export const listParticipants = query({
  args: {
    sessionToken: v.string(),
    companyId: v.id("companies"),
    siteId: v.optional(v.id("sites"))
  },
  handler: async (ctx, args) => {
    // Returns: Array<Participant & { site: Site }>
  }
});

// Create new participant
export const createParticipant = mutation({
  args: {
    sessionToken: v.string(),
    companyId: v.id("companies"),
    siteId: v.id("sites"),
    firstName: v.string(),
    lastName: v.string(),
    ndisNumber: v.string(),
    dateOfBirth: v.string(),
    supportLevel: v.union(v.literal("high"), v.literal("medium"), v.literal("low"))
  },
  handler: async (ctx, args) => {
    // Returns: { participantId: Id<"participants"> }
  }
});

// Get participant by ID with site info
export const getParticipantById = query({
  args: {
    sessionToken: v.string(),
    participantId: v.id("participants")
  },
  handler: async (ctx, args) => {
    // Returns: Participant & { site: Site }
  }
});
```

**Migration Function** [Source: docs/prd/epic-7.md]:
```typescript
// apps/convex/participants/migration.ts
export const linkToPrimarySites = internalMutation({
  args: {},
  handler: async (ctx) => {
    // 1. Query all participants
    // 2. For each participant without site_id:
    //    - Find participant's company_id
    //    - Find company's Primary site
    //    - Update participant.site_id = primary_site._id
    // 3. Return { updated: number, skipped: number, total: number }
  }
});
```

### Component Specifications

**Participant List Page**: `apps/web/app/admin/companies/[id]/participants/page.tsx`

```typescript
'use client';
export const runtime = 'edge';

export default function ParticipantsListPage({ params }: { params: { id: string } }) {
  const { user, sessionToken } = useAuth();
  const companyId = params.id as Id<'companies'>;
  const [selectedSiteId, setSelectedSiteId] = useState<Id<'sites'> | null>(null);

  // Queries
  const company = useQuery(
    api['companies/getCompanyDetails'].default,
    { sessionToken: sessionToken || '', companyId }
  );

  const sites = useQuery(
    api['sites/admin'].listSites,
    { sessionToken: sessionToken || '', companyId }
  );

  const participants = useQuery(
    api['participants/admin'].listParticipants,
    {
      sessionToken: sessionToken || '',
      companyId,
      siteId: selectedSiteId || undefined
    }
  );

  // UI Components: Table, Site Filter Dropdown, Add Participant Button
}
```

**Participant Creation Page**: `apps/web/app/admin/companies/[id]/participants/create/page.tsx`

```typescript
'use client';
export const runtime = 'edge';

export default function CreateParticipantPage({ params }: { params: { id: string } }) {
  const { user, sessionToken } = useAuth();
  const companyId = params.id as Id<'companies'>;

  // Form state
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    ndisNumber: '',
    dateOfBirth: '',
    supportLevel: 'medium' as 'high' | 'medium' | 'low',
    siteId: '' as Id<'sites'> | ''
  });

  // Queries
  const sites = useQuery(
    api['sites/admin'].listSites,
    { sessionToken: sessionToken || '', companyId }
  );

  // Auto-select site if company has exactly one site (AC: 5)
  useEffect(() => {
    if (sites && sites.length === 1 && !formData.siteId) {
      setFormData(prev => ({ ...prev, siteId: sites[0]._id }));
    }
  }, [sites, formData.siteId]);

  // Mutations
  const createParticipant = useMutation(api['participants/admin'].createParticipant);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    try {
      await createParticipant({
        sessionToken: sessionToken!,
        companyId,
        siteId: formData.siteId as Id<'sites'>,
        firstName: formData.firstName.trim(),
        lastName: formData.lastName.trim(),
        ndisNumber: formData.ndisNumber.trim(),
        dateOfBirth: formData.dateOfBirth,
        supportLevel: formData.supportLevel
      });

      toast.success('Participant created successfully');
      router.push(`/admin/companies/${companyId}/participants`);
    } catch (error: any) {
      const errorMessage = error.data?.message || 'Failed to create participant';
      toast.error(errorMessage);
    }
  };

  // UI Components:
  // - Form with validation
  // - Site dropdown (auto-populated if single site, manual selection if multiple)
  // - Submit/Cancel buttons
}
```

### File Locations

**Backend Files**:
- `apps/convex/participants/admin.ts` - CRUD operations for participant management
- `apps/convex/participants/migration.ts` - Migration script for linking participants to sites
- `apps/convex/schema.ts` - Update participants table definition (add site_id field and indexes)

**Frontend Files**:
- `apps/web/app/admin/companies/[id]/participants/page.tsx` - Participant list page
- `apps/web/app/admin/companies/[id]/participants/create/page.tsx` - Participant creation page

**Test Files** [Source: docs/testing/technical/test-strategy-and-standards.md]:
- `tests/convex/participants/admin.test.ts` - Backend function tests
- `tests/convex/participants/migration.test.ts` - Migration script tests

### Testing

**Testing Standards** [Source: docs/testing/technical/test-strategy-and-standards.md]:

**Test Location**: All tests go in centralized `tests/` directory, NOT in app directories

**Backend Testing**:
- Location: `tests/convex/participants/`
- Framework: Jest with Convex testing utilities
- Coverage: CRUD operations, validation rules, migration script
- Key scenarios:
  - Create participant with valid data
  - Validation failures (missing site, invalid NDIS number)
  - Site relationship validation (site must belong to company)
  - Migration script idempotency (run twice, should skip already updated)
  - List participants with and without site filter

**Frontend Testing**:
- Location: `tests/web/admin/participants/` (if needed for complex components)
- Framework: Jest + React Testing Library
- Use path aliases: `@/components` not `../../../../apps/web/components`
- Pragmatic testing: Test behavior, not implementation details

**Migration Testing Strategy**:
1. Test in development first with existing data
2. Verify idempotency (run twice, should skip already updated participants)
3. Check Convex dashboard for data integrity
4. Validate all participants have site_id populated
5. Document rollback procedures if needed

**Test Commands**:
```bash
# Backend tests
bun test tests/convex/participants/

# All tests
bun test

# From project root (ALWAYS run from root)
pwd  # Verify: /Users/davidcruwys/dev/clients/supportsignal/app.supportsignal.com.au
```

### Technical Constraints

**Schema Deployment Order** [Source: docs/prd/epic-7.md - Migration Strategy]:

**CRITICAL**: This story implements Phase 3 of the Epic 7 migration:

**Prerequisites** (Already completed in Story 7.3):
- ✅ Phase 1: Sites table created and deployed
- ✅ Phase 2: Primary sites created for all companies

**Story 7.4 Implementation Order**:
1. **Schema Update**: Add `site_id` to participants table
2. **Deploy Schema**: `bunx convex deploy` (development first)
3. **Migration**: Run `linkToPrimarySites` mutation to populate site_id for existing participants
4. **Validation**: Verify all participants have site_id
5. **Frontend Implementation**: Build participant creation and listing UI

**Convex Deployment Commands**:
```bash
# Development
bunx convex deploy

# Production (after development testing)
CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex deploy

# Run migration (development)
bunx convex run participants/migration:linkToPrimarySites

# Run migration (production)
CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex run participants/migration:linkToPrimarySites
```

**Validation Rules**:
- All fields required: first name, last name, NDIS number, DOB, support level, site
- NDIS number format: Basic 9-digit validation (format: 123456789)
- Site must belong to the company (validate company_id matches)
- Site must exist before creating participants
- Support level must be one of: high, medium, low

**Error Handling** [Source: docs/patterns/backend-patterns.md, Story 7.3]:
```typescript
import { ConvexError } from 'convex/values';

// Structured error messages for clean frontend display
throw new ConvexError({
  message: 'Site not found or does not belong to this company',
  code: 'INVALID_SITE'
});

throw new ConvexError({
  message: 'NDIS number must be 9 digits',
  code: 'INVALID_NDIS_NUMBER'
});

throw new ConvexError({
  message: 'All fields are required: first name, last name, NDIS number, DOB, support level, site',
  code: 'MISSING_REQUIRED_FIELDS'
});
```

**NDIS Number Validation**:
- Format: 9 digits (e.g., 123456789)
- Basic validation: `/^\d{9}$/`
- May need enhancement for real NDIS number format in future

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | 1.0 | Story created from Epic 7 requirements | Bob (Scrum Master) |
| 2025-10-10 | 1.1 | Added auto-selection logic for single-site companies (AC: 5) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Timeline
- **Start Date:** October 10, 2025
- **Completion Date:** October 11, 2025
- **Total Duration:** ~2 days

### Key Commits
- `18482d7` - feat(Story 7.4): fix Select dropdown reactivity issues and add date validation
- `c8d3deb` - fix: make site_id optional for migration compatibility
- `2109b3b` - fix(7.4): clear site validation error when auto-selecting single site
- `26b1b37` - feat(Story 7.4): add comprehensive logging (debug - removed later)
- `d53f1cd` - fix(Story 7.4): resolve TypeScript errors in participant logging
- `204f5c3` - chore(Story 7.4): remove debug logging from participant pages

### Debug Log References
No persistent debug logs - added comprehensive logging for troubleshooting validation bug, then removed after fix verified.

### Completion Notes

**Implementation Approach:**
- Schema made site_id optional (not required) for migration compatibility
- Migration script links existing participants to Primary sites
- Auto-selection logic automatically selects site when company has only one site
- Validation error clearing added to prevent premature error display

**Key Challenges Resolved:**
1. **Validation Bug:** "Please select a site" error appearing even when site was auto-selected
   - **Solution:** Added error cleanup to auto-selection useEffect
2. **Schema Migration:** Ensuring backward compatibility while adding required relationship
   - **Solution:** Made site_id optional, used migration script to populate
3. **TypeScript Deep Inference:** TS2589 errors with Convex nested types
   - **Solution:** Applied `@ts-nocheck` directive per established pattern

**Testing:**
- Manual testing completed in both development and production environments
- User confirmed successful testing: "I was pretty happy with it"
- All validation scenarios tested (missing fields, invalid NDIS, duplicate numbers)
- Site filtering and auto-selection logic verified working

**Security Fix Applied (Story 7.5 - October 13, 2025)**:
- **Issue**: Cross-tenant permission vulnerability - used `PERMISSIONS.MANAGE_COMPANY` which company_admin role has
- **Impact**: Company admin from Company A could manage participants in Company B
- **Fix**: Changed all permission checks to `PERMISSIONS.MANAGE_ALL_COMPANIES` (system admin only)
- **Files Updated**: `apps/convex/participants/admin.ts`
- **Functions Fixed**: createParticipant, listParticipants, getParticipantById, updateParticipant, deleteParticipant
- **Verification**: System admin access works, company_admin access properly blocked

### File List

**Backend Files Created/Modified:**
- `apps/convex/participants/admin.ts` - System admin CRUD operations (create, list, get, update, delete)
- `apps/convex/participants/migration.ts` - Migration script for linking participants to Primary sites
- `apps/convex/schema.ts` - Updated participants table with site_id field and indexes

**Frontend Files Created:**
- `apps/web/app/admin/companies/[id]/participants/page.tsx` - Participant list page with site filtering
- `apps/web/app/admin/companies/[id]/participants/create/page.tsx` - Participant creation form with auto-selection
- `apps/web/app/admin/companies/[id]/participants/[participantId]/edit/page.tsx` - Participant edit form

**Total Lines Changed:** ~2,500 lines (additions + modifications)

## QA Results

### Pattern Compliance Review

**✅ All Patterns Followed Correctly:**

1. **Convex Subdirectory API Pattern**
   - Used bracket notation: `api['participants/admin'].listParticipants`
   - Proper .default exports for subdirectory modules

2. **Migration Script Pattern**
   - internalMutation with summary return object
   - Idempotent design (skips already-migrated participants)
   - Comprehensive logging for audit trail

3. **Toast Notification Pattern**
   - Success: `toast.success('Participant created successfully')`
   - Error: Clean message extraction from `error.data?.message`

4. **Authentication Pattern**
   - All functions use `requirePermission` with `PERMISSIONS.MANAGE_COMPANY`
   - Proper session token validation

5. **Edge Runtime Export**
   - All pages include `export const runtime = 'edge';`
   - Cloudflare Pages compatibility maintained

6. **TypeScript Pragmatic Approach**
   - `@ts-nocheck` directive applied for Convex deep type inference issues
   - Placed before 'use client' directive per established pattern

### Acceptance Criteria Verification

✅ **All 12 acceptance criteria met and verified:**
- [x] AC 1: Schema Update (site_id + indexes)
- [x] AC 2: Participant Form (/admin/companies/{id}/participants/create)
- [x] AC 3: Basic Fields (first name, last name, NDIS, DOB, support level)
- [x] AC 4: Site Selection (dropdown with company sites)
- [x] AC 5: Auto-Selection Logic (single site auto-select)
- [x] AC 6: Site Validation (required field)
- [x] AC 7: Company Association (automatic linking)
- [x] AC 8: NDIS Number Validation (9-digit format)
- [x] AC 9: Success Feedback (toast notifications)
- [x] AC 10: Participant List (view with site info)
- [x] AC 11: Site Filter (filter by site dropdown)
- [x] AC 12: Migration Script (linkToPrimarySites)

### Knowledge Capture Reference

**Lessons Learned Documentation:**
- [`docs/lessons-learned/auto-selection-validation-error-bug.md`](../../lessons-learned/auto-selection-validation-error-bug.md) - Premature validation error on auto-populated form fields (Story 7.4 bug fix)
- [`docs/lessons-learned/typescript-directive-ordering.md`](../../lessons-learned/typescript-directive-ordering.md) - @ts-nocheck must come before 'use client' directive

**Example Documentation:**
- [`docs/examples/optional-foreign-key-migration.md`](../../examples/optional-foreign-key-migration.md) - Complete pattern for adding required foreign keys to existing data with zero downtime

**Summary:**
Three key patterns captured from Story 7.4 implementation - auto-selection validation clearing, TypeScript directive ordering, and optional foreign key migration strategy.

### Velocity Data

**Story Points:** 8
**Actual Duration:** 2 days
**Velocity:** 4 points/day

**Estimation Accuracy:** On target (estimated 3-4 days, completed in 2 days)

**Contributing Factors:**
- Well-defined acceptance criteria from Epic 7 planning
- Established patterns from Story 7.3 (sites management)
- Clear prerequisites and dependencies identified upfront
- Effective debugging approach (comprehensive logging, then cleanup)
