# Story 2.6: User Management System

## Story Overview
**Title**: User Management System  
**Epic**: Epic 2 - Entity & Relationship Management  
**Priority**: HIGH  
**Status**: Draft  
**Estimated Effort**: 1 week  

## Story Statement

As a **company administrator**, I need a comprehensive user management system to create, edit, and manage users within my organization with proper role-based access control.

As a **system administrator**, I need global user management capabilities to oversee users across all companies while maintaining the ability to manage system administrator roles from the root company only.

As the **platform owner** (david@ideasmen.com.au), I need assurance that my account cannot be modified or deleted by any other user, maintaining system integrity.

## Business Context

User management is a foundational requirement for the SupportSignal platform. Without proper user management capabilities:
- Companies cannot onboard staff members efficiently
- Role-based access control cannot be properly maintained
- System administrators cannot provide oversight across companies
- The platform lacks essential administrative capabilities

This story delivers essential user management functionality while maintaining security through owner protection and proper role-based access control.

## Acceptance Criteria

### AC 2.6.1: Company-Level User Management
**Given** I am a company administrator or system administrator  
**When** I navigate to `/users/`  
**Then** I should see a user management interface for my company that allows me to:
- View all users in my company in a searchable, filterable table
- Create new users with role assignment (frontline_worker, team_lead, company_admin)
- Edit existing user details (name, email, role)
- Search users by name or email
- Filter users by role
- Delete users (except owner account)

### AC 2.6.2: Global System Admin User Management
**Given** I am a system administrator  
**When** I navigate to `/admin/users/`  
**Then** I should see a global user management interface that allows me to:
- View all users across all companies in a searchable, filterable table
- Search users globally by name or email
- Filter users by role and company
- Create/promote system administrators (only from root company)
- Remove/demote system administrators (except owner account)
- View user statistics and company distribution

### AC 2.6.3: Owner Account Protection
**Given** any user attempts to modify the owner account (david@ideasmen.com.au)  
**When** they try to change the role, delete the account, or modify critical details  
**Then** the system should:
- Block the operation with a clear error message
- Display "Owner" badge on the account in all interfaces
- Disable action buttons (delete, role change) for the owner account
- Log the attempted modification for security audit

### AC 2.6.4: Role-Based Access Control
**Given** users with different roles access user management features  
**When** they attempt various operations  
**Then** access should be controlled as follows:
- `frontline_worker`: No access to user management pages
- `team_lead`: No access to user management pages  
- `company_admin`: Full access to company user management (`/users/`), no access to global admin
- `system_admin`: Full access to both company and global user management

### AC 2.6.5: User Interface Requirements
**Given** any authorized user accesses user management interfaces  
**When** they use the system  
**Then** the interface should provide:
- Responsive design working on desktop and mobile
- Real-time form validation with clear error messages
- Auto-save functionality for form inputs
- Confirmation dialogs for destructive operations
- Loading states during operations
- Success/error notifications for all actions

## Critical Dev Notes

### Previous Story Context
Based on Epic 2 completion status:
- ✅ Story 2.0: UI Design System Foundation (COMPLETED)
- ✅ Story 2.1: Wizard Framework & Navigation (COMPLETED)  
- ✅ Story 2.2: Main Application Navigation & Layout Foundation (COMPLETED)
- ✅ Story 2.3: NDIS Participants Management (COMPLETED)
- ⏳ Story 2.4: Company Management (PENDING)
- ⏳ Story 2.5: System Administrator Impersonation System (PENDING)

**Dependencies**: This story can proceed independently as it leverages existing authentication and navigation infrastructure.

### Data Models

**Users Table** [Source: apps/convex/schema.ts#users]:
```typescript
users: defineTable({
  name: v.string(),
  email: v.string(),
  password: v.string(),
  profile_image_url: v.optional(v.string()),
  role: v.union(
    v.literal("system_admin"),
    v.literal("company_admin"), 
    v.literal("team_lead"),
    v.literal("frontline_worker")
  ),
  has_llm_access: v.optional(v.boolean()),
  company_id: v.optional(v.id("companies")),
})
  .index('by_email', ['email'])
  .index('by_company', ['company_id']),
```

**Companies Table** [Source: apps/convex/schema.ts#companies]:
```typescript
companies: defineTable({
  name: v.string(),
  contact_email: v.string(),
  status: v.union(v.literal("active"), v.literal("trial"), v.literal("suspended")),
  created_at: v.number(),
  created_by: v.optional(v.id("users")),
})
  .index("by_status", ["status"]),
```

### API Specifications

**Required Convex Functions** [Source: Epic 2 requirements and existing auth patterns]:

#### Company-Level User Management Functions:
```typescript
// apps/convex/users.ts
export const createUser = mutation({ ... })           // Create user in current company
export const updateUser = mutation({ ... })           // Edit user details  
export const updateRole = mutation({ ... })           // Change user role
export const listCompanyUsers = query({ ... })        // Get company users
export const searchCompanyUsers = query({ ... })      // Search within company
export const deleteUser = mutation({ ... })           // Soft delete user
```

#### System Admin Functions:
```typescript
// apps/convex/admin-users.ts  
export const listAllUsers = query({ ... })            // Global user directory
export const searchAllUsers = query({ ... })          // Global search
export const promoteToSystemAdmin = mutation({ ... }) // Create system_admin
export const demoteSystemAdmin = mutation({ ... })    // Demote system_admin
export const getUserStats = query({ ... })            // Basic statistics
```

#### Owner Protection Utilities:
```typescript
// apps/convex/lib/user-protection.ts
export const isOwner = (email: string): boolean => {
  return email === 'david@ideasmen.com.au';
};

export const validateUserModification = (user: User, operation: string) => {
  if (isOwner(user.email)) {
    throw new ConvexError(`Owner account cannot be ${operation}`);
  }
};
```

### Component Specifications

**Page Components** [Source: navigation-config.ts and existing page patterns]:
- `apps/web/app/users/page.tsx` - Company user management page
- `apps/web/app/admin/users/page.tsx` - Global user management page

**UI Components** [Source: existing participant management patterns]:
- `apps/web/components/users/UserTable.tsx` - Reusable user table component
- `apps/web/components/users/UserForm.tsx` - Create/edit user form
- `apps/web/components/users/RoleSelector.tsx` - Role assignment component
- `apps/web/components/users/UserSearchFilter.tsx` - Search and filter component
- `apps/web/components/users/OwnerBadge.tsx` - Owner account indicator

### File Locations

**Backend Files**:
- `apps/convex/users.ts` - Company-level user management functions
- `apps/convex/admin-users.ts` - System admin user management functions  
- `apps/convex/lib/user-protection.ts` - Owner protection utilities
- `apps/convex/lib/permissions.ts` - Role-based access validation (existing)

**Frontend Files**:
- `apps/web/app/users/page.tsx` - Company user management page (replace ComingSoon)
- `apps/web/app/admin/users/page.tsx` - Global user management page (replace ComingSoon)
- `apps/web/components/users/` - User management component directory
- `apps/web/types/user.ts` - User-related TypeScript interfaces

**Navigation Integration**: [Source: lib/navigation/navigation-config.ts]
- Navigation already configured with `/users/` and `/admin/users/` routes
- Role-based access control already implemented in navigation system

### Technical Constraints

**Security Requirements** [Source: architecture/coding-standards.md]:
- All operations must include correlation IDs for audit trails
- No direct `process.env` access - use configuration management
- TypeScript strict mode with no `any` types allowed
- Repository pattern for all data access operations

**Performance Requirements** [Source: Epic 2 quality standards]:
- <2 second response times for all user management operations
- Real-time form validation without blocking UI
- Efficient queries using existing indexes (by_company, by_email)

**Owner Protection Implementation** [Source: requirements]:
```typescript
// Example implementation pattern
export const updateUserRole = mutation({
  args: { userId: v.id("users"), newRole: v.string() },
  handler: async (ctx, { userId, newRole }) => {
    const user = await ctx.db.get(userId);
    if (!user) throw new ConvexError("User not found");
    
    // Owner protection check
    if (isOwner(user.email)) {
      throw new ConvexError("Owner role cannot be modified");
    }
    
    // Role validation and update logic
    // ...
  }
});
```

### Testing Requirements

**Unit Testing** [Source: architecture/testing-strategy.md]:
- Test all Convex functions with Jest
- Mock database operations for isolated testing
- Test owner protection logic extensively
- Validate role-based access control

**Integration Testing**:
- Test complete user management workflows
- Verify company isolation works correctly
- Test owner protection across all operations

**E2E Testing**:
- Test user creation and management flows
- Verify navigation and role-based access
- Test error handling and validation

### Dependencies & Integration

**Authentication Integration** [Source: existing auth system]:
- Leverages existing BetterAuth integration
- Uses existing session management and role validation
- Integrates with current permission system in `apps/convex/lib/permissions.ts`

**Navigation Integration** [Source: lib/navigation/navigation-config.ts]:
- Routes already configured in navigation system
- Role-based menu visibility already implemented
- UI foundation from completed Story 2.0 available

**Database Integration** [Source: apps/convex/schema.ts]:
- Uses existing users and companies tables
- No schema changes required
- Leverages existing indexes for performance

## Tasks and Subtasks

### Task 2.6.1: Backend User Management Functions
**Acceptance Criteria**: AC 2.6.1, AC 2.6.2, AC 2.6.3

#### Subtask 2.6.1.1: Implement Company-Level User Functions
- Create `apps/convex/users.ts` with CRUD operations
- Implement company isolation using `company_id` filtering
- Add input validation using Zod schemas
- **Unit Testing**: Test all functions with mocked database operations

#### Subtask 2.6.1.2: Implement System Admin Functions  
- Create `apps/convex/admin-users.ts` with global user operations
- Implement system admin promotion/demotion logic
- Add user statistics and reporting functions
- **Unit Testing**: Test admin-specific operations and constraints

#### Subtask 2.6.1.3: Implement Owner Protection System
- Create `apps/convex/lib/user-protection.ts` utility functions
- Add owner validation to all destructive operations
- Implement audit logging for protection events
- **Unit Testing**: Test owner protection across all scenarios

### Task 2.6.2: Frontend User Management Interface
**Acceptance Criteria**: AC 2.6.1, AC 2.6.4, AC 2.6.5

#### Subtask 2.6.2.1: Create Reusable User Components
- Implement `UserTable.tsx` with search/filter capabilities
- Create `UserForm.tsx` for create/edit operations
- Build `RoleSelector.tsx` with validation
- **Unit Testing**: Test component rendering and user interactions

#### Subtask 2.6.2.2: Implement Company User Management Page
- Replace `/users/page.tsx` ComingSoon with functional interface
- Integrate with backend user functions
- Add form validation and error handling
- **Integration Testing**: Test complete user management workflow

#### Subtask 2.6.2.3: Implement Global Admin User Management Page
- Replace `/admin/users/page.tsx` ComingSoon with admin interface
- Add global search and company filtering
- Implement system admin management features
- **Integration Testing**: Test admin operations and role restrictions

### Task 2.6.3: Owner Protection UI Implementation
**Acceptance Criteria**: AC 2.6.3, AC 2.6.5

#### Subtask 2.6.3.1: Create Owner Protection Components
- Implement `OwnerBadge.tsx` for visual indication
- Add protection logic to action buttons
- Create protected operation confirmation dialogs
- **Unit Testing**: Test protection UI states and interactions

#### Subtask 2.6.3.2: Integrate Protection Across Interfaces
- Add owner detection to both user management pages
- Implement disabled states for protected operations
- Add clear error messaging for blocked actions
- **E2E Testing**: Test owner protection in real user scenarios

### Task 2.6.4: Role-Based Access Control Integration
**Acceptance Criteria**: AC 2.6.4

#### Subtask 2.6.4.1: Implement Page-Level Access Control
- Add role validation to page components
- Integrate with existing navigation permission system
- Implement redirect logic for unauthorized access
- **Integration Testing**: Test access control across all user roles

#### Subtask 2.6.4.2: Function-Level Permission Validation
- Add role checks to all Convex functions
- Implement operation-specific permission logic
- Add comprehensive error handling for unauthorized operations
- **Unit Testing**: Test permission validation for each role and operation

### Task 2.6.5: Testing and Quality Assurance
**Acceptance Criteria**: All ACs

#### Subtask 2.6.5.1: Comprehensive Unit Testing
- Achieve >90% test coverage for all new functions
- Test edge cases and error conditions
- Validate owner protection and role-based access
- **Deliverable**: Complete test suite with coverage report

#### Subtask 2.6.5.2: End-to-End Testing
- Test complete user management workflows
- Verify cross-browser compatibility
- Test responsive design on mobile devices
- **Deliverable**: E2E test suite covering all user scenarios

## Definition of Done

- [ ] All Convex functions implemented and tested
- [ ] Both user management pages fully functional
- [ ] Owner protection working across all operations
- [ ] Role-based access control properly enforced
- [ ] Unit test coverage >90% for new code
- [ ] E2E tests covering all user workflows
- [ ] Code reviewed and approved
- [ ] Documentation updated for new functions
- [ ] Performance requirements met (<2 second response times)
- [ ] Accessibility requirements met (WCAG 2.1 AA)

## Risk Assessment

**High Risk**: Owner protection implementation - Critical that this cannot be bypassed
**Mitigation**: Comprehensive testing of all protection scenarios, multiple validation points

**Medium Risk**: Role-based access complexity across two interfaces  
**Mitigation**: Leverage existing permission system, clear separation of concerns

**Low Risk**: UI/UX consistency across management interfaces
**Mitigation**: Reusable components and existing design system

## Success Metrics

- **Functionality**: 100% of acceptance criteria met
- **Performance**: All operations complete in <2 seconds
- **Security**: 0 successful bypasses of owner protection in testing
- **Usability**: <5 minutes for admin to create new user account
- **Quality**: >90% test coverage, 0 critical bugs in production

---

**Story Status**: Draft  
**Created**: 2025-01-09  
**Epic**: Epic 2 - Entity & Relationship Management  
**Dependencies**: Epic 1 (Authentication System) ✅ COMPLETED