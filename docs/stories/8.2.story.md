# Story 8.2: Environment-Aware URL Configuration System

## Status
Read

## Story
**As a** system administrator,
**I want** all server functions to use environment-aware URL configuration instead of hardcoded localhost URLs,
**so that** production emails contain correct domain URLs and OAuth callbacks work properly in both environments.

## Acceptance Criteria

1. Create centralized configuration module for URL generation
2. Fix 7 server functions using wrong environment variables
3. Implement proper environment detection in Convex functions
4. Test email URLs in both environments
5. All hardcoded localhost URLs replaced with dynamic environment-aware configuration
6. Production emails contain `https://app.supportsignal.com.au` URLs
7. Development emails contain `http://localhost:3200` URLs
8. OAuth callbacks work correctly in both environments

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**Medium-High**

### Estimated Time
**3-4 days**

### Risk Level
**Medium**

**Risk Factors:**
- Multiple backend functions need updating
- Environment detection logic must be robust
- Risk of breaking existing functionality if not properly tested
- OAuth callback changes need careful coordination

## Tasks / Subtasks

- [ ] Task 1: Create centralized environment configuration module (AC: 1, 3)
  - [ ] Create `apps/convex/lib/environment.ts` with environment detection logic
  - [ ] Implement `getBaseUrl()` function with proper fallbacks
  - [ ] Add environment detection based on Convex deployment context
  - [ ] Export typed environment configuration object

- [ ] Task 2: Fix email system hardcoded URLs (AC: 2, 5, 6, 7)
  - [ ] Update `apps/convex/email.ts:14` to use environment configuration
  - [ ] Replace hardcoded localhost fallback with dynamic URL generation
  - [ ] Test password reset emails in both environments

- [ ] Task 3: Fix authentication OAuth callback URLs (AC: 2, 5, 8)
  - [ ] Update `apps/convex/auth.ts:611,1153,1266,1270,1299` with environment config
  - [ ] Replace 4 instances of hardcoded localhost URLs
  - [ ] Ensure OAuth redirect URIs use correct domain for each environment

- [ ] Task 4: Fix worker communication URLs (AC: 2, 5)
  - [ ] Update `apps/convex/workerSync.ts:9` to use environment configuration
  - [ ] Replace hardcoded worker URLs with environment-aware URLs

- [ ] Task 5: Implement comprehensive testing (AC: 4)
  - [ ] Test email URL generation in development environment
  - [ ] Test email URL generation in production environment
  - [ ] Test OAuth callbacks in both environments
  - [ ] Verify no hardcoded URLs remain in server functions

- [ ] Task 6: Documentation and deployment
  - [ ] Document environment configuration patterns in architecture docs
  - [ ] Deploy to both environments with proper testing
  - [ ] Verify production emails contain correct URLs

## Documentation Impact Assessment

**Architectural Patterns Established:**
- Environment-aware configuration pattern for server functions
- Centralized URL generation module pattern
- Environment detection in Convex backend functions

**Documentation Updates Needed:**
- Update `docs/architecture/error-handling-strategy.md` with final URL configuration patterns
- Create new section in architecture docs for environment configuration
- Document best practices for environment-aware server function development

**Knowledge Capture:**
- Patterns for detecting environment in Convex functions
- Best practices for centralized configuration management
- Testing strategies for multi-environment URL configuration

## Dev Notes

### Previous Story Insights
From Story 8.1 completion notes:
- **COMPLETE SEPARATION ACHIEVED**: All platforms configured with correct environment values
- **DEPLOYMENT METHODS DISCOVERED**: Convex Production via `bunx convex env set --prod`
- **KEY INSIGHT**: Environment separation requires coordinated updates across ALL platforms
- Production environment variables successfully set: `NEXT_PUBLIC_APP_URL=https://app.supportsignal.com.au`

### Critical Functions to Fix
[Source: Epic 8 Technical Requirements]

**1. Email System** - `apps/convex/email.ts:14`
- Current issue: Hardcoded `localhost:3000` fallback
- Required: Environment-aware URL generation

**2. Auth Callbacks** - `apps/convex/auth.ts:611,1153,1266,1270,1299`
- Current issue: 4 instances of hardcoded localhost URLs in OAuth configurations
- Required: Dynamic callback URL generation based on environment

**3. Worker Sync** - `apps/convex/workerSync.ts:9`
- Current issue: Hardcoded worker URLs
- Required: Environment-aware worker communication URLs

### Environment Configuration Requirements
[Source: Epic 8 Technical Requirements]

**Development Environment Variables:**
```
NEXT_PUBLIC_APP_URL=http://localhost:3200
NEXT_PUBLIC_CONVEX_URL=https://beaming-gull-639.convex.cloud
CONVEX_DEPLOYMENT=dev:beaming-gull-639
```

**Production Environment Variables:**
```
NEXT_PUBLIC_APP_URL=https://app.supportsignal.com.au
NEXT_PUBLIC_CONVEX_URL=https://graceful-shrimp-355.convex.cloud
CONVEX_DEPLOYMENT=prod:graceful-shrimp-355
```

### Coding Standards Compliance
[Source: docs/architecture/coding-standards.md]

**Environment Access Requirements:**
- **No Direct process.env**: Direct access to `process.env` is banned
- **Configuration Pattern**: Use centralized configuration management
- **TypeScript Strict Mode**: All code must be fully type-safe
- **Correlation IDs**: All logs must include correlation ID for traceability

### File Locations
[Source: docs/architecture/source-tree.md]
- **Convex functions**: `apps/convex/` directory
- **Convex utilities**: `apps/convex/lib/` directory
- **Configuration modules**: `apps/convex/lib/environment.ts` (to be created)

### Pattern Validation

**Environment Configuration Pattern:**
- Create centralized configuration module following repository pattern
- Implement environment detection without direct `process.env` access
- Use TypeScript strict typing for all configuration objects
- Include correlation IDs in environment-related logging

**URL Generation Pattern:**
- Dynamic URL generation based on environment detection
- Proper fallback strategies for local development
- Consistent API for URL generation across all server functions

### Testing

**Testing Standards:**
[Source: docs/testing/technical/test-strategy-and-standards.md]

**Test File Locations:**
- Unit tests: `tests/convex/lib/` for configuration modules
- Integration tests: `tests/convex/integration/` for cross-function testing
- All tests centralized in `tests/` directory, not app directories

**Testing Requirements:**
- Test environment detection logic
- Test URL generation in both environments
- Test OAuth callback URL generation
- Test email URL generation
- Mock environment variables for testing different scenarios

**Testing Frameworks:**
- Jest for unit and integration testing
- Centralized Jest configuration following established patterns
- Use `@ts-nocheck` pragmatically for TypeScript interface issues in tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation for environment-aware URL configuration system | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results

### Pattern Compliance Review
*To be populated by QA agent*

### Knowledge Capture
*To be populated by QA agent*

### Velocity Data
*To be populated by QA agent*