# Story 1.4: Core API Layer

## Status
Approved

## Story
**As a** backend developer,  
**I want** to implement comprehensive Convex queries, mutations, and actions that provide the complete API surface for both capture and analysis workflows,  
**so that** the SupportSignal platform has a complete, type-safe, and permission-aware API layer ready for frontend integration and real-time collaboration features.

## Acceptance Criteria
1. [ ] All API endpoints implemented with proper TypeScript definitions
2. [ ] Input validation using Convex validators with meaningful error messages
3. [ ] Permission checking integrated into all queries and mutations
4. [ ] Real-time subscriptions for workflow handoffs and collaborative features
5. [ ] Comprehensive error handling with user-friendly messages
6. [ ] API documentation with examples for frontend integration

## Estimation & Planning
- **Story Points**: 8
- **Estimated Complexity**: High
- **Estimated Time**: 1 week
- **Risk Level**: Medium

### Risk Factors
- API surface complexity with multiple workflow categories
- Permission integration with existing authentication system
- Real-time subscription complexity for collaborative features
- Comprehensive error handling across all endpoints
- Integration with existing database schema and authentication layers
- **Schema normalization impact**: Updating enum values affects existing data and code from Stories 1.2/1.3

## Tasks / Subtasks
- [ ] **Schema Normalization for Consistency** (AC: 1, 2, 5)
  - [ ] Update `incident_classifications` enum values to use lowercase snake_case convention
    - [ ] Change `incident_type` from `"Behavioural" | "Environmental" | "Medical" | "Communication" | "Other"` to `"behavioural" | "environmental" | "medical" | "communication" | "other"`
    - [ ] Change `severity` from `"Low" | "Medium" | "High"` to `"low" | "medium" | "high"`
  - [ ] Create data migration to update existing classification records in database
  - [ ] Update schema validation in `apps/convex/schema.ts` and `apps/convex/analysis.ts`
  - [ ] Update filtering logic in analysis operations to use new lowercase values
  - [ ] Update seed data and integration test fixtures to use normalized values
- [ ] Implement Incident Management APIs (AC: 1, 2, 3, 5)
  - [ ] `incidents.create`: Create new incident with metadata validation and permission checks
  - [ ] `incidents.getById`: Retrieve incident with user permission checking
  - [ ] `incidents.listByUser`: List incidents accessible to current user based on role
  - [ ] `incidents.updateStatus`: Update workflow status with state validation
  - [ ] `incidents.delete`: Soft delete with audit trail preservation
- [ ] Implement Narrative Management APIs (AC: 1, 2, 4, 5)
  - [ ] `narratives.create`: Initialize narrative content for new incident
  - [ ] `narratives.update`: Update narrative phase content with auto-save
  - [ ] `narratives.enhance`: Apply AI-enhanced content to narratives
  - [ ] `narratives.getConsolidated`: Retrieve complete narrative for analysis
- [ ] Implement Analysis APIs (AC: 1, 2, 3, 5)
  - [ ] `analysis.create`: Initialize analysis workflow for incident
  - [ ] `analysis.update`: Update contributing conditions analysis
  - [ ] `analysis.generateClassifications`: Create AI-powered incident classifications (using normalized enum values)
  - [ ] `analysis.complete`: Finalize analysis and mark incident complete
- [ ] Implement User & Session APIs (AC: 1, 2, 3, 4)
  - [ ] `users.getCurrent`: Get current user profile and permissions
  - [ ] `sessions.updateWorkflowState`: Persist wizard step progress
  - [ ] `sessions.recoverState`: Restore user's workflow state after login
- [ ] Implement real-time subscription features (AC: 4)
  - [ ] Real-time incident updates for collaborative editing
  - [ ] Workflow status change notifications
  - [ ] Live narrative updates during multi-user editing
- [ ] Add comprehensive error handling and validation (AC: 2, 5)
  - [ ] Input validation with Zod schemas for all endpoints (including normalized enum values)
  - [ ] ConvexError integration with user-friendly messages
  - [ ] Proper error logging with correlation IDs
- [ ] Create API documentation and integration examples (AC: 6)
  - [ ] TypeScript function signatures documentation (with updated enum types)
  - [ ] Frontend integration examples using normalized values
  - [ ] Error handling patterns documentation
- [ ] Add comprehensive testing and validation
  - [ ] Unit tests for all API functions with permission scenarios
  - [ ] Integration tests for complete API workflows
  - [ ] Schema migration testing to ensure data consistency
  - [ ] Real-time subscription testing
  - [ ] Error handling and edge case testing with new enum values

## Documentation Impact Assessment
- **Architectural patterns**: Convex API design patterns, real-time subscription patterns, permission-aware API design
- **Documentation updates needed**: 
  - `docs/patterns/backend-patterns.md` - Add comprehensive API design patterns
  - `docs/examples/backend/` - Create complete API implementation examples
  - `docs/architecture/api-implementation-details.md` - Update with actual function signatures
  - `docs/technical-guides/` - Create API integration guide for frontend teams
- **New knowledge to capture**: 
  - Permission-aware API design patterns
  - Real-time collaboration API patterns
  - Convex subscription optimization techniques
  - API error handling and user experience patterns

## Dev Notes

### Previous Story Context
[Source: docs/stories/1.3.story.md - Dev Agent Record]
- **Authentication System Complete**: Role-based permission system with 4-role hierarchy implemented
- **Permission Checking Functions**: `checkPermission` and `getUserPermissions` functions available in `apps/convex/permissions.ts`
- **Session Management**: Enhanced session management with workflow state persistence in `apps/convex/sessionManagement.ts`
- **Role Hierarchy**: system_admin > company_admin > team_lead > frontline_worker
- **Business Rule**: "Democratic Creation, Controlled Editing" - anyone can create incidents, controlled editing permissions
- **Testing Infrastructure**: Permission testing dashboard at `/dashboard` and comprehensive test user accounts

### Data Models & Schema Context
[Source: Actual Convex Database Schema via MCP]
**Core Tables Required for API Implementation**:
```typescript
// Existing tables from apps/convex/schema.ts:

Table users {
  _id: Id<"users">
  name: string
  email: string
  password: string
  profile_image_url?: string
  role: "system_admin" | "company_admin" | "team_lead" | "frontline_worker"
  has_llm_access?: boolean
  company_id?: Id<"companies">
  _creationTime: number
}

Table companies {
  _id: Id<"companies">
  name: string
  slug: string
  contact_email: string
  status: "active" | "trial" | "suspended"
  created_at: number
  created_by?: Id<"users">
  _creationTime: number
}

// EXISTING INCIDENT TABLES (already implemented in schema):

Table incidents {
  _id: Id<"incidents">
  company_id: Id<"companies">
  reporter_name: string
  participant_name: string
  event_date_time: string
  location: string
  capture_status: "draft" | "in_progress" | "completed"
  analysis_status: "not_started" | "in_progress" | "completed"
  overall_status: "capture_pending" | "analysis_pending" | "completed"
  created_at: number
  created_by?: Id<"users">
  updated_at: number
  narrative_hash?: string
  questions_generated: boolean
  narrative_enhanced: boolean
  analysis_generated: boolean
  _creationTime: number
}

Table incident_narratives {
  _id: Id<"incident_narratives">
  incident_id: Id<"incidents">
  before_event: string
  during_event: string
  end_event: string
  post_event: string
  before_event_extra?: string
  during_event_extra?: string
  end_event_extra?: string
  post_event_extra?: string
  consolidated_narrative?: string
  created_at: number
  updated_at: number
  enhanced_at?: number
  version: number
  _creationTime: number
}

Table incident_analysis {
  _id: Id<"incident_analysis">
  incident_id: Id<"incidents">
  contributing_conditions: string
  conditions_original?: string
  conditions_edited: boolean
  analyzed_at: number
  analyzed_by?: Id<"users">
  updated_at: number
  ai_analysis_prompt?: string
  ai_model?: string
  ai_confidence?: number
  ai_processing_time?: number
  analysis_status: "draft" | "ai_generated" | "user_reviewed" | "completed"
  revision_count: number
  total_edit_time?: number
  _creationTime: number
}

Table incident_classifications {
  _id: Id<"incident_classifications">
  incident_id: Id<"incidents">
  analysis_id: Id<"incident_analysis">
  classification_id: string
  incident_type: "behavioural" | "environmental" | "medical" | "communication" | "other"  // NORMALIZED: Updated to lowercase snake_case (was PascalCase)
  supporting_evidence: string
  severity: "low" | "medium" | "high"  // NORMALIZED: Updated to lowercase (was PascalCase)
  confidence_score: number
  user_reviewed: boolean
  user_modified: boolean
  review_notes?: string
  created_at: number
  updated_at: number
  classified_by?: Id<"users">
  ai_generated: boolean
  ai_model?: string
  original_ai_classification?: string
  _creationTime: number
}
```

### Technology Stack Context
[Source: docs/architecture/tech-stack.md]
**Core Technologies for API Implementation**:
- **Convex**: 1.12.x - Real-time backend platform with native query/mutation/action patterns
- **TypeScript**: 5.4.x - Type safety for all API function definitions
- **Zod**: 3.23.x - Schema validation and type enforcement for API inputs
- **Existing Auth**: Enhanced authentication system from Story 1.3 with role-based permissions

### API Implementation Context
[Source: docs/architecture/api-implementation-details.md]
**Current Convex Function Patterns** (to be implemented in this story):
```typescript
// Incident Management APIs
incidents.create(args: CreateIncidentArgs): Mutation<Id<"incidents">>
incidents.getById(args: { id: Id<"incidents"> }): Query<Incident | null>
incidents.listByUser(): Query<Incident[]>
incidents.updateStatus(args: UpdateStatusArgs): Mutation<void>
incidents.delete(args: { id: Id<"incidents"> }): Mutation<void>

// Narrative Management APIs (table: incident_narratives)
narratives.create(args: { incident_id: Id<"incidents"> }): Mutation<Id<"incident_narratives">>
narratives.update(args: UpdateNarrativeArgs): Mutation<void>
narratives.enhance(args: EnhanceNarrativeArgs): Action<void>
narratives.getConsolidated(args: { incident_id: Id<"incidents"> }): Query<ConsolidatedNarrative>

// Analysis APIs (table: incident_analysis)
analysis.create(args: { incident_id: Id<"incidents"> }): Mutation<Id<"incident_analysis">>
analysis.update(args: UpdateAnalysisArgs): Mutation<void>
analysis.generateClassifications(args: ClassificationArgs): Action<ClassificationResult>
analysis.complete(args: { analysis_id: Id<"incident_analysis"> }): Mutation<void>

// User & Session APIs
users.getCurrent(): Query<UserProfile | null>
sessions.updateWorkflowState(args: UpdateWorkflowStateArgs): Mutation<void>
sessions.recoverState(): Query<WorkflowState | null>
```

### File Locations Context
[Source: docs/architecture/source-tree.md]
**API Implementation File Locations**:
- `apps/convex/incidents.ts` - Incident management API functions (NEW)
- `apps/convex/narratives.ts` - Narrative management API functions (NEW)
- `apps/convex/analysis.ts` - Analysis workflow API functions (NEW)  
- `apps/convex/users.ts` - User management functions (EXISTS - enhance)
- `apps/convex/schema.ts` - Database schema (EXISTS - extend with new tables)
- `apps/convex/permissions.ts` - Permission checking (EXISTS - integrate)
- `apps/convex/sessionManagement.ts` - Session functions (EXISTS - integrate)

### Permission Integration Context
[Source: Story 1.3 Authentication System Implementation]
**Available Permission Functions**:
```typescript
// Permission checking pattern to integrate into all API functions
const permissionCheck = await ctx.db.query(api.permissions.checkPermission, {
  sessionToken,
  permission: "create_incident", // or relevant permission
  companyId: user.company_id // for multi-tenant scoping (matches schema field name)
});

if (!permissionCheck.allowed) {
  throw new ConvexError(permissionCheck.reason);
}
```

**Permission Matrix for API Functions**:
| API Function | System Admin | Company Admin | Team Lead | Frontline Worker |
|--------------|--------------|---------------|-----------|------------------|
| incidents.create | ✅ | ✅ | ✅ | ✅ |
| incidents.getById | ✅ | ✅ | ✅ | ✅ (own only) |
| incidents.listByUser | ✅ | ✅ | ✅ | ✅ (own only) |
| incidents.updateStatus | ✅ | ✅ | ❌ | ❌ |
| incidents.delete | ✅ | ✅ | ❌ | ❌ |
| narratives.* | ✅ | ✅ | ✅ | ✅ (own incidents) |
| analysis.* | ✅ | ✅ | ✅ | ❌ |
| users.getCurrent | ✅ | ✅ | ✅ | ✅ |
| sessions.* | ✅ | ✅ | ✅ | ✅ |

### Technical Constraints
[Source: docs/architecture/coding-standards.md]
- **No Any Policy**: Use of `any` type prohibited in API code
- **No Direct process.env**: Use centralized configuration management
- **Repository Pattern**: All data access must follow repository pattern
- **Correlation IDs**: All API requests must include correlation IDs for traceability
- **TypeScript Strict Mode**: All API code must be fully type-safe

### Schema Normalization Requirements
[Source: Identified inconsistency in current schema]
**Files requiring updates for enum normalization**:
- `apps/convex/schema.ts` - Update enum definitions (lines 320-333)
- `apps/convex/analysis.ts` - Update validation logic (lines 160-170, 210-221, 361-370)
- `apps/convex/seed.ts` - Update test data generation (around line 242)
- `scripts/run-integration-tests.ts` - Update integration test data (around line 1231)
- Database records - Create migration to convert existing `incident_classifications` records

**Conversion mapping**:
```typescript
// incident_type values:
"Behavioural" → "behavioural"
"Environmental" → "environmental" 
"Medical" → "medical"
"Communication" → "communication"
"Other" → "other"

// severity values:
"Low" → "low"
"Medium" → "medium"
"High" → "high"
```

### Real-Time Patterns Context
[Source: Convex Real-time Capabilities]
**Subscription Patterns for Collaborative Features**:
- **Query Subscriptions**: Automatic real-time updates when database changes
- **Multi-user Collaboration**: Live updates during simultaneous narrative editing
- **Workflow Notifications**: Real-time status change notifications across user roles
- **Permission-aware Subscriptions**: Ensure users only receive updates they're authorized to see

### Error Handling Patterns Context
[Source: docs/patterns/backend-patterns.md - Story 1.3 Implementation]
**ConvexError Integration Pattern**:
```typescript
// User-friendly error handling pattern
if (!validation.success) {
  throw new ConvexError(`Validation failed: ${validation.errors.join(", ")}`);
}

// Permission error pattern
if (!hasPermission) {
  throw new ConvexError("You don't have permission to perform this action");
}

// Resource not found pattern
if (!resource) {
  throw new ConvexError("Resource not found or you don't have access to it");
}
```

## Pattern Validation
- Follow existing Convex query/mutation/action patterns from current `apps/convex/` files
- Use permission checking patterns established in Story 1.3 authentication system
- Follow error handling patterns using ConvexError for user-facing messages
- Use correlation IDs for all operations to maintain audit trail consistency
- Integrate with existing session management and audit logging from Story 1.3
- Follow real-time subscription patterns for collaborative workflow features

## Testing
**Test Location**: `tests/convex/` directory (centralized testing pattern)
**Testing Framework**: Jest with Convex testing utilities

**Required Test Coverage**:
- **API Function Tests**: All queries, mutations, and actions with various permission scenarios
- **Permission Integration**: Role-based access control for all API endpoints
- **Real-time Subscriptions**: Collaborative features and live update scenarios
- **Error Handling**: Input validation, permission errors, and edge cases
- **Integration Tests**: Complete workflows spanning multiple API categories
- **Performance Tests**: API response times and subscription efficiency

**Testing Standards**:
- Use existing test user accounts from Story 1.3 for permission testing
- Mock AI service calls in analysis API testing
- Test real-time collaboration scenarios with multiple concurrent users
- Validate correlation ID tracking throughout API call chains

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-07 | 1.0 | Initial story creation with comprehensive API layer requirements, permission integration, and real-time collaboration features | Bob (SM) |
| 2025-08-07 | 1.1 | Updated with actual database schema via Convex MCP, added schema normalization requirements for enum consistency | Bob (SM) |
| 2025-08-07 | 1.2 | Story approved for development - comprehensive technical context and cross-story dependencies addressed | Bob (SM) |