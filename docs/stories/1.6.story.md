# Story 1.6: Remove BetterAuth Dependencies

## Status
**Done**

## Story
**As a** development team maintaining the SupportSignal codebase,
**I want** all BetterAuth dependencies and references removed from the codebase,
**so that** we have a clean, maintainable authentication system using only Convex Auth without leftover artifacts from the abandoned BetterAuth migration.

## Acceptance Criteria
1. [x] All BetterAuth code references removed from active codebase
2. [x] `better-auth` package removed from `package.json`
3. [x] Environment variables cleaned from `.env.local` and sync source
4. [x] Config file cleaned of unused `betterAuthSecret` and `betterAuthUrl` exports
5. [x] Schema comments updated to remove "BetterAuth" terminology
6. [x] All authentication methods verified working (email/password, GitHub OAuth, Google OAuth)
7. [x] No TypeScript errors or build failures after removal
8. [x] Documentation updated to reflect Convex Auth as chosen solution

## Estimation & Planning

### Story Points
**3** (Low-Medium complexity, methodical removal process)

### Estimated Complexity
**Low-Medium** - Straightforward removal but requires methodical testing at each phase

### Estimated Time
2-3 hours

### Risk Level
**Low** - Minimal BetterAuth integration means low risk, but systematic verification required

### Risk Factors
- **Authentication Regression**: While BetterAuth remnants appear unused, must verify no hidden dependencies
- **Build Pipeline Impact**: Package removal could expose unexpected dependencies
- **Environment Configuration**: Must ensure environment sync doesn't reintroduce removed variables

### Mitigation Strategy
- 4-phase progressive removal with verification after each phase
- Test all authentication methods before and after each phase
- Maintain git checkpoints for easy rollback if needed

## Tasks / Subtasks

- [x] **Phase 1: Remove Unused Code References** (AC: 1, 4, 5)
  - [x] Remove `betterAuthSecret` and `betterAuthUrl` from `apps/web/lib/config.ts`
  - [x] Update schema comments in `apps/convex/schema.ts` (lines 45, 55)
  - [x] Run typecheck and lint validation
  - [x] Verify all auth methods still work

- [x] **Phase 2: Remove Environment Variables** (AC: 3)
  - [x] Remove `BETTER_AUTH_SECRET` from `apps/web/.env.local`
  - [x] Check environment sync source (`~/.env-configs/app.supportsignal.com.au.env`)
  - [x] Run typecheck and lint validation
  - [x] Verify all auth methods still work

- [x] **Phase 3: Remove Package Dependency** (AC: 2, 7)
  - [x] Remove `"better-auth": "^1.2.12"` from `apps/web/package.json`
  - [x] Run `bun install` to update lockfile
  - [x] Run `bun run build` to verify production build
  - [x] Run typecheck and lint validation
  - [x] Verify all auth methods still work

- [x] **Phase 4: Update Documentation** (AC: 8)
  - [x] Add historical note to Epic 1 explaining BetterAuth decision
  - [x] Update `docs/technical-guides/authentication-architecture.md` if it exists
  - [x] Review and update any other docs mentioning BetterAuth (19 files found)
  - [x] Keep historical story docs for audit trail

- [x] **Final Verification** (AC: 6, 7)
  - [x] Email/password authentication test
  - [x] GitHub OAuth authentication test
  - [x] Google OAuth authentication test
  - [x] Run full CI verification suite
  - [x] Confirm no TypeScript errors or build failures

## Documentation Impact Assessment

### Architectural Patterns
- **Progressive Dependency Removal Pattern**: This story establishes a reusable pattern for safely removing unused dependencies through phased removal with verification gates
- **Authentication System Consolidation**: Documents the decision to use Convex Auth over BetterAuth, providing future reference for authentication architecture choices

### Documentation Updates Required
- `docs/architecture/authentication-architecture.md` - Document Convex Auth as the chosen solution
- `docs/patterns/progressive-dependency-removal.md` - Potentially create if this pattern proves valuable
- `docs/lessons-learned/authentication-system-selection-kdd.md` - Capture decision-making process

### Knowledge Capture Opportunities
- **Why Convex Auth was chosen over BetterAuth** - Technical and architectural rationale
- **How to safely remove dependencies** - Systematic approach with verification gates
- **Authentication testing checklist** - Reusable verification steps for auth changes

### Examples to Create
- Configuration cleanup examples showing before/after state
- Environment variable management best practices
- Authentication testing verification script (if created)

## Dev Notes

### Relevant Context

**BetterAuth Migration History**:
- Story 1.6 (original) attempted BetterAuth migration but was abandoned
- Discovery: Convex Auth already provided all required functionality
- Only minimal BetterAuth artifacts remain (5 items)
- No actual BetterAuth integration was completed

**Current Authentication Architecture** (from Story 1.3):
- **Primary System**: Convex Auth for all authentication
- **Supported Methods**: Email/password, GitHub OAuth, Google OAuth
- **Session Management**: Convex sessions table
- **OAuth Storage**: Convex accounts table for GitHub/Google providers

**BetterAuth Remnants Identified** (Complete List):
1. Package dependency: `better-auth: ^1.2.12` in `apps/web/package.json`
2. Environment variable: `BETTER_AUTH_SECRET` in `apps/web/.env.local`
3. Config export: `betterAuthSecret` in `apps/web/lib/config.ts`
4. Config export: `betterAuthUrl` in `apps/web/lib/config.ts`
5. Schema comments: "BetterAuth sessions table" and "BetterAuth accounts table" in `apps/convex/schema.ts`

### Relevant Source Tree

```
apps/web/
├── package.json                # Contains better-auth dependency
├── .env.local                  # Contains BETTER_AUTH_SECRET
└── lib/
    └── config.ts              # Exports betterAuthSecret and betterAuthUrl

apps/convex/
└── schema.ts                   # Contains BetterAuth comments (lines 45, 55)
```

### Pattern Validation

**Progressive Removal Pattern** (New Pattern - To Be Documented):
This story introduces a 4-phase progressive removal pattern for safely removing dependencies:

1. **Phase 1: Code References** - Remove unused code exports and comments (no functional impact)
2. **Phase 2: Environment Variables** - Remove configuration values (low risk)
3. **Phase 3: Package Dependencies** - Remove npm packages (medium risk - requires build verification)
4. **Phase 4: Documentation** - Update documentation for historical context

**Verification Gates**: After each phase, run:
- `bun run typecheck` - TypeScript validation
- `bun run lint` - Code quality validation
- Manual auth testing - All authentication methods
- `bun run build` - Production build (Phase 3+)

**Rollback Strategy**: Git commit after each successful phase for easy rollback

### Testing Standards

**Test Location**: No new test files required for this story (removal only)

**Testing Approach**: Manual verification testing after each phase

**Required Verification Tests**:
1. **Email/Password Authentication**:
   - Login with valid credentials
   - Logout
   - Session persistence check

2. **GitHub OAuth Authentication**:
   - GitHub login flow
   - Account linking verification
   - Logout and session cleanup

3. **Google OAuth Authentication**:
   - Google login flow
   - Account linking verification
   - Logout and session cleanup

4. **Build Verification**:
   - `bun run typecheck` - Must pass with 0 errors
   - `bun run lint` - Must pass with 0 warnings
   - `bun run build` - Must complete successfully (Phase 3+)

**Testing Framework**: Manual testing for authentication workflows, automated for build verification

**Test Standards Reference**: Follow `docs/testing/technical/test-strategy-and-standards.md` for CI verification requirements

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Story created - BetterAuth removal | Bob (Scrum Master) |
| 2025-10-05 | 1.1 | Story implementation completed | James (Dev Agent) |
| 2025-10-05 | 1.2 | Story signed off - Done | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929) - James (Dev Agent)

### Debug Log References
No debug logs required - straightforward removal story

### Completion Notes List
- ✅ All 4 phases completed successfully with validation gates
- ✅ Phase 1: Removed config exports and updated schema comments
- ✅ Phase 2: Removed environment variables from .env.local and sync source
- ✅ Phase 3: Removed package dependency, updated lockfile, verified build
- ✅ Phase 4: Updated Epic 1 and authentication architecture documentation
- ✅ Final verification: TypeScript, lint, build all pass
- ✅ No BetterAuth references remain in codebase
- Note: One edit retry needed in Phase 1 (config.ts) - successfully resolved

### File List
**Modified Files**:
- `apps/web/lib/config.ts` - Removed betterAuthSecret and betterAuthUrl exports
- `apps/convex/schema.ts` - Updated comments (BetterAuth → Convex Auth)
- `apps/web/.env.local` - Removed BETTER_AUTH_SECRET variable
- `~/.env-configs/app.supportsignal.com.au.env` - Removed BetterAuth section
- `apps/web/package.json` - Removed better-auth dependency
- `docs/prd/epic-1.md` - Added historical note about BetterAuth decision
- `docs/technical-guides/authentication-architecture.md` - Updated to reflect Convex Auth as final solution
- `apps/web/bun.lockb` - Updated after package removal

## QA Results

### Pattern Compliance Review
_To be populated after story completion_

### Knowledge Capture Reference
_To be populated after KDD knowledge capture process_

### Velocity Data
_To be populated after story completion_
