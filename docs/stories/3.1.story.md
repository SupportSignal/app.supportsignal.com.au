# Story 3.1: Metadata & Narrative Collection

## Story Overview
**Title**: Metadata & Narrative Collection  
**Epic**: Epic 3 - Incident Capture Workflow  
**Priority**: CRITICAL  
**Status**: Ready  
**Estimated Effort**: 1 week  

## Story Statement

As a **frontline support worker**, I need to quickly capture essential incident metadata and detailed narrative descriptions across multiple phases, so that I can comprehensively document incidents while the details are fresh in my memory.

As a **disability care provider**, I need a structured incident reporting interface that guides me through capturing all required information, so that I can ensure compliance with NDIS reporting requirements without missing critical details.

## Business Context

Story 3.1 establishes the foundation of the incident capture workflow by implementing the first two critical steps: metadata collection and multi-phase narrative input. This story transforms the chaotic post-incident moment into a structured, guided process that ensures no critical information is lost.

**Key Business Drivers**:
- **Compliance Foundation**: Captures all required NDIS incident metadata fields
- **Cognitive Load Reduction**: Structured approach reduces mental burden during stressful post-incident reporting
- **Information Completeness**: Multi-phase narrative structure ensures comprehensive incident documentation
- **Real-time Validation**: Immediate feedback prevents incomplete submissions and reduces rework

This story enables frontline workers to move from chaotic, incomplete incident notes to structured, comprehensive incident documentation that forms the foundation for subsequent AI-powered analysis and enhancement.

## Acceptance Criteria

### AC 3.1.1: Incident Metadata Collection (Step 1)
**Given** I am an authenticated frontline worker starting an incident report  
**When** I navigate to the incident capture workflow  
**Then** I should see a metadata collection form that includes:
- **Reporter Name**: Pre-filled from authenticated user profile, editable for proxy reporting scenarios
- **Participant Selection**: Searchable dropdown of company's NDIS participants with auto-completion
- **Event Date/Time**: Date and time picker with current timezone, defaulting to current date/time
- **Location**: Text input field for incident location with suggestions for common company locations
- Form validation with clear success/error states for all fields
- Auto-save functionality that preserves entries as I type
- Progress indication showing this is Step 1 of 7

### AC 3.1.2: Multi-Phase Narrative Collection (Step 2)
**Given** I have completed the metadata collection step  
**When** I proceed to narrative collection  
**Then** I should see a 2x2 grid layout containing four narrative phases:
- **Before Event**: Large text area for describing conditions/context leading up to the incident
- **During Event**: Large text area for describing what happened during the incident
- **End Event**: Large text area for describing how the incident concluded or was resolved
- **Post-Event Support**: Large text area for describing immediate support provided after the incident
- Each text area should be clearly labeled and provide generous space for detailed descriptions
- Real-time character count and guidance on minimum content requirements
- Auto-save functionality for all narrative phases

### AC 3.1.3: Form Validation & User Guidance
**Given** I am completing the metadata and narrative forms  
**When** I interact with form fields and navigation  
**Then** the system should provide:
- Real-time validation with clear, actionable error messages
- Visual indicators (âœ“/âŒ) showing field completion status
- Requirement that at least one narrative phase contains meaningful content (minimum 50 characters)
- Disabled "Continue" button until minimum requirements are met
- Clear indication of which fields are required vs. optional
- Graceful error handling if auto-save fails, with retry mechanisms

### AC 3.1.4: Responsive Design & Mobile Optimization
**Given** I am using the incident capture workflow on various devices  
**When** I access the form on desktop, tablet, or mobile  
**Then** the interface should:
- Maintain full functionality across all screen sizes
- Use responsive 2x2 grid that adapts to single column on mobile devices
- Provide touch-friendly input elements on mobile devices
- Maintain readable text sizes and adequate touch targets
- Preserve auto-save functionality across all devices
- Handle virtual keyboard interactions without breaking layout

### AC 3.1.5: Progress Tracking & Navigation
**Given** I am working through the incident capture workflow  
**When** I need to understand my progress or navigate between steps  
**Then** I should see:
- Clear progress indicator showing "Step 1 of 7" and "Step 2 of 7"
- Breadcrumb navigation showing current position in workflow
- Ability to navigate back to Step 1 from Step 2 without losing data
- Visual confirmation when each step is completed successfully
- Clear "Continue to Next Step" button that's only enabled when requirements are met

## Critical Dev Notes

### Epic Dependencies Context
**Epic 2 Dependencies** (MUST be completed first):
- âœ… **Story 2.0**: UI Design System Foundation (COMPLETED) - Provides component library
- âœ… **Story 2.1**: Wizard Framework & Navigation (COMPLETED) - Provides step-by-step workflow structure
- âœ… **Story 2.2**: Main Application Navigation & Layout Foundation (COMPLETED) - Provides authenticated layout
- ðŸŸ¡ **Story 2.3**: NDIS Participants Management (PENDING) - **CRITICAL DEPENDENCY** for participant dropdown

**Epic 1 Dependencies** (Available):
- âœ… Authentication system for user identification and reporter name pre-filling
- âœ… Database schema with incidents table and related structures
- âœ… Auto-save mechanisms and real-time data persistence

### Data Models

**Incidents Table** [Source: apps/convex/schema.ts#incidents]:
```typescript
incidents: defineTable({
  reporter_name: v.string(),
  participant_id: v.id("participants"),
  participant_name: v.string(),
  event_date_time: v.string(),
  location: v.string(),
  
  // Multi-phase narratives
  narrative_before_event: v.optional(v.string()),
  narrative_during_event: v.optional(v.string()),
  narrative_end_event: v.optional(v.string()),
  narrative_post_event_support: v.optional(v.string()),
  
  // Metadata
  company_id: v.id("companies"),
  reporter_user_id: v.id("users"),
  workflow_step: v.number(),
  status: v.union(
    v.literal("draft"),
    v.literal("narrative_complete"),
    v.literal("questions_generated"),
    v.literal("enhancement_complete"),
    v.literal("submitted")
  ),
  created_at: v.number(),
  updated_at: v.number(),
})
  .index("by_company", ["company_id"])
  .index("by_reporter", ["reporter_user_id"])
  .index("by_participant", ["participant_id"])
  .index("by_status", ["status"]),
```

**Participants Integration** [Source: Epic 2 Story 2.3]:
```typescript
participants: defineTable({
  first_name: v.string(),
  last_name: v.string(),
  ndis_number: v.string(),
  company_id: v.id("companies"),
  status: v.union(v.literal("active"), v.literal("inactive")),
})
  .index("by_company", ["company_id"])
  .index("by_ndis_number", ["ndis_number"]),
```

### API Specifications

**Required Convex Functions**:

#### Incident Management Functions:
```typescript
// apps/convex/incidents.ts
export const createIncident = mutation({
  args: {
    reporter_name: v.string(),
    participant_id: v.id("participants"),
    event_date_time: v.string(),
    location: v.string(),
  },
  handler: async (ctx, args) => {
    // Create new incident in draft status with Step 1 complete
    // Auto-fill participant_name from participant_id lookup
    // Set workflow_step to 1, status to "draft"
  }
});

export const updateIncidentNarratives = mutation({
  args: {
    incident_id: v.id("incidents"),
    narrative_before_event: v.optional(v.string()),
    narrative_during_event: v.optional(v.string()),
    narrative_end_event: v.optional(v.string()),
    narrative_post_event_support: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    // Update narrative fields with auto-save
    // Update workflow_step to 2 when narratives are complete
    // Set status to "narrative_complete" when ready to proceed
  }
});

export const getIncidentDraft = query({
  args: { incident_id: v.id("incidents") },
  handler: async (ctx, { incident_id }) => {
    // Retrieve incident for editing/continuation
    // Include all metadata and narrative phases
  }
});
```

#### Participant Integration Functions:
```typescript
// apps/convex/participants.ts (from Epic 2)
export const listActiveParticipants = query({
  args: { company_id: v.id("companies") },
  handler: async (ctx, { company_id }) => {
    // Return active participants for dropdown selection
    // Format: { id, display_name, ndis_number }
  }
});
```

### Component Specifications

**Page Components**:
- `apps/web/app/incidents/capture/page.tsx` - Main incident capture workflow page
- Integration with existing wizard framework from Story 2.1

**UI Components**:
- `apps/web/components/incidents/IncidentMetadataForm.tsx` - Step 1 metadata collection
- `apps/web/components/incidents/NarrativeGrid.tsx` - Step 2 narrative collection
- `apps/web/components/incidents/ParticipantSelector.tsx` - Participant dropdown with search
- `apps/web/components/incidents/ProgressTracker.tsx` - Workflow progress indication
- `apps/web/components/incidents/AutoSaveIndicator.tsx` - Visual auto-save confirmation

### File Locations

**Frontend Implementation**:
- `apps/web/app/incidents/capture/page.tsx` - Main workflow page
- `apps/web/components/incidents/` - Component directory for incident capture
- `apps/web/lib/incidents/` - Client-side utilities and validation
- `apps/web/types/incident.ts` - TypeScript interfaces

**Backend Implementation**:
- `apps/convex/incidents.ts` - Incident CRUD operations
- `apps/convex/lib/incident-validation.ts` - Server-side validation utilities
- Integration with existing `apps/convex/participants.ts` from Epic 2

### Technical Constraints

**Form Validation Requirements** [Source: Epic 3 specifications]:
- Real-time validation without blocking user input
- Minimum 50 characters required in at least one narrative phase
- Date/time validation with timezone handling
- Reporter name validation allowing proxy reporting scenarios

**Auto-Save Implementation** [Source: performance requirements]:
- Save form state every 30 seconds or on field blur
- Visual indication of save status (saving, saved, error)
- Retry mechanism for failed save attempts
- Offline capability with sync when connection restored

**Responsive Design Standards** [Source: Epic 3 mobile requirements]:
- 2x2 grid converts to single column on screens <768px
- Touch targets minimum 44px height on mobile
- Virtual keyboard handling without layout disruption
- Maintains functionality across iOS and Android browsers

### Integration Points

**Wizard Framework Integration** [Source: Story 2.1]:
```typescript
// Integration with existing wizard framework
const IncidentCaptureWizard = () => {
  const steps = [
    { id: 1, title: "Incident Details", component: IncidentMetadataForm },
    { id: 2, title: "Narrative Collection", component: NarrativeGrid },
    // Steps 3-7 will be added in subsequent stories
  ];
  
  return <WizardFramework steps={steps} />;
};
```

**Authentication Integration** [Source: Epic 1]:
- Pre-fill reporter name from authenticated user session
- Validate user permissions for incident creation
- Associate incident with user's company for participant filtering

**Participant Management Integration** [Source: Epic 2 Story 2.3]:
- Participant dropdown populated from company's active participants
- Auto-complete search functionality for large participant lists
- Real-time participant name resolution from selected ID

### Testing Requirements

**Unit Testing**:
- Test incident creation and narrative update functions
- Test form validation logic and error states
- Test auto-save mechanisms and retry logic
- Test participant selection and search functionality

**Integration Testing**:
- Test complete Step 1 and Step 2 workflow
- Test navigation between steps with data preservation
- Test responsive design across device sizes
- Test auto-save persistence across browser sessions

**E2E Testing**:
- Test complete incident metadata and narrative collection workflow
- Test error handling for network interruptions
- Test mobile device functionality and virtual keyboard handling
- Test participant selection with various company sizes

## Tasks and Subtasks

### Task 3.1.1: Backend Incident Management Implementation
**Acceptance Criteria**: AC 3.1.1, AC 3.1.2, AC 3.1.3

#### Subtask 3.1.1.1: Implement Incident CRUD Functions
- Create `apps/convex/incidents.ts` with createIncident and updateIncidentNarratives mutations
- Implement getIncidentDraft query for workflow continuation
- Add server-side validation for all incident fields
- **Unit Testing**: Test all functions with mocked database operations

#### Subtask 3.1.1.2: Integrate Participant Management
- Connect to existing participant management system from Epic 2
- Implement participant lookup and validation
- Add participant name auto-population from selection
- **Integration Testing**: Test participant integration with company isolation

#### Subtask 3.1.1.3: Implement Auto-Save Infrastructure
- Add background auto-save functionality with retry logic
- Implement draft state management and recovery
- Add audit trail for incident creation and updates
- **Unit Testing**: Test auto-save reliability and error recovery

### Task 3.1.2: Frontend Form Implementation
**Acceptance Criteria**: AC 3.1.1, AC 3.1.2, AC 3.1.5

#### Subtask 3.1.2.1: Create Incident Metadata Form
- Implement `IncidentMetadataForm.tsx` with all required fields
- Add real-time validation and user feedback
- Integrate with participant selector component
- **Unit Testing**: Test form rendering and validation logic

#### Subtask 3.1.2.2: Create Narrative Grid Component
- Implement `NarrativeGrid.tsx` with responsive 2x2 layout
- Add auto-save integration for all narrative phases
- Implement character counting and content validation
- **Unit Testing**: Test grid responsiveness and narrative handling

#### Subtask 3.1.2.3: Integrate Wizard Framework
- Connect forms to existing wizard navigation from Story 2.1
- Implement step progression logic and validation
- Add progress tracking and breadcrumb navigation
- **Integration Testing**: Test complete workflow navigation

### Task 3.1.3: Responsive Design & Mobile Optimization
**Acceptance Criteria**: AC 3.1.4

#### Subtask 3.1.3.1: Implement Responsive Layout
- Ensure 2x2 grid adapts to mobile single-column layout
- Optimize touch interactions for mobile devices
- Test virtual keyboard handling and layout preservation
- **Cross-browser Testing**: Verify functionality across iOS and Android browsers

#### Subtask 3.1.3.2: Mobile-Specific Optimizations
- Implement touch-friendly form controls and buttons
- Optimize auto-save for mobile network conditions
- Add offline capability with sync when connection restored
- **Performance Testing**: Verify mobile performance meets <2 second requirements

### Task 3.1.4: Testing and Quality Assurance
**Acceptance Criteria**: All ACs

#### Subtask 3.1.4.1: Comprehensive Testing Suite
- Achieve >90% test coverage for new incident capture functionality
- Test error handling and edge cases for all workflows
- Validate responsive design across all target devices
- **Deliverable**: Complete test suite with coverage report

#### Subtask 3.1.4.2: User Experience Validation
- Test workflow completion times (target <15 minutes)
- Validate form usability and error message clarity
- Test auto-save reliability under various network conditions
- **Deliverable**: UX test results and performance metrics

## Definition of Done

- [x] All Convex incident management functions implemented and tested
- [x] Incident metadata form fully functional with validation
- [x] Multi-phase narrative grid responsive across all devices
- [x] Participant integration working with Epic 2 dependencies
- [x] Auto-save functionality reliable and user-friendly
- [x] Wizard framework integration complete with progress tracking
- [x] Unit test coverage >90% for new incident capture code
- [x] Integration testing covering complete Steps 1-2 workflow
- [x] E2E testing including mobile device functionality
- [x] Performance requirements met (<2 second form interactions)
- [x] Code reviewed and meets TypeScript strict mode standards

## Risk Assessment

**High Risk**: Epic 2 dependency on participant management (Story 2.3)  
**Mitigation**: Story 2.3 must be completed before Story 3.1 development begins

**Medium Risk**: Auto-save reliability during network interruptions  
**Mitigation**: Implement robust retry logic and offline capability with sync

**Medium Risk**: Mobile virtual keyboard layout disruption  
**Mitigation**: Extensive testing across iOS and Android devices with keyboard handling

**Low Risk**: Form validation complexity across multiple phases  
**Mitigation**: Leverage existing validation patterns and comprehensive testing

## Success Metrics

- **Functionality**: 100% of acceptance criteria met
- **Performance**: All form interactions complete in <2 seconds
- **Data Integrity**: 0 data loss incidents during auto-save operations
- **User Experience**: <5 minutes to complete Steps 1-2 of incident capture
- **Quality**: >90% test coverage, 0 critical bugs in production testing

---

**Story Status**: Complete âœ… IMPLEMENTED  
**Created**: 2025-01-10  
**Completed**: 2025-08-10  
**Epic**: Epic 3 - Incident Capture Workflow  
**Dependencies**: Epic 1 (Authentication, Database) âœ… COMPLETED, Epic 2 Story 2.3 (Participants) âœ… COMPLETED

## Implementation Summary

**Completed Tasks**:
- âœ… Task 3.1.1: Backend Incident Management Implementation
- âœ… Task 3.1.2: Frontend Form Implementation  
- âœ… Task 3.1.3: Responsive Design & Mobile Optimization
- âœ… Task 3.1.4: Testing and Quality Assurance

**Key Deliverables**:
- Working 2-step incident capture workflow with metadata collection and narrative input
- Responsive design that adapts from 2x2 grid to single column on mobile devices
- Auto-save functionality with visual feedback indicators
- Integration with existing participant management system
- Real-time form validation and error handling
- Complete TypeScript implementation with strict mode compliance
- Full test coverage and CI pipeline verification

**Implementation Files**:
- `apps/convex/incidents.ts` - Backend incident management functions
- `apps/web/components/incidents/IncidentCaptureWorkflow.tsx` - Main workflow orchestrator
- `apps/web/components/incidents/IncidentMetadataForm.tsx` - Step 1 metadata collection
- `apps/web/components/incidents/NarrativeGrid.tsx` - Step 2 narrative collection
- `apps/web/app/incidents/page.tsx` - Updated incidents page integration