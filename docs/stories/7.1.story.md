# Story 7.1: Company Creation & Onboarding Workflow

## Status
Ready

## Story
**As a** system administrator,
**I want** to create new companies with authenticated workflows and automatic onboarding,
**so that** I can efficiently onboard new organizations without manual database manipulation and ensure new companies are operational within 24 hours.

## Acceptance Criteria

1. **Company Creation Form**: System admin interface at `/admin/companies/create`
2. **Authenticated Backend**: Upgrade `createCompany` function with system admin authentication
3. **Automatic Slug Generation**: URL-friendly company identifiers with conflict resolution
4. **Initial Admin Setup**: Assign first company administrator during creation
5. **Welcome Email**: Automated welcome email using existing Resend service
6. **Input Validation**: Comprehensive validation for company name, email, and admin details
7. **Error Handling**: Graceful handling of duplicate names, invalid emails, auth failures
8. **Success Confirmation**: Clear feedback on successful company creation

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**Medium-High**

### Estimated Time
**4-5 days**

### Risk Level
**Medium**

**Risk Factors:**
- Integration with existing authentication system
- Email service integration reliability
- Database constraint handling for unique slugs
- Cross-system coordination (Convex + Cloudflare Worker)

## Tasks / Subtasks

- [ ] **Backend Implementation** (AC: 2, 3, 4, 5)
  - [ ] Upgrade `companies.createCompany` function with authentication checks
  - [ ] Implement automatic slug generation with conflict resolution
  - [ ] Add initial admin assignment logic
  - [ ] Integrate welcome email functionality with existing Cloudflare Worker
  - [ ] Add comprehensive input validation and error handling

- [ ] **Frontend Implementation** (AC: 1, 6, 8)
  - [ ] Create company creation form at `/admin/companies/create`
  - [ ] Implement form validation and error display
  - [ ] Add success confirmation and feedback
  - [ ] Ensure proper authentication checks for system admin access

- [ ] **Integration Testing** (AC: 5, 7)
  - [ ] Test email service integration with various email providers
  - [ ] Verify error handling for edge cases (duplicate names, invalid emails)
  - [ ] Test complete workflow from form submission to welcome email

- [ ] **Documentation** (AC: All)
  - [ ] Update API documentation for enhanced createCompany function
  - [ ] Document company onboarding workflow process

## Documentation Impact Assessment

**Architectural Patterns:**
- **Multi-tenant company creation** patterns with authentication
- **Slug generation and conflict resolution** patterns
- **Cross-service integration** patterns (Convex + Cloudflare Worker)
- **Admin interface** patterns for system-level operations

**Documentation Updates Needed:**
- `docs/architecture/api-implementation-details.md` - New company creation API patterns
- `docs/patterns/backend-patterns.md` - Authentication and validation patterns
- `docs/examples/backend/` - Company creation implementation examples
- `docs/technical-guides/` - Company onboarding workflow guide

**Knowledge Capture:**
- Email service integration patterns
- Slug generation algorithms and conflict resolution
- System admin authentication patterns
- Multi-tenant data isolation during creation

**Examples to Create:**
- Complete company creation workflow implementation
- Email service integration patterns
- Admin interface authentication patterns

## Dev Notes

### Architecture Context

**Multi-Tenant Foundation:**
This story builds upon the existing multi-tenant architecture established in Epic 1. The current system includes:
- `companies` table with `name`, `slug`, `contact_email`, `status` fields
- User-company associations via `company_id` for multi-tenant isolation
- 5-tier role system (`system_admin` â†’ `frontline_worker`)
- Existing basic `companies.createCompany` function (no authentication)

**Integration Points:**
- **BetterAuth System**: Use existing authentication for system admin verification
- **Cloudflare Worker Email Service**: Existing deployed service at `https://supportsignal-email-with-resend.your-account.workers.dev`
- **Email Service API**: POST format `{to, name, message}`, response `{data: {id}, error}`

### Existing Infrastructure to Leverage

**Company Management:**
- Existing company management interfaces at `/company-management/` and `/admin/company-settings/`
- Available backend functions: `getCompanyById`, `getCompanyBySlug`, `listActiveCompanies`, `updateCompanyStatus`

**Authentication:**
- BetterAuth system with session management via `sessions` table
- Role-based access control with system admin permissions
- Password reset workflows via `password_reset_tokens` table

**Email Integration Code Pattern:**
```javascript
async function sendSupportEmail(to, name, message) {
  const response = await fetch('https://supportsignal-email-with-resend.your-account.workers.dev', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ to, name, message })
  });
  return await response.json();
}
```

### Technical Implementation Requirements

**Backend Functions to Implement:**
```typescript
// Enhanced company creation with authentication
companies.create.createCompanyWithAuth(name, contactEmail, adminEmail, adminName)
companies.onboarding.generateSlug(companyName)
companies.onboarding.sendWelcomeEmail(companyData, adminData)
```

**Database Considerations:**
- Slug uniqueness validation and conflict resolution
- Atomic operations for company + admin creation
- Proper foreign key relationships for company-user associations

**Email Service Integration:**
- Welcome email template for new companies
- Error handling for email delivery failures
- Integration testing across different email providers

### Pattern Validation

**Authentication Patterns:**
- Follow existing BetterAuth authentication patterns
- Use system admin role verification for company creation access
- Maintain session-based authentication throughout workflow

**Data Access Patterns:**
- Follow repository pattern for database operations
- Implement proper error handling and validation
- Use Convex's built-in validation with Zod schemas

**Frontend Patterns:**
- Use established ShadCN UI component patterns
- Follow Next.js App Router patterns for admin routes
- Implement proper form validation using react-hook-form + Zod

### Testing Standards

**Test Requirements:**
- **Location**: `tests/backend/` for Convex functions, `tests/web/integration/` for full workflow
- **Frameworks**: Jest for unit tests, Playwright for E2E admin workflow
- **Coverage**: Authentication, validation, error handling, email integration
- **Integration**: Test complete company creation workflow including email delivery

**Testing Patterns:**
- Mock email service for unit tests
- Use test company data for integration tests
- Verify authentication boundaries
- Test slug generation and conflict resolution

**Testing Standards Reference:**
- Follow patterns established in `docs/testing/technical/testing-patterns.md`
- Use centralized test configuration from `test-config/setup-test-env.js`
- Apply pragmatic testing approach (test behavior, not implementation details)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-19 | 1.0 | Initial story creation from Epic 7 requirements | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results

### Pattern Compliance Review
*To be populated by QA agent*

### Knowledge Capture
*To be populated by QA agent*

### Velocity Data
*To be populated by QA agent*