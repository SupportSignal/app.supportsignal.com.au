# Story 3.4: Workflow Auto-Completion

## Status
ON HOLD

## Story
**As a** frontline worker,  
**I want** incidents to automatically complete when I finish all workflow steps,  
**so that** they don't appear in my "continue workflow" modal and I have a clear understanding of what work is truly unfinished.

## Acceptance Criteria

1. **Automatic Status Update**: When user completes Step 8 (Consolidated Report), incident `overall_status` automatically changes from `"analysis_pending"` to `"ready_for_analysis"`
2. **Workflow Timestamp**: Set `workflow_completed_at` timestamp when auto-completion occurs  
3. **Modal Exclusion**: Workflow-complete incidents no longer appear in the workflow continuation modal
4. **Data Backfill**: Existing incidents that have completed Step 8 are retrospectively marked as `"ready_for_analysis"`
5. **Status Preservation**: Manual submission workflow (if implemented later) can still override this status
6. **Audit Trail**: All status changes are logged with user context and timestamps

## Estimation & Planning

### Story Points
3

### Estimated Complexity  
Low

### Estimated Time
1-2 days

### Risk Level
Low

## Tasks / Subtasks

- [ ] **Task 3.4.1: Update Consolidated Report Step Completion Logic** (AC: 1, 2)
  - [ ] Subtask 3.4.1.1: Modify ConsolidatedReportStep component to trigger auto-completion on workflow finish
  - [ ] Subtask 3.4.1.2: Add mutation call to update incident status when user completes final step
  - [ ] Subtask 3.4.1.3: Set workflow_completed_at timestamp during auto-completion

- [ ] **Task 3.4.2: Create Auto-Completion Backend Logic** (AC: 1, 2, 6)  
  - [ ] Subtask 3.4.2.1: Create `autoCompleteWorkflow` mutation in convex/incidents.ts
  - [ ] Subtask 3.4.2.2: Implement status change from `"analysis_pending"` to `"ready_for_analysis"`
  - [ ] Subtask 3.4.2.3: Add audit logging for automatic status changes
  - [ ] Subtask 3.4.2.4: Include user context and correlation ID for tracking

- [ ] **Task 3.4.3: Update Modal Query Logic** (AC: 3)
  - [ ] Subtask 3.4.3.1: Modify getMyIncompleteIncidents query to exclude `"ready_for_analysis"` status
  - [ ] Subtask 3.4.3.2: Test modal behavior with workflow-complete incidents
  - [ ] Subtask 3.4.3.3: Verify query performance with status filtering

- [ ] **Task 3.4.4: Data Backfill Implementation** (AC: 4)
  - [ ] Subtask 3.4.4.1: Create `backfillWorkflowCompletions` mutation for historical data
  - [ ] Subtask 3.4.4.2: Identify incidents with completed workflow steps but pending status
  - [ ] Subtask 3.4.4.3: Batch update historical incidents to "ready_for_analysis" status
  - [ ] Subtask 3.4.4.4: Log backfill operations for audit purposes

- [ ] **Task 3.4.5: Testing and Validation** (AC: 1-6)
  - [ ] Subtask 3.4.5.1: Unit tests for auto-completion logic
  - [ ] Subtask 3.4.5.2: Integration tests for status updates and modal behavior
  - [ ] Subtask 3.4.5.3: Test backfill operation with sample data
  - [ ] Subtask 3.4.5.4: Validate audit trail logging

## Documentation Impact Assessment

This story establishes important workflow completion patterns for SupportSignal:

**Architectural Patterns to Establish:**
- Automatic workflow state transitions based on user actions
- Status management patterns for multi-step workflows  
- Data backfill patterns for schema/logic updates
- Audit logging for automated system actions

**Documentation Updates Needed:**
- Workflow state transition documentation
- Status management patterns in architecture docs
- Data migration and backfill procedures
- Incident lifecycle documentation updates

**Knowledge Capture:**
- Workflow completion automation patterns
- Historical data migration strategies
- Status transition logging standards

## Dev Notes

### Relevant Source Tree Information
Based on existing Epic 3 implementation, key files to modify:
- `apps/web/components/incidents/ConsolidatedReportStep.tsx` - Add auto-completion trigger
- `apps/convex/incidents.ts` - Add autoCompleteWorkflow mutation and backfill logic  
- `apps/convex/incidents_listing.ts` - Already correctly excludes completed incidents
- `apps/convex/schema.ts` - workflow_completed_at field already exists from Story 3.3

### Technical Implementation Context

**From Story 3.3 Schema (already implemented):**
```typescript
// Enhancement completion fields from Story 3.3
workflow_completed_at: v.optional(v.number()),
submitted_by: v.optional(v.id("users")),  
submitted_at: v.optional(v.number()),
handoff_status: v.optional(v.union(
  v.literal("draft"),
  v.literal("ready_for_analysis"), 
  v.literal("in_analysis"),
  v.literal("analysis_complete")
)),
```

**Current Status Logic:**
- `capture_status`: "draft" | "in_progress" | "completed" (workflow steps completion)
- `overall_status`: "capture_pending" | "analysis_pending" | "completed" (overall lifecycle)
- `handoff_status`: Manual submission workflow (optional, for future supervisor review)

**Auto-Completion Logic:**
- Trigger: User completes Step 8 (ConsolidatedReportStep) 
- Action: Set `overall_status: "ready_for_analysis"` + `workflow_completed_at: timestamp`
- Result: Incident excluded from getMyIncompleteIncidents query (frontline worker's workflow is done)

**Backfill Logic:**
- Identify incidents where all workflow steps are complete but `overall_status != "ready_for_analysis"`
- Batch update these incidents with "ready_for_analysis" status and estimated timestamp
- Log all backfill operations for audit trail

### Pattern Validation
Following established patterns from Epic 3:
- Permission-based mutations using `requirePermission()` 
- Correlation ID tracking for audit trail
- Multi-tenant company boundary enforcement
- Consistent timestamp and user tracking

### Testing
**Test file locations:** `tests/web/components/incidents/` and `tests/convex/src/`

**Testing standards:**
- Unit tests for ConsolidatedReportStep auto-completion trigger
- Integration tests for mutation workflow and status transitions  
- Component tests for modal behavior with workflow-complete incidents
- Backend tests for backfill logic and data migration

**Testing frameworks:** 
- Jest for unit/integration tests
- Convex testing utilities for backend logic
- React Testing Library for component behavior

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-04 | 1.0 | Initial story creation for workflow auto-completion | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results  

*This section will be populated by the QA agent after implementation review*