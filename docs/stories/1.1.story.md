# Story 1.1: SupportSignal Multi-Tenant Database Implementation

## Status
Ready

## Story
**As a** backend developer,  
**I want** to implement the multi-tenant SupportSignal incident management database schema in the existing Convex database,  
**so that** multiple NDIS provider companies can use the platform with proper data isolation and role-based access control.

## Acceptance Criteria
1. All 7 new incident-related tables implemented with proper TypeScript definitions and multi-tenant company association
2. Enhanced users table with company relationships and snake_case role hierarchy
3. Companies table supporting multi-tenant architecture with Support Signal as default company
4. AI prompts table designed as reusable subsystem for multiple platform features
5. Convex validators for all data inputs with comprehensive error messages
6. Database indexes optimized for multi-tenant queries and workflow operations
7. Seed data including Support Signal company and david@ideasmen.com.au as system_admin user
8. CI verification that schema changes integrate properly with build pipeline
9. Update data-models.md documentation to reflect actual schema

## Estimation & Planning
- **Story Points**: 8
- **Estimated Complexity**: High
- **Estimated Time**: 1 week
- **Risk Level**: Medium-High

### Risk Factors
- Multi-tenant data isolation complexity
- Integration with existing user/auth tables
- AI prompts subsystem design for future reusability
- Complex role hierarchy and permission implications
- Data migration for existing users

## Tasks / Subtasks
- [ ] Create multi-tenant foundation (AC: 1, 3)
  - [ ] Implement `companies` table with Support Signal as default
  - [ ] Enhance existing `users` table with companyId and snake_case roles
  - [ ] Add virtual canUseFeatures logic (computed from companyId presence)
  - [ ] Create indexes for multi-tenant queries
- [ ] Create core incident tables (AC: 1, 2)
  - [ ] Implement `incidents` table with company association and workflow status
  - [ ] Implement `incidentNarratives` table with multi-phase support
  - [ ] Implement `clarificationQuestions` and `clarificationAnswers` tables
  - [ ] Implement `incidentAnalysis` and `incidentClassifications` tables
- [ ] Create AI prompts subsystem (AC: 4)
  - [ ] Implement `aiPrompts` table as reusable subsystem
  - [ ] Design prompt versioning and field substitution system
  - [ ] Add subsystem tagging for cross-feature usage
  - [ ] Document prompt management patterns
- [ ] Configure database indexes (AC: 6)
  - [ ] Add multi-tenant isolation indexes (by company)
  - [ ] Add workflow status and reporting indexes
  - [ ] Add user and role-based query indexes
- [ ] Implement data validation (AC: 5)
  - [ ] Create comprehensive Convex validators for all new tables
  - [ ] Add multi-tenant data isolation validation
  - [ ] Add role hierarchy validation rules
  - [ ] Test validation edge cases and cross-table relationships
- [ ] Create seed data and user setup (AC: 7)
  - [ ] Create Support Signal company as default tenant
  - [ ] Set up david@ideasmen.com.au as system_admin user
  - [ ] Create development seed data for all tables  
  - [ ] Create test scenarios for different workflow states
- [ ] Verify CI integration (AC: 8)
  - [ ] Test schema changes don't break CI builds
  - [ ] Verify database tests pass in CI environment (not just locally)
  - [ ] Use `bun run ci:watch` to monitor actual pipeline completion
- [ ] Update documentation (AC: 9)
  - [ ] Update `docs/architecture/data-models.md` with actual multi-tenant schema
  - [ ] Document multi-tenant patterns and company isolation
  - [ ] Document AI prompts subsystem design

## Documentation Impact Assessment
- **Architectural patterns**: Multi-tenant SaaS patterns with company-based data isolation
- **Documentation updates needed**: 
  - `docs/architecture/data-models.md` - Complete rewrite with actual schema
  - `docs/patterns/backend-patterns.md` - Add multi-tenant and AI prompts patterns
  - `docs/examples/backend/` - Create multi-tenant implementation examples
- **New knowledge to capture**: 
  - Multi-tenant data isolation strategies in Convex
  - AI prompts subsystem design for reusability
  - Role hierarchy and virtual computed fields
  - Company-based permission patterns

## Dev Notes

### Pattern Validation
- Follow existing Convex patterns from current `apps/convex/schema.ts`
- **IMPORTANT**: `docs/architecture/data-models.md` is OUTDATED - actual schema is in `schema.ts`
- Use consistent patterns from existing tables: `users`, `sessions`, `chat_sessions`, `debug_logs`, etc.
- Use consistent ID field naming: `_id` for primary keys, `companyId`, `incidentId` etc. for foreign keys
- Follow timestamp convention: `created_at`, `updated_at` as `number` type for new tables
- Include `correlation_id` fields for traceability (required by coding standards)

### Multi-Tenant Architecture Context
**Source**: Working NDIS incident reporting application + multi-tenant SaaS requirements

**Company Structure**:
- **Default company**: "Support Signal" 
- **System admin user**: david@ideasmen.com.au with system_admin role
- **Additional users**: angela@supportsignal.com.au and other Support Signal staff
- **Client companies**: Individual NDIS provider organizations
- **Data isolation**: All incident data associated with company for proper tenant separation
- **User signup flow**: Users can register but cannot use features until assigned to company

**Role Hierarchy** (snake_case):
- **system_admin**: Platform administration (Support Signal staff)
- **company_admin**: Full company management within tenant
- **team_lead**: Can analyze incidents, manage team within company
- **frontline_worker**: Can create and capture incidents within company  
- **viewer**: Read-only access to company data
- **support**: Customer support access (Support Signal staff)

**Virtual Fields**:
- **canUseFeatures**: Computed from `companyId != null` (not stored in database)

### Testing Standards
[Source: docs/testing/technical/testing-patterns.md + lessons-learned/anti-patterns/]
- **Test location**: Create tests in `tests/convex/` directory (centralized testing pattern)
- **Testing framework**: Jest with Convex testing utilities
- **Critical testing approach**:
  - **Test real Convex operations** - Don't mock database layer (lessons from over-mocking anti-patterns)
  - **Multi-tenant isolation** - Test that company data separation actually works
  - **Schema validation** - Test validators with edge cases and invalid data
  - **Integration testing** - Test table relationships work correctly together
- **Required tests**:
  - Multi-tenant data isolation tests
  - Role hierarchy and permission tests  
  - Schema validation tests for all validators
  - AI prompts subsystem functionality tests
  - Cross-table relationship integrity tests
- **CI verification**: Must test in CI environment, not just locally (critical lesson from testing-infrastructure-lessons-learned.md)

### Database Schema Structure
[Source: NDIS incident reporting application + Multi-tenant requirements]

**New Tables (7 tables):**

```typescript
// Multi-tenant foundation
export const companies = defineTable({
  name: v.string(),                    // "Support Signal", "ABC NDIS Provider"
  slug: v.string(),                    // URL-friendly identifier
  contactEmail: v.string(),            // Primary contact
  status: v.union(v.literal("active"), v.literal("trial"), v.literal("suspended")),
  created_at: v.number(),
  created_by: v.id("users"),
})
.index("by_slug", ["slug"])
.index("by_status", ["status"]);

// Core incident management
export const incidents = defineTable({
  companyId: v.id("companies"),        // Multi-tenant isolation
  reporterName: v.string(),
  participantName: v.string(),
  eventDateTime: v.string(),
  location: v.string(),
  
  // Workflow Status
  captureStatus: v.union(v.literal("draft"), v.literal("in_progress"), v.literal("completed")),
  analysisStatus: v.union(v.literal("not_started"), v.literal("in_progress"), v.literal("completed")),
  overallStatus: v.union(v.literal("capture_pending"), v.literal("analysis_pending"), v.literal("completed")),
  
  created_at: v.number(),
  created_by: v.id("users"),
  correlation_id: v.string(),
})
.index("by_company", ["companyId"])
.index("by_status", ["overallStatus"])
.index("by_correlation_id", ["correlation_id"]);

// AI Prompts Subsystem (reusable across platform)
export const aiPrompts = defineTable({
  promptName: v.string(),              // "generate_clarification_questions"
  promptVersion: v.string(),           // "v1.2.0"
  promptTemplate: v.string(),          // Actual prompt content
  subsystem: v.string(),               // "incidents", "chat", etc.
  isActive: v.boolean(),
  created_at: v.number(),
})
.index("by_name_version", ["promptName", "promptVersion"])
.index("by_subsystem", ["subsystem"])
.index("by_active", ["isActive"]);
```

**Enhanced Users Table**:
Add to existing `users` table:
```typescript
// Add these fields to existing users table:
companyId: v.optional(v.id("companies")), // Which company they belong to
role: v.union(
  v.literal("system_admin"),
  v.literal("company_admin"), 
  v.literal("team_lead"),
  v.literal("frontline_worker"),
  v.literal("viewer"),
  v.literal("support")
),
```

### File Locations
[Source: architecture/source-tree.md]
- Convex backend files location: `apps/convex/`
- Key files to modify:
  - `apps/convex/schema.ts` - Add new tables and enhance users table
  - New domain files to create:
    - `apps/convex/companies.ts` - Multi-tenant company management
    - `apps/convex/incidents.ts` - Incident management functions
    - `apps/convex/analysis.ts` - Analysis workflow functions
    - `apps/convex/prompts.ts` - AI prompts subsystem functions

### Previous Story Context
This is the first story (1.1), so no previous story context exists. This story establishes the foundation for all subsequent incident management workflows.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-15 | 1.0 | Initial story creation | Bob (SM) |
| 2025-01-15 | 2.0 | Updated with multi-tenant architecture and correct scope | Bob (SM) |
| 2025-01-15 | 3.0 | Added CI verification, david@ideasmen.com.au setup, critical testing patterns. Status: Ready | Sarah (PO) |

## Dev Agent Record
*To be populated during implementation*

### Agent Model Used
*To be populated*

### Debug Log References
*To be populated*

### Completion Notes List
*To be populated*

### File List
*To be populated*

## QA Results
*To be populated after implementation*

### Pattern Compliance Review
*To be populated*

### Knowledge Capture
*To be populated*

### Velocity Data
*To be populated*