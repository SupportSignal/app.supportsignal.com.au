# Story 2.3: NDIS Participants Management

## Status
Ready for Development 🟡

## Story
**As a** team lead or company administrator,  
**I want** to create and manage NDIS participant records within my company,  
**so that** I can properly associate participants with incident reports and maintain accurate service delivery records.

## Acceptance Criteria
1. [ ] Create participant form with comprehensive validation and auto-save
2. [ ] Role-based access control (only team_lead, company_admin, system_admin can create participants)
3. [ ] Automatic company association for all new participants
4. [ ] Searchable participant list scoped to user's company
5. [ ] Full CRUD operations with audit trail and change tracking
6. [ ] Required field validation and duplicate detection by NDIS number
7. [ ] Mobile-responsive participant management interface

## Estimation & Planning
- **Story Points**: 8
- **Estimated Complexity**: Medium-High
- **Estimated Time**: 1 week
- **Risk Level**: Medium

### Risk Factors
- Database schema addition requires careful migration planning
- Role-based access control integration with existing auth system
- Multi-tenant data isolation must be bulletproof
- NDIS number uniqueness validation across companies

## Tasks / Subtasks
- [ ] **Database Schema Implementation** (AC: 1, 3, 6)
  - [ ] Add participants table to `apps/convex/schema.ts` with proper indexes
  - [ ] Create Convex functions for participant CRUD operations
  - [ ] Implement company-scoped queries with proper multi-tenant isolation
  - [ ] Add NDIS number uniqueness validation within company scope
- [ ] **Participant Creation Form** (AC: 1, 2, 7)
  - [ ] Build comprehensive participant form with all required fields
  - [ ] Implement role-based access control for form access
  - [ ] Add real-time validation with clear error messaging
  - [ ] Implement auto-save functionality with visual confirmation
- [ ] **Participant Management Interface** (AC: 4, 5, 7)
  - [ ] Create searchable participant list with filtering capabilities
  - [ ] Implement edit/update functionality with change tracking
  - [ ] Add participant status management (active/inactive/discharged)
  - [ ] Build mobile-responsive interface for tablet and phone use
- [ ] **Data Validation & Security** (AC: 2, 3, 6)
  - [ ] Implement comprehensive field validation rules
  - [ ] Add duplicate detection by NDIS number within company
  - [ ] Ensure all operations respect company isolation
  - [ ] Create audit trail for all participant record changes

## Technical Implementation

### Database Schema Addition
```typescript
// New table needed in apps/convex/schema.ts
participants: defineTable({
  company_id: v.id("companies"), // Multi-tenant isolation
  first_name: v.string(),
  last_name: v.string(),
  date_of_birth: v.string(),
  ndis_number: v.string(), // NDIS participant identifier
  contact_phone: v.optional(v.string()),
  emergency_contact: v.optional(v.string()),
  support_level: v.union(v.literal("high"), v.literal("medium"), v.literal("low")),
  care_notes: v.optional(v.string()),
  status: v.union(v.literal("active"), v.literal("inactive"), v.literal("discharged")),
  created_at: v.number(),
  created_by: v.id("users"),
  updated_at: v.number(),
  updated_by: v.id("users"),
})
  .index("by_company", ["company_id"])
  .index("by_ndis_number", ["ndis_number"])
  .index("by_status", ["status"])
  .index("by_name", ["last_name", "first_name"]),
```

### Participant Data Structure
```typescript
interface Participant {
  _id: Id<"participants">;
  company_id: Id<"companies">; // Auto-assigned from user's company
  
  // Core participant information
  first_name: string;
  last_name: string;
  date_of_birth: string; // For identification
  ndis_number: string; // NDIS participant number
  
  // Contact information
  contact_phone?: string;
  emergency_contact?: string;
  
  // Service information
  support_level: "high" | "medium" | "low";
  care_notes?: string; // Special considerations
  
  // Audit trail
  created_at: number;
  created_by: Id<"users">;
  updated_at: number;
  updated_by: Id<"users">;
  
  // Status
  status: "active" | "inactive" | "discharged";
}
```

### Role-Based Access Control
```typescript
// Role validation for participant management
const canCreateParticipant = (userRole: UserRole): boolean => {
  return ["system_admin", "company_admin", "team_lead"].includes(userRole);
};

const canEditParticipant = (userRole: UserRole, participantCompanyId: Id<"companies">, userCompanyId: Id<"companies">): boolean => {
  return canCreateParticipant(userRole) && participantCompanyId === userCompanyId;
};
```

### Convex Functions Required
```typescript
// participants/create.ts
export const createParticipant = mutation({
  args: {
    first_name: v.string(),
    last_name: v.string(),
    date_of_birth: v.string(),
    ndis_number: v.string(),
    contact_phone: v.optional(v.string()),
    emergency_contact: v.optional(v.string()),
    support_level: v.union(v.literal("high"), v.literal("medium"), v.literal("low")),
    care_notes: v.optional(v.string()),
  },
  handler: async (ctx, args) => {
    const currentUser = await getCurrentUser(ctx);
    if (!canCreateParticipant(currentUser.role)) {
      throw new ConvexError("Insufficient permissions to create participants");
    }
    
    // Check for duplicate NDIS number within company
    const existing = await ctx.db
      .query("participants")
      .withIndex("by_ndis_number", (q) => q.eq("ndis_number", args.ndis_number))
      .filter((q) => q.eq(q.field("company_id"), currentUser.company_id))
      .first();
      
    if (existing) {
      throw new ConvexError("Participant with this NDIS number already exists in your company");
    }
    
    return await ctx.db.insert("participants", {
      ...args,
      company_id: currentUser.company_id,
      status: "active",
      created_at: Date.now(),
      created_by: currentUser._id,
      updated_at: Date.now(),
      updated_by: currentUser._id,
    });
  },
});

// participants/list.ts
export const listParticipants = query({
  args: {
    search: v.optional(v.string()),
    status: v.optional(v.string()),
  },
  handler: async (ctx, { search, status }) => {
    const currentUser = await getCurrentUser(ctx);
    
    let query = ctx.db
      .query("participants")
      .withIndex("by_company", (q) => q.eq("company_id", currentUser.company_id));
    
    if (status) {
      query = query.filter((q) => q.eq(q.field("status"), status));
    }
    
    const participants = await query.collect();
    
    // Apply search filter if provided
    if (search) {
      const searchLower = search.toLowerCase();
      return participants.filter(p => 
        p.first_name.toLowerCase().includes(searchLower) ||
        p.last_name.toLowerCase().includes(searchLower) ||
        p.ndis_number.toLowerCase().includes(searchLower)
      );
    }
    
    return participants;
  },
});
```

## Validation Rules

### Required Fields
- `first_name`: 2-50 characters, letters and spaces only
- `last_name`: 2-50 characters, letters and spaces only  
- `date_of_birth`: Valid date format (YYYY-MM-DD), not future date
- `ndis_number`: 9 digits, unique within company scope
- `support_level`: Must be one of: high, medium, low

### Optional Fields
- `contact_phone`: Valid phone format if provided
- `emergency_contact`: 2-100 characters if provided
- `care_notes`: Max 500 characters if provided

### Business Rules
- NDIS numbers must be unique within each company (not globally)
- Only users with appropriate roles can create/edit participants
- All participants automatically belong to creator's company
- Participant status changes require audit trail
- Soft delete pattern (status: "discharged") rather than hard delete

## Dependencies & Handoffs

### ✅ From Previous Stories - DEPENDENCY STATUS: SATISFIED
- **✅ Story 2.0**: UI Design System with form components and validation patterns
- **✅ Story 2.1**: Wizard Framework (may be used for complex participant onboarding)
- **✅ Story 2.2**: Navigation structure for participant management section
- **✅ Epic 1**: Authentication system with role-based access control
- **✅ Epic 1**: Companies table and multi-tenant architecture

### To Epic 3 (Incident Capture Workflow)
- **Participant Selection**: Dropdown component for incident metadata
- **Auto-Population**: Participant details available for incident context
- **Data Foundation**: Proper participant entities for meaningful incident reports

## Epic 3 Integration Requirements

### Participant Selection Component
```typescript
// Component needed for Epic 3 incident capture
const ParticipantSelector = () => {
  const participants = useQuery(api.participants.list, { 
    status: "active" 
  });
  
  return (
    <SearchableDropdown 
      options={participants?.map(p => ({
        value: p._id,
        label: `${p.first_name} ${p.last_name} (${p.ndis_number})`,
        participant: p
      }))}
      onSelect={handleParticipantSelection}
      placeholder="Select NDIS participant..."
      required
    />
  );
};
```

### Enhanced Incident Metadata
```typescript
// Enhanced incident structure with participant selection
interface IncidentMetadata {
  reporterName: string;           // Auto-filled from auth user
  participantId: Id<"participants">; // Selected from dropdown
  participantName: string;        // Auto-populated from selection
  eventDateTime: string;          // Date/time picker
  location: string;              // Location input
}
```

## Documentation Impact Assessment
- **Database Schema**: Update schema documentation with participants table
- **API Documentation**: Add participant management API endpoints
- **User Guide**: Create participant management user documentation
- **Role Permissions**: Update role-based access control documentation

## UI Design Specification

### Participant Creation Form Layout
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Create New Participant                                          [Cancel] [Save] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ Personal Information                                                        │
│ ┌─────────────────────┐  ┌─────────────────────┐                          │
│ │ First Name *        │  │ Last Name *         │                          │
│ │ John               │  │ Smith               │                          │
│ └─────────────────────┘  └─────────────────────┘                          │
│                                                                             │
│ ┌─────────────────────┐  ┌─────────────────────┐                          │
│ │ Date of Birth *     │  │ NDIS Number *       │                          │
│ │ 1985-03-15         │  │ 123456789          │                          │
│ └─────────────────────┘  └─────────────────────┘                          │
│                                                                             │
│ Contact Information                                                         │
│ ┌─────────────────────┐  ┌─────────────────────┐                          │
│ │ Phone Number        │  │ Emergency Contact   │                          │
│ │ 0400 123 456       │  │ Jane Smith - Sister │                          │
│ └─────────────────────┘  └─────────────────────┘                          │
│                                                                             │
│ Care Information                                                            │
│ ┌─────────────────────┐                                                    │
│ │ Support Level *     │                                                    │
│ │ ○ High  ●Medium ○Low│                                                    │
│ └─────────────────────┘                                                    │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────┐   │
│ │ Care Notes (optional)                                               │   │
│ │ Requires assistance with mobility. Uses wheelchair.                 │   │
│ │ Prefers morning activities.                                         │   │
│ └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Participant List Interface
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ NDIS Participants                              [🔍 Search] [+ Add Participant] │
├─────────────────────────────────────────────────────────────────────────────┤
│ Filters: [All Status ▼] [All Support Levels ▼]                 24 participants │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 📋 John Smith                                    [Edit] [View] [Status▼] │ │
│ │    NDIS: 123456789 | High Support | Active                             │ │
│ │    Phone: 0400 123 456 | DOB: 15/03/1985                               │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 📋 Sarah Johnson                                 [Edit] [View] [Status▼] │ │
│ │    NDIS: 987654321 | Medium Support | Active                           │ │
│ │    Phone: 0411 987 654 | DOB: 22/07/1992                               │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ [Load More Participants...]                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Testing Strategy
**Test Location**: `tests/web/components/participants/` directory (centralized testing pattern)
**Testing Framework**: Jest with React Testing Library

### Required Test Coverage
- **Form Validation**: All field validation rules and error messages
- **Role-Based Access**: Permission enforcement for different user roles  
- **Company Isolation**: Multi-tenant data separation verification
- **CRUD Operations**: Create, read, update operations with proper audit trails
- **Search & Filter**: Participant list search and filtering functionality
- **Duplicate Detection**: NDIS number uniqueness validation within company
- **Mobile Responsive**: Interface functionality on mobile devices
- **Accessibility**: WCAG 2.1 AA compliance for form and list interfaces

### Integration Tests
- **Database Operations**: Convex function testing with test data
- **Authentication Integration**: Role-based access with actual auth system
- **Company Scoping**: Verify participants only visible within correct company
- **Audit Trail**: Change tracking and user attribution verification

## Dev Notes

### Component Architecture
```
apps/web/components/participants/
├── ParticipantForm.tsx          # Create/edit participant form
├── ParticipantList.tsx          # Searchable participant directory  
├── ParticipantCard.tsx          # Individual participant display
├── ParticipantSelector.tsx      # Dropdown for incident selection
├── ParticipantSearch.tsx        # Search and filter controls
└── ParticipantValidation.tsx    # Form validation logic
```

### Convex Functions Structure
```
apps/convex/participants/
├── create.ts                    # Create new participant
├── list.ts                      # Query participants by company
├── getById.ts                   # Get individual participant
├── update.ts                    # Update participant information
├── updateStatus.ts              # Change participant status
└── search.ts                    # Advanced search functionality
```

### File Locations
- **Schema Update**: `apps/convex/schema.ts` (add participants table)
- **Type Definitions**: `apps/web/types/participants.ts`
- **Participant Components**: `apps/web/components/participants/`
- **Participant Pages**: `apps/web/app/(dashboard)/participants/`
- **Test Files**: `tests/web/components/participants/`

## Pattern Validation
- Follow Next.js App Router patterns for participant management pages
- Use ShadCN UI components (Form, Table, Dialog) with established theming
- Integrate with existing authentication system for role-based access
- Follow multi-tenant patterns established in Epic 1
- Use established form validation patterns from Story 2.0

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-09 | 1.0 | Initial story creation for NDIS participant management - foundational entity system required for Epic 3 incident capture workflow | Claude (AI Assistant) |