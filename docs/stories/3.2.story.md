# Story 3.2: AI-Powered Clarification System

## Status
On Hold

## Story
**As a** frontline support worker,  
**I want** intelligent clarification questions generated for each narrative phase I've completed,  
**so that** I can provide comprehensive incident details without missing critical information that might otherwise be overlooked in post-incident stress.

## Acceptance Criteria

1. **AI Integration**: Reliable question generation with <10 second response times
2. **Question Display**: Clear, numbered questions with generous answer spaces  
3. **Optional Responses**: Skip functionality that doesn't block workflow progression
4. **Error Handling**: Graceful fallback when AI services are unavailable
5. **Question Caching**: Smart caching to avoid re-generating identical questions
6. **Progress Indication**: Clear indication of which questions have been answered
7. **Content Preservation**: Answers saved immediately and persist across sessions

## Estimation & Planning

### Story Points
8

### Estimated Complexity  
High

### Estimated Time
1.5 weeks

### Risk Level
Medium

## Tasks / Subtasks

- [x] **Task 3.2.1: AI Question Generation Backend** (AC: 1, 2, 4, 5)
  - [x] Subtask 3.2.1.1: Implement AI prompt system for clarification question generation
  - [x] Subtask 3.2.1.2: Create question caching mechanism to avoid duplicate AI calls
  - [x] Subtask 3.2.1.3: Add error handling and fallback for AI service failures
  - [x] Subtask 3.2.1.4: Implement question management CRUD operations with proper indexing

- [x] **Task 3.2.2: Clarification Question UI Components** (AC: 2, 3, 6)
  - [x] Subtask 3.2.2.1: Create ClarificationStep component for Steps 3-6 of workflow
  - [x] Subtask 3.2.2.2: Implement QuestionsList with numbered questions and answer inputs
  - [x] Subtask 3.2.2.3: Add skip functionality and progress tracking per phase
  - [x] Subtask 3.2.2.4: Create responsive design that works on mobile devices

- [x] **Task 3.2.3: Answer Persistence and Session Management** (AC: 7)
  - [x] Subtask 3.2.3.1: Implement real-time answer saving with auto-save pattern from 3.1
  - [x] Subtask 3.2.3.2: Add session recovery for partially answered questions
  - [x] Subtask 3.2.3.3: Integrate with existing workflow state management
  - [x] Subtask 3.2.3.4: Add validation for answer completeness and quality metrics

- [ ] **Task 3.2.4: Workflow Integration and Testing** (AC: 1-7)
  - [x] Subtask 3.2.4.1: Integrate clarification steps into existing IncidentCaptureWorkflow
  - [ ] Subtask 3.2.4.2: Add comprehensive unit tests for AI generation and caching
  - [ ] Subtask 3.2.4.3: Implement integration tests for complete Steps 3-6 workflow
  - [ ] Subtask 3.2.4.4: Add error boundary testing and AI service mocking

## Documentation Impact Assessment

This story establishes critical AI integration patterns that will be reused across the application:

**Architectural Patterns to Establish:**
- AI prompt management and versioning system
- Question generation and caching patterns  
- Error handling for external AI service dependencies
- Multi-step workflow progression with optional steps

**Documentation Updates Needed:**
- AI integration patterns in architecture documentation
- Testing patterns for AI-dependent components
- Error handling strategies for external service dependencies

**Knowledge Capture:**
- AI prompt engineering best practices for clarification questions
- Performance optimization strategies for AI-powered workflows
- User experience patterns for optional workflow steps

## Dev Notes

### Previous Story Insights
From Story 3.1 completion:
- **Authentication Pattern**: Use `auth_session_token` for session management
- **Auto-save Pattern**: Implement 30-second auto-save with visual feedback established in NarrativeGrid
- **Workflow Integration**: `IncidentCaptureWorkflow.tsx` orchestrates multi-step process
- **Responsive Design**: 2x2 grid → single column pattern for mobile compatibility
- **Error Handling**: Implement graceful degradation with user-friendly error messages

### Data Models [Source: apps/convex/schema.ts]

**AI Prompts System:**
```typescript
ai_prompts: defineTable({
  prompt_name: v.string(), // "generate_clarification_questions"
  prompt_version: v.string(), // "v1.0.0"
  prompt_template: v.string(), // The actual prompt template
  description: v.optional(v.string()),
  input_schema: v.optional(v.string()), // JSON schema for inputs
  output_schema: v.optional(v.string()), // JSON schema for outputs
  workflow_step: v.optional(v.string()), // "clarification_questions"
  subsystem: v.optional(v.string()), // "incidents" 
  ai_model: v.optional(v.string()), // "openai/gpt-4o-mini"
  max_tokens: v.optional(v.number()),
  temperature: v.optional(v.number()),
  is_active: v.optional(v.boolean()),
  created_at: v.number(),
})
  .index("by_name", ["prompt_name"])
  .index("by_name_version", ["prompt_name", "prompt_version"])
  .index("by_active", ["is_active"])
```

**Clarification Questions:**
```typescript
clarification_questions: defineTable({
  incident_id: v.id("incidents"),
  question_id: v.string(), // Unique question identifier
  phase: v.union(
    v.literal("before_event"),
    v.literal("during_event"), 
    v.literal("end_event"),
    v.literal("post_event")
  ),
  question_text: v.string(),
  question_order: v.number(),
  generated_at: v.number(),
  ai_model: v.optional(v.string()),
  prompt_version: v.optional(v.string()),
  is_active: v.boolean(),
})
  .index("by_incident", ["incident_id"])
  .index("by_incident_phase", ["incident_id", "phase"])
```

**Clarification Answers:**
```typescript
clarification_answers: defineTable({
  incident_id: v.id("incidents"),
  question_id: v.string(),
  answer_text: v.string(),
  phase: v.union(
    v.literal("before_event"),
    v.literal("during_event"),
    v.literal("end_event"), 
    v.literal("post_event")
  ),
  answered_at: v.number(),
  answered_by: v.optional(v.id("users")),
  updated_at: v.number(),
  is_complete: v.boolean(),
  character_count: v.number(),
  word_count: v.number(),
})
  .index("by_incident", ["incident_id"])
  .index("by_incident_phase", ["incident_id", "phase"])
  .index("by_question", ["question_id"])
```

**AI Request Logging:**
```typescript
ai_request_logs: defineTable({
  correlation_id: v.string(),
  operation: v.string(), // "generateClarificationQuestions"
  model: v.string(), // "openai/gpt-4o-mini"
  prompt_template: v.string(),
  input_data: v.any(),
  output_data: v.optional(v.any()),
  processing_time_ms: v.number(),
  tokens_used: v.optional(v.number()),
  cost_usd: v.optional(v.number()),
  success: v.boolean(),
  error_message: v.optional(v.string()),
  user_id: v.optional(v.id("users")),
  incident_id: v.optional(v.id("incidents")),
  created_at: v.number(),
})
  .index("by_correlation_id", ["correlation_id"])
  .index("by_operation", ["operation"])
```

### API Specifications

**Required Convex Functions:**

#### AI Question Generation:
```typescript
// apps/convex/ai-clarification.ts
export const generateClarificationQuestions = action({
  args: {
    sessionToken: v.string(),
    incident_id: v.id("incidents"),
    phase: v.union(v.literal("before_event"), v.literal("during_event"), 
                   v.literal("end_event"), v.literal("post_event")),
    narrative_content: v.string(),
  },
  handler: async (ctx, args) => {
    // 1. Check for cached questions first
    // 2. Generate questions using AI if not cached
    // 3. Store questions in database
    // 4. Log AI request for monitoring
    // 5. Return questions array
  }
});

export const getClarificationQuestions = query({
  args: { 
    sessionToken: v.string(),
    incident_id: v.id("incidents"),
    phase: v.optional(v.union(...)) 
  },
  handler: async (ctx, args) => {
    // Return questions for incident, optionally filtered by phase
    // Include answered status from clarification_answers table
  }
});
```

#### Answer Management:
```typescript
export const submitClarificationAnswer = mutation({
  args: {
    sessionToken: v.string(),
    incident_id: v.id("incidents"),
    question_id: v.string(),
    answer_text: v.string(),
    phase: v.union(...),
  },
  handler: async (ctx, args) => {
    // Save answer with auto-calculated metrics
    // Update incident workflow status if phase complete
    // Return success status
  }
});
```

### Component Specifications

**Page Integration:**
- Extend existing `apps/web/components/incidents/IncidentCaptureWorkflow.tsx`
- Add Steps 3-6 to wizard framework

**New UI Components:**
- `apps/web/components/incidents/ClarificationStep.tsx` - Individual step component (Steps 3-6)
- `apps/web/components/incidents/QuestionsList.tsx` - Question display and answer input
- `apps/web/components/incidents/QuestionCard.tsx` - Individual question with answer input
- `apps/web/components/incidents/ClarificationProgress.tsx` - Phase-specific progress tracking

**AI Integration:**
- `apps/web/lib/ai/clarification-service.ts` - Client-side AI service wrapper
- `apps/convex/lib/ai/question-generator.ts` - Server-side AI question generation
- `apps/convex/lib/ai/prompt-manager.ts` - AI prompt template management

### File Locations

**Frontend Implementation:**
- `apps/web/components/incidents/ClarificationStep.tsx` - Steps 3-6 component
- `apps/web/components/incidents/QuestionsList.tsx` - Question display component
- `apps/web/lib/ai/` - AI integration utilities
- `apps/web/types/clarification.ts` - TypeScript interfaces

**Backend Implementation:**
- `apps/convex/ai-clarification.ts` - Question generation and management
- `apps/convex/lib/ai/question-generator.ts` - AI service integration
- `apps/convex/lib/ai/prompt-manager.ts` - Prompt template system

### Technical Constraints

**AI Service Integration** [Source: docs/architecture/tech-stack.md]:
- Use Claude SDK for backend AI communication
- Implement retry logic for AI service failures
- Cache questions to minimize AI API costs
- Use correlation IDs for request tracking

**Performance Requirements**:
- Question generation: <10 seconds per phase
- Auto-save answers every 30 seconds (consistent with Story 3.1)
- Cache hit rate >80% for similar narrative content
- Support offline answer entry with sync on reconnection

**Error Handling Strategy** [Source: docs/architecture/error-handling-strategy.md]:
- Graceful degradation when AI services unavailable
- User-friendly error messages for AI failures
- Fallback to pre-defined generic questions when AI fails
- Comprehensive logging for debugging AI issues

### Pattern Validation

**Repository Pattern** [Source: docs/architecture/coding-standards.md]:
- All data access through repository pattern
- No direct database access from components
- Centralized AI service configuration

**TypeScript Requirements** [Source: docs/architecture/coding-standards.md]:
- Strict mode compliance required
- No `any` type usage - define proper interfaces
- Full type safety for AI request/response data

**Correlation ID Requirements**:
- All AI requests must include correlation IDs  
- Link AI logs to incident and user context
- Enable end-to-end request tracing

### Testing

**Testing Standards** [Source: docs/testing/technical/test-strategy-and-standards.md]:

**Test File Locations:**
- Unit tests: `tests/web/components/incidents/` - UI component testing
- Integration tests: `tests/convex/ai-clarification/` - AI generation workflow testing  
- E2E tests: `tests/e2e/clarification-workflow/` - Complete Steps 3-6 user flow

**Testing Frameworks:**
- **Jest + RTL**: Component behavior testing with proper AI service mocking
- **Convex Testing**: Backend function testing with mock AI responses
- **Playwright**: E2E testing of clarification workflow

**AI Service Testing Patterns:**
- Mock AI responses for unit tests
- Use deterministic AI responses in integration tests  
- Test error scenarios (AI unavailable, malformed responses)
- Validate caching behavior and question persistence

**Coverage Requirements:**
- Unit tests: 85%+ coverage for clarification components
- Integration tests: 100% coverage of AI generation workflows
- E2E tests: Complete Steps 3-6 user journey

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-10 | 1.0 | Initial story creation for Epic 3 AI-powered clarification system | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List

**Implementation Progress: 2025-08-11**  
**Status Updated: 2025-08-12**
- ✅ Core AI question generation framework implemented
- ✅ Basic ClarificationStep components created
- ✅ Auto-save functionality operational with debounced pattern
- ✅ User-driven action flow implemented correctly
- ✅ Initial workflow integration completed
- ❌ **PENDING**: Steps 3-6 require additional testing and refinement
- ❌ **PENDING**: Comprehensive unit tests for AI generation
- ❌ **PENDING**: Integration tests for complete workflow
- ❌ **PENDING**: Error boundary testing and AI service mocking
- 🔄 **STATUS**: Story placed on hold to prioritize next story

**Critical Issue Resolved**: Initial implementation suffered from infinite useEffect recursion loops due to improper React + Convex integration patterns. Root cause was automatic action triggers in useEffect with state dependencies that created re-render cycles.

**Solution**: Refactored to user-driven action pattern following proper Convex reactive architecture:
- Removed automatic useEffect triggers for actions
- Implemented manual button-triggered generation
- Trust Convex useQuery for reactive UI updates
- Eliminated complex recursion protection in favor of proper patterns

**Major Learning**: Created comprehensive [React + Convex Patterns KDD](../technical-guides/react-convex-patterns-kdd.md) to prevent similar issues in future development.

### File List

**Primary Implementation Files:**
- `apps/web/components/incidents/ClarificationStep.tsx` - Main component (refactored to proper patterns)
- `apps/web/components/incidents/QuestionsList.tsx` - Question display component
- `apps/web/components/incidents/QuestionCard.tsx` - Individual question component
- `apps/web/components/incidents/IncidentCaptureWorkflow.tsx` - Updated workflow integration
- `apps/convex/aiClarification.ts` - Backend question generation and management
- `apps/convex/lib/ai/questionGenerator.ts` - AI service integration
- `apps/web/types/clarification.ts` - TypeScript interfaces

**Documentation Created:**
- `docs/technical-guides/react-convex-patterns-kdd.md` - **Critical patterns guide**
- Updated `docs/index.md` - Added KDD references
- Updated `docs/patterns/frontend-patterns.md` - Added React + Convex integration patterns

**Testing Infrastructure:**
- `tests/convex/incidents/incident-capture-workflow.test.ts`
- `tests/web/components/incidents/IncidentCaptureWorkflow.test.tsx`
- `tests/convex/ai/clarification-system.test.ts`
- `tests/integration/incident-workflow-integration.test.ts`

## QA Results

*This section will be populated by QA Agent after story completion*

### Pattern Compliance Review
*To be filled by QA agent*

### Knowledge Capture
*To be filled by QA agent*  

### Velocity Data
*To be filled by QA agent*