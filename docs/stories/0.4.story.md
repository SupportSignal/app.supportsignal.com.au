# Story 0.4: Apply Coding Standards from Inconsistencies Audit

## Status
Draft

## Story
**As a** development team maintaining the SupportSignal codebase,
**I want** to establish and enforce consistent coding standards based on Story 0.3's inconsistencies audit,
**so that** we reduce false positives in static analysis (from 50-78% to <20%), improve code maintainability, eliminate developer confusion about patterns, and enable reliable automated tooling.

## Acceptance Criteria

**Phase 1 (Critical - Required)**:
- [ ] All `(api as any)` type casts removed and replaced with proper typing
- [ ] ESLint rule added preventing `any` type casts on API object
- [ ] Centralized `routes.ts` created with type-safe helpers
- [ ] All object-based and template literal routes migrated to centralized system
- [ ] POC code marker standard documented in coding standards
- [ ] Existing POC code marked with standard headers

**Phase 2 (High Priority - Recommended)**:
- [ ] Component export pattern chosen and documented
- [ ] ESLint rule added for component export consistency
- [ ] Barrel export policy documented in coding standards
- [ ] Component organization guide added to coding standards

**Phase 3 (Medium Priority - Optional)**:
- [ ] File naming standard implemented (if team approves)
- [ ] Import path cleanup completed (if team approves)

**Validation (All Phases)**:
- [ ] `bun run typecheck` passes with zero errors
- [ ] `bun run lint` passes with zero warnings
- [ ] `bun test` passes (all tests green)
- [ ] `bun run build` completes successfully
- [ ] Updated coding standards documentation published

**Documentation**:
- [ ] `docs/architecture/coding-standards.md` updated with new standards
- [ ] Migration decisions documented in story completion notes
- [ ] ESLint configuration updated and documented

## Estimation & Planning

### Story Points
**13**

### Estimated Complexity
**High** - Requires codebase-wide changes, TypeScript type system fixes, comprehensive testing, and ESLint rule creation

### Estimated Time
12-20 hours

### Risk Level
**High**

### Risk Factors
- **Type System Complexity**: Fixing `(api as any)` type casts may reveal complex TypeScript type generation issues in Convex
- **Breaking Changes**: Route centralization and component export pattern changes could break existing code
- **Scope Creep**: Optional phases (file naming, import paths) could expand significantly
- **Coordination**: Changes affect ongoing feature development, requires synchronization
- **Hidden Type Errors**: Removing type casts may expose latent type mismatches throughout codebase

### Mitigation Strategy
- **Phased Approach**: Implement critical fixes first (Phase 1), defer optional improvements (Phase 3)
- **Incremental Validation**: Run full test suite after each phase
- **Team Discussion**: Get buy-in on standards before implementation
- **Git Safety**: Commit after each phase for easy rollback
- **Focus on New Code**: Consider enforcing standards for new code vs migrating all existing code

## Tasks / Subtasks

- [ ] **Phase 0: Team Discussion & Prioritization** (AC: All)
  - [ ] Present `docs/auditing/coding-inconsistencies-audit.md` to team
  - [ ] Get team decision on which phases to implement (Critical/High/Medium)
  - [ ] Decide migration strategy: big bang vs incremental
  - [ ] Determine ESLint rule strictness: error vs warning

- [ ] **Phase 1: Critical Fixes** (AC: Phase 1)
  - [ ] **Task 1.1: Fix `(api as any)` Type Casts** (AC: 1)
    - [ ] Find all instances: `grep -r "(api as any)" apps/`
    - [ ] Investigate root cause of type cast requirement
    - [ ] Fix Convex type generation or import patterns
    - [ ] Replace all type casts with proper typing
    - [ ] Validate: `bun run typecheck` passes
  - [ ] **Task 1.2: Add ESLint Rule for API Type Safety** (AC: 2)
    - [ ] Create custom ESLint rule or find existing rule
    - [ ] Configure in `.eslintrc.json` to ban `(api as any)`
    - [ ] Run `bun run lint` to verify rule works
    - [ ] Document rule in coding standards
  - [ ] **Task 1.3: Centralize Route Definitions** (AC: 3, 4)
    - [ ] Create `apps/web/lib/routes.ts` with type-safe structure
    - [ ] Find all object-based routes: `grep -r "href:" apps/web/`
    - [ ] Find all template literal routes: `grep -r "\`.*/.*/\`" apps/convex/`
    - [ ] Migrate routes to centralized `ROUTES` constant
    - [ ] Update all route references in components and backend
    - [ ] Validate: `bun run typecheck && bun test`
  - [ ] **Task 1.4: Establish POC Code Markers** (AC: 5, 6)
    - [ ] Document POC header format in `docs/architecture/coding-standards.md`
    - [ ] Find existing POC/experimental code (check git history, comments)
    - [ ] Add standard POC markers to identified experimental code
    - [ ] Update coding standards with when/how to use markers

- [ ] **Phase 2: High Priority (Developer Experience)** (AC: Phase 2)
  - [ ] **Task 2.1: Standardize Component Exports** (AC: 7, 8)
    - [ ] Choose export pattern: `export function` (recommended) or `export const`
    - [ ] Document decision in coding standards
    - [ ] Add ESLint rule: `@typescript-eslint/consistent-type-exports` or custom
    - [ ] Optional: Create codemod to migrate existing code
  - [ ] **Task 2.2: Document Barrel Export Policy** (AC: 9)
    - [ ] Define when to create `index.ts` files (public API dirs only)
    - [ ] Document in coding standards
    - [ ] Add guidance: features/ and shared/ use barrels, internal dirs don't
  - [ ] **Task 2.3: Component Organization Guide** (AC: 10)
    - [ ] Document structure: `features/` vs `ui/` vs `pages/`
    - [ ] Add to coding standards with examples
    - [ ] Reference: `docs/auditing/coding-inconsistencies-audit.md` Section 5

- [ ] **Phase 3: Medium Priority (Optional)** (AC: Phase 3)
  - [ ] **Task 3.1: File Naming Migration** (if approved) (AC: 11)
    - [ ] Create list of PascalCase files
    - [ ] Write codemod or manual migration plan
    - [ ] Migrate to kebab-case
    - [ ] Update imports
  - [ ] **Task 3.2: Import Path Cleanup** (if approved) (AC: 12)
    - [ ] Find relative imports: `grep -r "from '\.\./\.\." apps/`
    - [ ] Create codemod to convert to `@/` aliases
    - [ ] Apply migration
    - [ ] Validate

- [ ] **Phase 4: Validation & Documentation** (AC: Validation, Documentation)
  - [ ] Run comprehensive validation suite:
    - [ ] `bun run typecheck` - TypeScript compilation
    - [ ] `bun run lint` - ESLint validation (should be zero violations)
    - [ ] `bun test` - All unit tests pass
    - [ ] `bun run build` - Production build succeeds
    - [ ] `bun test:e2e` - E2E tests pass
  - [ ] Update `docs/architecture/coding-standards.md` with all new standards
  - [ ] Document migration decisions in story completion notes
  - [ ] Update `.eslintrc.json` comments explaining new rules

## Documentation Impact Assessment

### Architectural Patterns
- **Type-Safe Route Pattern**: Centralized route definitions with type safety (NEW)
- **POC Code Identification Pattern**: Standard markers for experimental code (NEW)
- **Component Export Consistency**: Single export pattern enforced (ESTABLISHED)
- **Barrel Export Policy**: When to use index.ts aggregation (DOCUMENTED)

### Documentation Updates Required
- **`docs/architecture/coding-standards.md`**: Add all new standards and patterns (CRITICAL UPDATE)
- **`.eslintrc.json`**: Add rules and comments (UPDATE)
- **`docs/patterns/frontend-patterns.md`**: Add component export and route patterns (OPTIONAL)
- **`docs/patterns/backend-patterns.md`**: Add API typing patterns (OPTIONAL)

### Knowledge Capture Opportunities
- **Type system challenges with Convex**: Document how to properly type Convex API calls
- **Route centralization benefits**: Measure reduction in false positives
- **Static analysis improvements**: Before/after metrics showing analysis accuracy gains
- **ESLint rule creation**: Process for creating custom rules for project-specific patterns

### Examples to Create
- **Centralized routes example**: Reference implementation in `apps/web/lib/routes.ts`
- **POC code markers**: Examples of properly marked experimental code
- **Component export patterns**: Before/after migration examples

## Dev Notes

### Previous Story Insights

**From Story 0.3 (Dead Code Analysis)**:
- Type casts `(api as any)` caused **50% false positive rate** in Convex function analysis (35 functions appeared orphaned but were actively used)
- Object-based routes (`href: '/path'`) caused **72% false positive rate** in route analysis (13 routes missed by grep)
- Mixed export patterns (`export function` vs `export const`) required **4 iterations** to get accurate component analysis
- Analysis difficulty: 4-8 iterations per phase due to inconsistent patterns

**Key Learning**: Coding inconsistencies don't just affect code quality—they make automated analysis unreliable and waste significant development time.

[Source: docs/stories/0.3.story.md, docs/auditing/coding-inconsistencies-audit.md]

### Coding Standards (Current State)

**From `docs/architecture/coding-standards.md`**:

**Current Standards (Existing)**:
- ✅ TypeScript strict mode enabled
- ✅ No `any` type policy (but violated via `(api as any)` pattern!)
- ✅ No direct `process.env` access (centralized config)
- ✅ Repository pattern for data access
- ✅ Correlation IDs for request tracking

**Gaps Identified**:
- ❌ No component export pattern standard
- ❌ No barrel export policy
- ❌ No route definition pattern
- ❌ No POC code marking standard
- ❌ No file naming convention
- ❌ No import path convention

[Source: docs/architecture/coding-standards.md]

### Inconsistencies Summary (from Audit)

**From `docs/auditing/coding-inconsistencies-audit.md`**:

**Top 3 Critical Issues** (Phase 1 targets):

1. **Type Casts `(api as any)` - 🔴 CRITICAL**
   - Impact: 50% false positive rate in function analysis
   - Root cause: TypeScript type inference issues with Convex API
   - Example violation: `const createCompany = useMutation((api as any).companies.createCompany)`
   - Correct pattern: `const createCompany = useMutation(api.companies.createCompany)`

2. **Object vs JSX Route Definitions - 🔴 HIGH**
   - Impact: 72% false positive rate in route analysis
   - Pattern 1: `<Link href="/admin/analytics">` (JSX attribute)
   - Pattern 2: `{ href: '/admin/analytics' }` (object property)
   - Pattern 3: `` `${config.baseUrl}/reset-password?token=${token}` `` (template literal)
   - Solution: Centralize all routes in `routes.ts`

3. **Mixed Export Patterns - 🟡 MEDIUM**
   - Pattern 1: `export function AuthProvider({ children }: Props) { ... }` (52%)
   - Pattern 2: `export const StatusBadge: React.FC<Props> = ({ ... }) => { ... }` (48%)
   - Impact: Grep must handle both patterns, developers confused which to use
   - Recommendation: Prefer `export function` (cleaner, better TypeScript inference)

[Source: docs/auditing/coding-inconsistencies-audit.md Sections 1, 3, 4]

### File Locations & Structure

**Route Centralization**:
- Create: `apps/web/lib/routes.ts` (new file)
- Pattern:
```typescript
export const ROUTES = {
  admin: {
    analytics: '/admin/analytics',
    users: '/admin/users',
  },
  auth: {
    resetPassword: (token: string) => `/reset-password?token=${token}`,
  }
} as const;
```

**Coding Standards Update**:
- Update: `docs/architecture/coding-standards.md`
- Add sections:
  - Component Export Pattern
  - Barrel Export Policy
  - Route Definition Pattern
  - POC Code Markers
  - File Naming Convention (if Phase 3)

**ESLint Configuration**:
- Update: `.eslintrc.json` (project root)
- Add rules:
  - Custom rule or `@typescript-eslint/no-explicit-any` with API context
  - Component export consistency rule

[Source: Project structure analysis]

### Pattern Validation

**Existing Patterns to Follow**:

1. **TypeScript Strict Mode** [Source: docs/architecture/coding-standards.md]
   - All new code must pass strict type checking
   - No `any` types allowed (enforce with ESLint)

2. **Centralized Configuration** [Source: docs/architecture/coding-standards.md]
   - Routes should follow same pattern as environment config
   - Single source of truth for route definitions

3. **Testing Infrastructure** [Source: docs/testing/technical/test-strategy-and-standards.md]
   - Centralized test location: `tests/` directory
   - After changes, run full test suite

**New Patterns to Establish**:

1. **Type-Safe Route Definition**
   - All routes defined in `routes.ts`
   - Type-safe helper functions for dynamic routes
   - No hardcoded route strings in components

2. **Component Export Consistency**
   - Single pattern across codebase
   - Enforced by ESLint

3. **POC Code Identification**
   - Standard header comment format
   - Clear indicators for experimental code

[Source: docs/architecture/coding-standards.md, docs/auditing/coding-inconsistencies-audit.md]

### Testing

**From `docs/testing/technical/test-strategy-and-standards.md`**:

**Test Location**:
- ALL tests in centralized `tests/` directory
- NOT in `apps/` directories with `__tests__/`

**Test Requirements for This Story**:
1. **After Type Cast Fixes**: Run Convex function tests to verify API calls work
2. **After Route Migration**: Run route navigation tests (E2E if available)
3. **After Each Phase**: Full regression suite
   - `bun test` - Unit tests
   - `bun test:e2e` - E2E tests (if applicable)

**Validation Commands**:
```bash
bun run typecheck  # TypeScript compilation
bun run lint       # ESLint (should show zero violations after fixes)
bun test           # Unit tests
bun run build      # Production build
```

[Source: docs/testing/technical/test-strategy-and-standards.md]

### Technical Constraints

**From `docs/architecture/tech-stack.md`**:
- TypeScript 5.4.5+ (supports latest features)
- ESLint 8.57.0+ (custom rule support)
- Next.js 14.2.15 (App Router patterns)
- Convex 1.25.4+ (type generation system)

**Success Metrics** (from Epic):
- Static analysis false positive rate: 50-78% → <20%
- Time to perform code analysis: 4-8 iterations → 1-2 iterations
- Developer confidence in static analysis: Low → High
- ESLint violations for new code: Zero

[Source: docs/architecture/tech-stack.md, docs/prd/epic-0.md#Story 0.4]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Story created based on Story 0.3 inconsistencies audit | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent during implementation_

### Debug Log References
_To be filled by Dev Agent during implementation_

### Completion Notes
_To be filled by Dev Agent during implementation_

### File List
_To be filled by Dev Agent during implementation_

## QA Results

### Pattern Compliance Review
_To be filled by QA Agent after implementation_

### Knowledge Capture Reference
_To be filled by QA Agent after implementation_

### Velocity Data
_To be filled by QA Agent after implementation_
