# Story 7.3: Site Management (System Admin)

## Status
Draft

## Story
**As a** system administrator,
**I want** to create and manage sites (physical locations) for service provider companies,
**so that** participants can be organized by their care location and incidents can be tracked by site.

## Acceptance Criteria

1. **Sites Database Schema**: New `sites` table with `company_id`, `name`, `created_at` fields
2. **Site Management Interface**: System admin interface at `/admin/companies/{id}/sites`
3. **Create Site**: Form to add new site to a company
4. **List Sites**: View all sites for a company with participant counts
5. **Edit Site**: Update site name and details
6. **Delete Site**: Remove site (validation: cannot delete if has participants)
7. **Default Site Creation**: Auto-create "Primary" site when company is created
8. **Site Validation**: Enforce at least one site per company
9. **Migration Script**: Create "Primary" site for all existing companies
10. **Participant Migration**: Link all existing participants to their company's Primary site
11. **Backend Functions**: `sites.admin.*` functions for CRUD operations
12. **Company Scoping**: Sites are company-scoped, system admin can manage all sites

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**Medium-High**

### Estimated Time
**3-4 days**

### Risk Level
**Medium**

**Risk Factors:**
- Data migration complexity (linking existing participants and incidents to Primary sites)
- Site deletion validation (preventing orphaned participants)
- Referential integrity during migration (must maintain company → site → participant relationships)
- Schema deployment timing (sites table must exist before participants schema update)

**Mitigation Strategies:**
- Comprehensive migration scripts with validation and rollback capability
- Strict validation preventing deletion of sites with participants
- Phased migration approach (create sites → update participants schema → link participants)
- Testing migration on development environment before production deployment

## Tasks / Subtasks

- [ ] Task 1: Implement sites database schema (AC: 1)
  - [ ] Add `sites` table to `apps/convex/schema.ts` with validation
  - [ ] Define table structure: `_id`, `company_id`, `name`, `created_at`, `created_by`, `updated_at`
  - [ ] Add indexes: `by_company` and `by_name` (company_id + name unique)
  - [ ] Deploy schema changes to Convex development environment
  - [ ] Verify table creation using Convex dashboard

- [ ] Task 2: Create backend site management functions (AC: 3, 4, 5, 6, 11)
  - [ ] Implement `sites/admin/createSite.ts` action with company validation
  - [ ] Implement `sites/admin/listCompanySites.ts` query with participant count aggregation
  - [ ] Implement `sites/admin/getSiteDetails.ts` query for editing
  - [ ] Implement `sites/admin/updateSite.ts` mutation for name changes
  - [ ] Implement `sites/admin/deleteSite.ts` mutation with participant validation
  - [ ] Implement `sites/admin/getPrimarySite.ts` helper for default site
  - [ ] Add site name uniqueness validation within company scope
  - [ ] Add "at least one site" validation for deletion
  - [ ] Test all CRUD operations with proper error handling

- [ ] Task 3: Create Primary site migration script (AC: 7, 9)
  - [ ] Implement `sites/migration/createPrimarySitesForExistingCompanies.ts` migration
  - [ ] For each company without sites, create "Primary" site
  - [ ] Set `created_by` to system admin user
  - [ ] Add logging for audit trail
  - [ ] Add validation to verify all companies have at least one site
  - [ ] Test migration on development environment
  - [ ] Document migration execution procedure

- [ ] Task 4: Update participants schema and migration (AC: 10)
  - [ ] Add `site_id: v.id("sites")` field to participants table
  - [ ] Add indexes: `by_site` and `by_company_and_site`
  - [ ] Deploy schema changes to Convex
  - [ ] Implement `participants/migration/linkToPrimarySites.ts` migration
  - [ ] For each participant without `site_id`, find company's Primary site and link
  - [ ] Add logging for all participant updates
  - [ ] Verify all participants have `site_id` populated

- [ ] Task 5: Create site management UI (AC: 2, 3, 4, 5, 6, 8, 12)
  - [ ] Create `/admin/companies/[id]/sites/page.tsx` for site listing
  - [ ] Display all sites for company with participant counts
  - [ ] Add "Create Site" button linking to creation form
  - [ ] Create `/admin/companies/[id]/sites/create/page.tsx` for site creation
  - [ ] Implement site creation form with name input and validation
  - [ ] Create `/admin/companies/[id]/sites/[siteId]/edit/page.tsx` for editing
  - [ ] Implement site edit form with name update capability
  - [ ] Add delete site functionality with confirmation modal
  - [ ] Display validation message when attempting to delete site with participants
  - [ ] Add success/error feedback for all operations
  - [ ] Ensure company scoping (system admin can manage all sites)

- [ ] Task 6: Update company creation to auto-create Primary site (AC: 7)
  - [ ] Update `companies/onboarding/createCompanyWithAdmin.ts` to create Primary site
  - [ ] Add site creation step after company creation
  - [ ] Ensure transactional integrity (rollback if site creation fails)
  - [ ] Test company creation workflow includes Primary site

- [ ] Task 7: Testing and validation (AC: All)
  - [ ] Test site CRUD operations for all roles
  - [ ] Test site deletion validation (prevent deletion with participants)
  - [ ] Test migration scripts on development data
  - [ ] Verify referential integrity after migrations
  - [ ] Test company creation includes Primary site
  - [ ] Test site name uniqueness within company
  - [ ] Test "at least one site per company" validation
  - [ ] Verify participant counts display correctly in site listings
  - [ ] Test error scenarios (duplicate names, invalid deletions, missing data)

## Documentation Impact Assessment

**Architectural Patterns:**
- **Site-based organization pattern** for multi-location service providers
- **Data migration patterns** for adding new required relationships
- **Referential integrity patterns** for cascade relationships
- **System admin CRUD patterns** for multi-tenant resource management

**Documentation Updates Needed:**
- `docs/architecture/data-models.md` - Sites table and relationships
- `docs/patterns/backend-patterns.md` - Site management and migration patterns
- `docs/examples/backend/` - Site CRUD implementation examples
- `docs/technical-guides/` - Site migration and management procedures

**Knowledge Capture:**
- Site-based organization model for participants
- Migration strategy for adding required foreign keys
- Referential integrity validation patterns
- Multi-step migration coordination (sites → participants → incidents)

**Examples to Create:**
- Complete site CRUD implementation
- Data migration with validation and rollback
- Foreign key relationship migration
- System admin multi-tenant resource management

## Dev Notes

### Architecture Context

**Multi-Tenant Site Foundation:**
[Source: docs/prd/epic-7.md#multi-tenant-site-architecture]

Sites represent physical locations where frontline workers look after participants. This is a fundamental organizational structure for service providers:

**Key Concept**:
```
Company (NDIS Service Provider)
  └── Sites (1 or more locations)
        ├── Site 1 (e.g., "North Sydney Office")
        │     ├── Participant 1
        │     ├── Participant 2
        │     └── Participant 3
        └── Site 2 (e.g., "Parramatta Branch")
              ├── Participant 4
              └── Participant 5
```

**Relationships**:
- Company → Sites (one-to-many)
- Site → Participants (one-to-many) - Story 7.4
- Incident → Site (many-to-one) - Story 7.6

**Critical Constraints**:
- Each company must have at least one site
- Site names must be unique within a company
- Sites cannot be deleted if they have participants assigned
- Site creation and deletion is **system admin only** (company admins can rename in Epic 9)

### Previous Story Insights

**Story 7.2 Lessons Learned:**
[Source: docs/stories/7.2.story.md - QA Results]

1. **Convex API Path Patterns**: Use `api["directory/file"].default` for public API, `internal.directory.file.functionName` for internal
2. **Actions vs Mutations**: Use actions for external integrations (email), mutations for database operations
3. **ConvexClientProvider Auto-Injection**: Add `sessionToken: v.optional(v.string())` to functions callable by logged-out users
4. **Error Handling**: Provide user-friendly error messages for all validation failures

### Database Schema

**Sites Table Definition:**
[Source: docs/prd/epic-7.md#sites-table-new---story-73]

```typescript
// apps/convex/schema.ts
sites: defineTable({
  _id: v.id("sites"),
  company_id: v.id("companies"),
  name: v.string(),  // e.g., "Primary", "North Sydney Office", "Parramatta Branch"
  created_at: v.number(),
  created_by: v.id("users"),
  updated_at: v.optional(v.number())
})
  .index("by_company", ["company_id"])
  .index("by_name", ["company_id", "name"])  // Ensures unique site names within company
```

**Participants Table Update (Story 7.4 Prerequisite):**
[Source: docs/prd/epic-7.md#participants-table-updates-story-74]

```typescript
// apps/convex/schema.ts - Add these fields in Story 7.4
participants: defineTable({
  // ... existing fields ...
  site_id: v.id("sites"),  // NEW FIELD - REQUIRED
  // ... existing fields ...
})
  .index("by_site", ["site_id"])  // NEW INDEX
  .index("by_company_and_site", ["company_id", "site_id"])  // NEW INDEX
```

**Note**: Incidents table will also receive `site_id` field in Story 7.6.

### API Specifications

**Backend Functions Required:**
[Source: docs/prd/epic-7.md#site-management-functions-system-admin-perspective]

```typescript
// Site Management (System Admin Only)
sites.admin.createSite                     // Create new site for company
sites.admin.listCompanySites              // List all sites for a company
sites.admin.getSiteDetails                // Get site details with participant count
sites.admin.updateSite                    // Update site name and details
sites.admin.deleteSite                    // Delete site (validation: no participants)
sites.admin.getPrimarySite                // Get or create Primary site for company
sites.validation.validateSiteDeletion     // Check if site can be deleted
sites.migration.createPrimarySites        // Migration: create Primary for all companies
sites.migration.linkParticipantsToPrimary // Migration: link existing participants (Story 7.4)
```

**Function Signatures:**

```typescript
// sites/admin/createSite.ts
export default mutation({
  args: {
    companyId: v.id("companies"),
    name: v.string(),
    sessionToken: v.string()
  },
  handler: async (ctx, args) => {
    // 1. Validate session and system_admin role
    // 2. Check site name uniqueness within company
    // 3. Create site with current user as created_by
    // 4. Return site._id
  }
});

// sites/admin/listCompanySites.ts
export default query({
  args: {
    companyId: v.id("companies"),
    sessionToken: v.string()
  },
  handler: async (ctx, args) => {
    // 1. Validate session and system_admin role
    // 2. Query all sites for company
    // 3. For each site, count participants (will be 0 until Story 7.4)
    // 4. Return sites with participant_count field
  }
});

// sites/admin/deleteSite.ts
export default mutation({
  args: {
    siteId: v.id("sites"),
    sessionToken: v.string()
  },
  handler: async (ctx, args) => {
    // 1. Validate session and system_admin role
    // 2. Check if site has participants (count > 0)
    // 3. If has participants, throw error: "Cannot delete site with participants"
    // 4. Check if company has only one site
    // 5. If last site, throw error: "Company must have at least one site"
    // 6. Delete site
  }
});
```

### Migration Strategy

**CRITICAL: Migration Execution Order**
[Source: docs/prd/epic-7.md#migration-strategy]

The migration must follow this exact order to maintain referential integrity:

**Phase 1: Schema Setup** (Story 7.3 start)
1. Add `sites` table to `apps/convex/schema.ts`
2. Deploy schema changes to Convex (`bunx convex deploy`)
3. Verify table creation using Convex dashboard or `bunx convex data sites`
4. Confirm `sites` table is ready before proceeding

**Phase 2: Create Primary Sites** (Story 7.3 implementation)
1. Develop migration script: `sites/migration/createPrimarySitesForExistingCompanies.ts`
2. For each company without sites:
   - Create site with name "Primary"
   - Set `company_id` to link to company
   - Set `created_by` to system admin user
   - Set `created_at` to current timestamp
3. Verify all companies have at least one site
4. Log all site creation operations for audit trail

**Phase 3: Update Participants Schema** (Story 7.4 prerequisite)
1. Add `site_id: v.id("sites")` field to `participants` table in schema.ts
2. Add indexes: `by_site` and `by_company_and_site`
3. Deploy schema changes to Convex
4. Develop migration script: `participants/migration/linkToPrimarySites.ts`
5. For each participant without `site_id`:
   - Find participant's `company_id`
   - Find company's Primary site
   - Set `participant.site_id = primary_site._id`
6. Verify all participants have `site_id` populated
7. Log all participant updates for audit trail

**Phase 4: Update Incidents Schema** (Story 7.6 prerequisite)
1. Add `site_id: v.id("sites")` field to `incidents` table in schema.ts
2. Add indexes: `by_site` and `by_company_and_site`
3. Deploy schema changes to Convex
4. Develop migration script: `incidents/migration/linkToPrimarySites.ts`
5. For each incident without `site_id`:
   - Find incident's company via `participant.company_id`
   - Find company's Primary site
   - Set `incident.site_id = primary_site._id`
6. Verify all incidents have `site_id` populated
7. Log all incident updates for audit trail

**Story 7.3 Completion Criteria:**

Story 7.3 is ONLY complete when:
- ✅ Sites table exists in `schema.ts` and deployed to Convex
- ✅ Primary sites created for all existing companies
- ✅ Migration scripts tested and documented
- ✅ Site CRUD backend functions implemented and tested
- ✅ Site management UI functional (`/admin/companies/{id}/sites`)
- ✅ All acceptance criteria met

**Migration Script Locations:**
```
apps/convex/sites/migration.ts           // createPrimarySitesForExistingCompanies
apps/convex/participants/migration.ts    // linkToPrimarySites (Story 7.4)
apps/convex/incidents/migration.ts       // linkToPrimarySites (Story 7.6)
```

### File Locations

**Backend Functions:**
[Source: docs/architecture/unified-project-structure.md]

```
apps/convex/sites/
  ├── admin/
  │   ├── createSite.ts              // System admin site creation
  │   ├── listCompanySites.ts        // List sites with participant counts
  │   ├── getSiteDetails.ts          // Get single site for editing
  │   ├── updateSite.ts              // Update site name/details
  │   ├── deleteSite.ts              // Delete site with validation
  │   └── getPrimarySite.ts          // Get or create Primary site
  ├── validation/
  │   └── validateSiteDeletion.ts    // Check if site can be deleted
  └── migration/
      └── createPrimarySitesForExistingCompanies.ts  // Migration script
```

**Frontend Pages:**
[Source: Next.js App Router conventions]

```
apps/web/app/admin/companies/[id]/
  └── sites/
      ├── page.tsx                   // Site listing with participant counts
      ├── create/
      │   └── page.tsx               // Create new site form
      └── [siteId]/
          └── edit/
              └── page.tsx           // Edit site name form
```

### Component Specifications

**Site Listing Page Component:**
[Source: Frontend patterns from Stories 7.1 and 7.2]

```typescript
// apps/web/app/admin/companies/[id]/sites/page.tsx
'use client';

import { useQuery, useMutation } from 'convex/react';
import { api } from '@/convex/_generated/api';
import { Button } from '@starter/ui/button';
import { Card } from '@starter/ui/card';
import { useAuth } from '@/components/auth/auth-provider';
import { useRouter } from 'next/navigation';
import Cookies from 'js-cookie';

interface SiteListingProps {
  params: { id: string }; // company_id from URL
}

export default function SiteListingPage({ params }: SiteListingProps) {
  const router = useRouter();
  const sessionToken = Cookies.get('sessionToken');

  // Query sites for company
  const sites = useQuery(api["sites/admin/listCompanySites"].default, {
    companyId: params.id,
    sessionToken: sessionToken || '',
  });

  // Delete site mutation
  const deleteSite = useMutation(api["sites/admin/deleteSite"].default);

  // Features:
  // - Display sites in table/card layout
  // - Show site name, created date, participant count
  // - "Create Site" button → /admin/companies/{id}/sites/create
  // - "Edit" button → /admin/companies/{id}/sites/{siteId}/edit
  // - "Delete" button with confirmation modal
  // - Validation message: "Cannot delete site with participants"
  // - Validation message: "Company must have at least one site"
}
```

**Site Creation Form Component:**

```typescript
// apps/web/app/admin/companies/[id]/sites/create/page.tsx
'use client';

import { useMutation } from 'convex/react';
import { api } from '@/convex/_generated/api';
import { useState } from 'react';
import { Button } from '@starter/ui/button';
import { Input } from '@starter/ui/input';
import { Label } from '@starter/ui/label';

interface CreateSiteFormProps {
  params: { id: string }; // company_id
}

export default function CreateSitePage({ params }: CreateSiteFormProps) {
  const [name, setName] = useState('');
  const [error, setError] = useState<string | null>(null);

  const createSite = useMutation(api["sites/admin/createSite"].default);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      await createSite({
        companyId: params.id,
        name,
        sessionToken: sessionToken || '',
      });
      // Success: redirect to site listing
      router.push(`/admin/companies/${params.id}/sites`);
    } catch (err: any) {
      // Handle errors: duplicate name, validation failures
      setError(err.message);
    }
  };

  // Features:
  // - Site name input field
  // - Validation: required, unique within company
  // - Error handling for duplicate names
  // - Success redirect to site listing
  // - Cancel button returns to listing
}
```

### Testing Requirements

**Test File Locations:**
[Source: docs/testing/technical/test-strategy-and-standards.md]

```
tests/convex/sites/admin/
  ├── createSite.test.ts
  ├── listCompanySites.test.ts
  ├── getSiteDetails.test.ts
  ├── updateSite.test.ts
  └── deleteSite.test.ts

tests/convex/sites/migration/
  └── createPrimarySitesForExistingCompanies.test.ts

tests/web/integration/
  └── site-management-workflow.test.ts

tests/e2e/
  └── site-management.spec.ts
```

**Testing Frameworks:**
- Jest for unit and integration testing
- Playwright for E2E testing
- Centralized Jest configuration following established patterns

**Coverage Requirements:**
- Unit tests: 85%+ statement coverage
- Integration tests: Complete site CRUD workflow
- Migration tests: Verify Primary site creation for all companies
- E2E tests: Full site management user journey

**Testing Patterns:**
[Source: docs/patterns/testing-patterns.md]
- Mock database operations for unit tests
- Test all validation scenarios (duplicate names, participant constraints)
- Test migration scripts with rollback capability
- Test error handling and user-friendly error messages

### Pattern Validation

**Coding Standards Compliance:**
[Source: docs/architecture/coding-standards.md]

- **No Direct process.env**: Use centralized `urlConfig.ts` for environment variables
- **TypeScript Strict Mode**: All code must be fully type-safe
- **Repository Pattern**: Data access follows established patterns
- **Component Export Style**: Use `export function ComponentName()` not arrow functions
- **Route Management**: Use centralized `ROUTES` constant from `apps/web/lib/routes.ts`

**Backend Patterns:**
[Source: docs/patterns/backend-patterns.md]

- Follow Convex API path patterns from Story 7.2 (bracket/slash for public, dot for internal)
- Use mutations for database write operations
- Implement proper authentication and role validation
- Use ConvexError for user-facing error messages
- Include correlation IDs for request tracking

**Frontend Patterns:**
[Source: Stories 7.1 and 7.2 implementation]

- Use 'use client' directive for client components
- Import from `@/convex/_generated/api` for Convex functions
- Use `useQuery` and `useMutation` hooks for data operations
- Implement proper loading states and error handling
- Use ShadCN UI components (Button, Card, Input, Label, Alert)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-09 | 1.0 | Initial story creation from Epic 7 requirements | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results

### Pattern Compliance Review
*To be populated by QA agent*

### Knowledge Capture Reference
*To be populated by QA agent*

### Velocity Data
*To be populated by QA agent*
