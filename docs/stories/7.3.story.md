# Story 7.3: Site Management (System Admin)

## Status
Approved

## Story
**As a** system administrator,
**I want** to create and manage sites (physical locations) for service provider companies,
**so that** participants can be organized by their care location and incidents can be tracked by site.

## Acceptance Criteria

1. **Sites Database Schema**: New `sites` table with `company_id`, `name`, `created_at` fields
2. **Site Management Interface**: System admin interface at `/admin/companies/{id}/sites`
3. **Create Site**: Form to add new site to a company
4. **List Sites**: View all sites for a company with participant counts
5. **Edit Site**: Update site name and details
6. **Delete Site**: Remove site (validation: cannot delete if has participants)
7. **Default Site Creation**: Auto-create "Primary" site when company is created
8. **Site Validation**: Enforce at least one site per company
9. **Migration Script**: Create "Primary" site for all existing companies
10. **Participant Migration**: Link all existing participants to their company's Primary site
11. **Backend Functions**: `sites.admin.*` functions for CRUD operations
12. **Company Scoping**: Sites are company-scoped, system admin can manage all sites

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**Medium-High**

### Estimated Time
**3-4 days**

### Risk Level
**Medium**

**Risk Factors:**
- Data migration complexity (linking existing participants and incidents to Primary sites)
- Site deletion validation (preventing orphaned participants)
- Referential integrity during migration (must maintain company → site → participant relationships)
- Schema deployment timing (sites table must exist before participants schema update)

**Mitigation Strategies:**
- Comprehensive migration scripts with validation and rollback capability
- Strict validation preventing deletion of sites with participants
- Phased migration approach (create sites → update participants schema → link participants)
- Testing migration on development environment before production deployment

## Tasks / Subtasks

### Phase 1: Schema Setup and Site Table Creation (AC: 1, 9)
- [ ] **Task 1.1**: Add `sites` table to `apps/convex/schema.ts`
  - [ ] Define sites schema with fields: `company_id`, `name`, `created_at`, `created_by`, `updated_at`
  - [ ] Add indexes: `by_company` and `by_name` (company_id + name for uniqueness)
  - [ ] Verify schema follows existing patterns from companies and participants tables
- [ ] **Task 1.2**: Deploy schema changes to Convex
  - [ ] Run `bunx convex deploy` for development environment
  - [ ] Verify table creation using `bunx convex data sites`
  - [ ] Deploy to production: `CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex deploy`
  - [ ] Confirm `sites` table exists in both environments

### Phase 2: Migration Script - Create Primary Sites (AC: 9)
- [ ] **Task 2.1**: Create migration script at `apps/convex/sites/migration.ts`
  - [ ] Implement `createPrimarySitesForExistingCompanies` internalMutation
  - [ ] Query all companies without sites using index
  - [ ] For each company, insert "Primary" site with proper fields
  - [ ] Log all site creation operations for audit trail
  - [ ] Return summary: { created: number, skipped: number, totalCompanies: number }
- [ ] **Task 2.2**: Test migration in development
  - [ ] Run `bunx convex run sites/migration:createPrimarySitesForExistingCompanies`
  - [ ] Verify all companies have Primary site
  - [ ] Check Convex dashboard for site data
- [ ] **Task 2.3**: Run migration in production
  - [ ] Run `CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex run sites/migration:createPrimarySitesForExistingCompanies`
  - [ ] Verify production sites created successfully

### Phase 3: Backend CRUD Functions (AC: 3, 4, 5, 6, 11, 12)
- [ ] **Task 3.1**: Create `apps/convex/sites/admin.ts` with system admin CRUD operations
  - [ ] `listSites(sessionToken, companyId)` - Query with participant count aggregation
  - [ ] `createSite(sessionToken, companyId, name)` - With system admin auth check
  - [ ] `updateSite(sessionToken, siteId, name)` - Update site name
  - [ ] `deleteSite(sessionToken, siteId)` - With participant validation (cannot delete if has participants)
  - [ ] `getSiteById(sessionToken, siteId)` - Single site details
  - [ ] All functions use `requirePermission` for system admin auth
- [ ] **Task 3.2**: Implement site validation logic
  - [ ] Prevent deletion of last site for a company (enforce at least one site rule)
  - [ ] Check for participants assigned to site before deletion
  - [ ] Return clear error messages for validation failures
- [ ] **Task 3.3**: Test backend functions
  - [ ] Test create site for multiple companies
  - [ ] Test update site name
  - [ ] Test delete site with and without participants
  - [ ] Test delete validation (last site protection)

### Phase 4: Frontend Site Management UI (AC: 2, 3, 4, 5, 6)
- [ ] **Task 4.1**: Create site management page at `apps/web/app/admin/companies/[id]/sites/page.tsx`
  - [ ] Add navigation tab to company admin interface
  - [ ] Create "Sites" tab alongside "Users" tab
  - [ ] Use system admin auth protection
- [ ] **Task 4.2**: Implement Sites List Component
  - [ ] Query sites using `api["sites/admin"].listSites` with bracket notation pattern
  - [ ] Display table with columns: Name, Participant Count, Created Date, Actions
  - [ ] Show "Add Site" button
  - [ ] Show Edit and Delete actions per site
- [ ] **Task 4.3**: Create Site Form Component
  - [ ] Form with site name field (required, min 2 chars)
  - [ ] Company ID passed from parent route params
  - [ ] Submit to `api["sites/admin"].createSite`
  - [ ] Show success/error toast notifications
  - [ ] Reset form after successful creation
- [ ] **Task 4.4**: Implement Edit Site Dialog
  - [ ] Modal dialog with site name field
  - [ ] Pre-populate with current site name
  - [ ] Update via `api["sites/admin"].updateSite`
  - [ ] Close dialog and refresh list on success
- [ ] **Task 4.5**: Implement Delete Site Confirmation
  - [ ] Confirmation dialog before deletion
  - [ ] Show participant count in warning message
  - [ ] Handle deletion errors (sites with participants)
  - [ ] Display clear error if deletion blocked
  - [ ] Refresh list after successful deletion

### Phase 5: Integration with Company Creation (AC: 7, 8)
- [ ] **Task 5.1**: Update `companies.ts` createCompany function
  - [ ] After creating company, automatically create "Primary" site
  - [ ] Use internal mutation pattern to call sites creation
  - [ ] Handle site creation errors gracefully
  - [ ] Log Primary site creation for audit
- [ ] **Task 5.2**: Test company creation flow
  - [ ] Create new company via `/admin/companies/create`
  - [ ] Verify Primary site exists for new company
  - [ ] Check site appears in sites management page

### Phase 6: Testing and Documentation (AC: All)
- [ ] **Task 6.1**: Write unit tests for backend functions
  - [ ] Test CRUD operations in `tests/convex/sites/`
  - [ ] Test validation rules (last site, participants check)
  - [ ] Test migration script idempotency
- [ ] **Task 6.2**: Integration testing
  - [ ] Test complete flow: create company → site auto-created → manual site creation → site deletion
  - [ ] Test error scenarios and validation
- [ ] **Task 6.3**: Update documentation
  - [ ] Document site management patterns if new patterns emerge
  - [ ] Add migration notes to technical documentation

## Documentation Impact Assessment

**Architectural Patterns**:
- Multi-tenant site management pattern (company → sites → participants hierarchy)
- Migration script patterns for schema changes with referential integrity
- Automatic resource creation during parent entity creation (Primary site on company creation)

**Documentation Updates**:
- May need pattern documentation in `docs/patterns/` for migration strategies
- Examples of phased schema migrations with data backfill
- Validation patterns for preventing orphaned child records

**Knowledge Capture**:
- Site management architectural decisions
- Migration execution order and validation approach
- Testing strategies for complex schema changes

## Dev Notes

### Previous Story Insights

**From Story 7.2 (User Invitation System)**:
- Use bracket notation for Convex subdirectory paths: `api["sites/admin"].createSite` not `api.sites.admin.createSite`
- Actions (not mutations) required when using `fetch()` for external calls
- Internal mutation pattern: separate `internalMutation` helpers for database operations
- Path pattern reference: [Source: docs/patterns/backend-patterns.md - Convex API Path Patterns]

### Pattern Validation

**Established Patterns to Follow**:

1. **Convex Function Organization** [Source: docs/patterns/backend-patterns.md]
   - Create subdirectory: `apps/convex/sites/` for site-related functions
   - Separate files: `admin.ts` (CRUD operations), `migration.ts` (data migrations)
   - Use `internalMutation` for helpers, public `mutation`/`query` for client calls

2. **Authentication Pattern** [Source: docs/patterns/backend-patterns.md]
   ```typescript
   import { requirePermission, PERMISSIONS } from '../permissions';

   export const createSite = mutation({
     args: { sessionToken: v.string(), companyId: v.id("companies"), name: v.string() },
     handler: async (ctx, args) => {
       const { user } = await requirePermission(
         ctx,
         args.sessionToken,
         PERMISSIONS.MANAGE_COMPANIES
       );
       // ... site creation logic
     }
   });
   ```

3. **Migration Script Pattern** [Source: Story 7.3 PRD - Epic 7]
   - Use `internalMutation` for migration functions
   - Return summary object: `{ created: number, skipped: number, total: number }`
   - Log all operations for audit trail
   - Make migrations idempotent (check before creating)

4. **Schema Index Pattern** [Source: apps/convex/schema.ts - companies/participants examples]
   ```typescript
   sites: defineTable({
     company_id: v.id("companies"),
     name: v.string(),
     created_at: v.number(),
     created_by: v.id("users"),
     updated_at: v.optional(v.number())
   })
     .index("by_company", ["company_id"])
     .index("by_name", ["company_id", "name"]) // Composite for uniqueness
   ```

### Data Models

**Sites Table Schema** [Source: docs/prd/epic-7.md - Story 7.3 Prerequisites]:
```typescript
sites: defineTable({
  _id: v.id("sites"),
  company_id: v.id("companies"),      // Foreign key to companies
  name: v.string(),                    // "Primary", "North Sydney Office", etc.
  created_at: v.number(),              // Unix timestamp
  created_by: v.id("users"),           // System admin who created
  updated_at: v.optional(v.number())   // Last update timestamp
})
  .index("by_company", ["company_id"])
  .index("by_name", ["company_id", "name"])
```

**Relationship to Existing Tables**:
- Company → Sites (one-to-many): `sites.company_id` references `companies._id`
- Participants (future - Story 7.4): Will add `site_id` field linking to sites
- Incidents (future - Story 7.6): Will add `site_id` field for site-based tracking

**Existing Companies Schema** [Source: apps/convex/schema.ts]:
```typescript
companies: defineTable({
  name: v.string(),
  slug: v.string(),
  contact_email: v.string(),
  status: v.union(v.literal("active"), v.literal("trial"), v.literal("suspended"), v.literal("test")),
  created_at: v.number(),
  created_by: v.optional(v.id("users"))
})
  .index("by_status", ["status"])
  .index("by_slug", ["slug"])
```

### API Specifications

**Backend Functions Location**: `apps/convex/sites/admin.ts`

**Function Signatures**:

```typescript
// List all sites for a company with participant counts
export const listSites = query({
  args: {
    sessionToken: v.string(),
    companyId: v.id("companies")
  },
  handler: async (ctx, args) => {
    // Returns: Array<{ _id, name, participant_count, created_at }>
  }
});

// Create new site for a company
export const createSite = mutation({
  args: {
    sessionToken: v.string(),
    companyId: v.id("companies"),
    name: v.string()
  },
  handler: async (ctx, args) => {
    // Returns: { siteId: Id<"sites"> }
  }
});

// Update site name
export const updateSite = mutation({
  args: {
    sessionToken: v.string(),
    siteId: v.id("sites"),
    name: v.string()
  },
  handler: async (ctx, args) => {
    // Returns: { success: boolean }
  }
});

// Delete site (with validation)
export const deleteSite = mutation({
  args: {
    sessionToken: v.string(),
    siteId: v.id("sites")
  },
  handler: async (ctx, args) => {
    // Returns: { success: boolean }
    // Throws: ConvexError if site has participants or is last site
  }
});
```

**Migration Function** [Source: docs/prd/epic-7.md]:
```typescript
// apps/convex/sites/migration.ts
export const createPrimarySitesForExistingCompanies = internalMutation({
  args: {},
  handler: async (ctx) => {
    // 1. Query all companies
    // 2. For each company without sites, create "Primary" site
    // 3. Return { created: number, skipped: number, totalCompanies: number }
  }
});
```

### Component Specifications

**Site Management Page**: `apps/web/app/admin/companies/[id]/sites/page.tsx`

**Component Structure**:
```typescript
'use client';

export default function CompanySitesPage({ params }: { params: { id: string } }) {
  const { user, sessionToken } = useAuth();
  const companyId = params.id as Id<"companies">;

  // Use bracket notation for subdirectory paths
  const sites = useQuery(api["sites/admin"].listSites, {
    sessionToken: sessionToken || '',
    companyId: companyId
  });

  const createSite = useMutation(api["sites/admin"].createSite);
  const updateSite = useMutation(api["sites/admin"].updateSite);
  const deleteSite = useMutation(api["sites/admin"].deleteSite);

  // UI Components: Table, Form Dialog, Edit Dialog, Delete Confirmation
}
```

**UI Components Needed**:
- `<SitesTable>`: Display sites with participant counts
- `<CreateSiteDialog>`: Form to add new site
- `<EditSiteDialog>`: Form to update site name
- `<DeleteSiteConfirmation>`: Confirmation dialog with participant warning

### File Locations

**Backend Files**:
- `apps/convex/sites/admin.ts` - CRUD operations for site management
- `apps/convex/sites/migration.ts` - Migration script for Primary sites
- `apps/convex/schema.ts` - Add sites table definition (lines to be added near companies definition)

**Frontend Files**:
- `apps/web/app/admin/companies/[id]/sites/page.tsx` - Site management page
- `apps/web/components/admin/sites/` - Site management UI components (if complex enough to warrant separation)

**Test Files** [Source: docs/testing/technical/test-strategy-and-standards.md]:
- `tests/convex/sites/admin.test.ts` - Backend function tests
- `tests/convex/sites/migration.test.ts` - Migration script tests
- `tests/web/admin/sites/` - Frontend component tests (if needed)

### Testing

**Testing Standards** [Source: docs/testing/technical/test-strategy-and-standards.md]:

**Test Location**: All tests go in centralized `tests/` directory, NOT in app directories

**Backend Testing**:
- Location: `tests/convex/sites/`
- Framework: Jest with Convex testing utilities
- Coverage: CRUD operations, validation rules, migration script
- Key scenarios:
  - Create site with valid/invalid company ID
  - Delete site with/without participants
  - Delete last site (should fail)
  - Migration script idempotency

**Frontend Testing**:
- Location: `tests/web/admin/sites/` (if complex components warrant testing)
- Framework: Jest + React Testing Library
- Use path aliases: `@/components` not `../../../../apps/web/components`
- Pragmatic testing: Test behavior, not implementation details

**Migration Testing Strategy**:
1. Test in development first with existing data
2. Verify idempotency (run twice, should skip existing)
3. Check Convex dashboard for data integrity
4. Document rollback procedures if needed

**Test Commands**:
```bash
# Backend tests
bun test tests/convex/sites/

# All tests
bun test

# From project root (ALWAYS run from root)
pwd  # Verify: /Users/davidcruwys/dev/clients/supportsignal/app.supportsignal.com.au
```

### Technical Constraints

**Schema Deployment Order** [Source: docs/prd/epic-7.md - Migration Strategy]:

**CRITICAL**: Must follow this exact sequence:
1. **Phase 1**: Add `sites` table to schema → Deploy
2. **Phase 2**: Create Primary sites for all companies → Run migration
3. **Phase 3** (Story 7.4): Add `site_id` to participants → Deploy → Migrate participants
4. **Phase 4** (Story 7.6): Add `site_id` to incidents → Deploy → Migrate incidents

**Convex Deployment Commands**:
```bash
# Development
bunx convex deploy

# Production
CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex deploy

# Run migration (development)
bunx convex run sites/migration:createPrimarySitesForExistingCompanies

# Run migration (production)
CONVEX_DEPLOYMENT=prod:graceful-shrimp-355 bunx convex run sites/migration:createPrimarySitesForExistingCompanies
```

**Validation Rules**:
- Site name required, minimum 2 characters
- Company must have at least one site at all times
- Cannot delete site if it has participants assigned
- Site names should be unique within a company (enforced by composite index)

**Error Handling** [Source: docs/patterns/backend-patterns.md]:
```typescript
import { ConvexError } from 'convex/values';

// Clear error messages for validation failures
throw new ConvexError('Cannot delete site with assigned participants');
throw new ConvexError('Company must have at least one site');
throw new ConvexError('Site not found or access denied');
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-09 | 1.0 | Story created from Epic 7 requirements | Bob (Scrum Master) |
| 2025-10-09 | 1.1 | Story validated and approved for implementation (10/10 readiness score) | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results

### Pattern Compliance Review
_To be populated after implementation_

### Knowledge Capture Reference

**Pattern Documented**: [Sonner Toast Configuration Pattern](../patterns/sonner-toast-configuration.md)
- Complete setup guide for Sonner toast notifications
- Required `<Toaster />` component configuration
- Error handling pattern with ConvexError
- Toast types and styling options

**Implementation Example**: [Sonner Toast CRUD Feedback Example](../examples/sonner-toast-crud-feedback-example.md)
- Complete CRUD operations with toast notifications
- Backend structured error handling pattern
- Frontend error extraction and display
- Working code from Story 7.3 implementation

**Lesson Learned**: [Toast Notification Debugging (Story 7.3)](../lessons-learned/toast-notification-debugging-story-7-3.md)
- Root cause: Missing `<Toaster />` component in layout caused silent failures
- Debugging journey: 4-5 failed attempts focused on error extraction before discovering UI configuration issue
- Key learning: Check foundational infrastructure before complex solutions

### Velocity Data
_To be populated after story completion_
