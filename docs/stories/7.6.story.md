# Story 7.6: Incident Capture Site Selection

## Status
Approved

## Story
**As a** frontline worker capturing incidents,
**I want** the incident site to auto-populate from the participant's default site when I select a participant,
**so that** I don't have to manually select the site each time while still being able to change it if the incident occurred at a different location.

## Acceptance Criteria

1. **Incident Schema Update**: Add `site_id` field to incidents table (required, references sites)
2. **Smart Auto-Population**: When participant is selected on wizard page 1, auto-populate site from participant's `site_id`
3. **Site Override**: Frontline worker can manually change the site selection if incident occurred elsewhere
4. **Site Dropdown**: Site selection dropdown on incident wizard page 1, positioned above location text field
5. **Site Data**: Dropdown shows all sites for the user's company
6. **Required Field**: Site selection is required to proceed in wizard
7. **Validation**: Cannot create incident without site selection
8. **Migration Script**: Populate all existing incidents with site (prefer participant's site, fallback to Primary)
9. **Incident List**: Show site information in incident listings
10. **Site Filter**: Add site filter to incident search/filter interface

## Estimation & Planning

### Story Points
**5**

### Estimated Complexity
**Medium**

Complexity drivers:
- Schema migration with data backfill
- Smart auto-population logic from participant
- Site dropdown integration in wizard
- Production data fix prerequisite
- Incident listing updates

### Estimated Time
**2-3 days**

Breakdown:
- Schema update + migration: 0.5 day
- Production data fix: 0.25 day
- Smart auto-population logic: 0.5 day
- Site dropdown UI: 0.5 day
- Incident listing updates: 0.5 day
- Testing and validation: 0.75 day

### Risk Level
**Medium**

**Risk Factors:**
- Production data inconsistency (2 participants missing site_id)
- Migration complexity for existing incidents
- Auto-population timing/lifecycle issues
- Site validation edge cases

**Mitigation Strategies:**
- **Data Fix First**: Populate missing site_id for production participants before story implementation
- **Safe Migration**: Use participant's site_id where available, fallback to Primary site
- **Clear UI Feedback**: Show which site was auto-populated and allow easy override
- **Comprehensive Testing**: Test auto-population with various participant/site combinations

## Tasks / Subtasks

### Phase 0: Production Data Fix (PREREQUISITE)

**CRITICAL**: Must fix production data before implementing schema changes.

- [ ] **Task 0.1**: Identify production participants missing site_id
  - [x] Already identified: Sarah Williams, James Brown (from investigation)
  - [ ] Confirm these are the only participants without site_id
  - [ ] Document their company associations

- [ ] **Task 0.2**: Populate missing site_id values
  - [ ] For each participant without site_id:
    - Find their company
    - Find company's Primary site
    - Update participant.site_id = primary_site._id
  - [ ] Verify all participants now have site_id populated
  - [ ] Document changes in production

### Phase 1: Schema Update (AC: 1)

- [ ] **Task 1.1**: Update incidents schema
  - [ ] Add `site_id: v.id("sites")` field to incidents table (REQUIRED)
  - [ ] Add index: `.index("by_site", ["site_id"])`
  - [ ] Add compound index: `.index("by_company_and_site", ["company_id", "site_id"])`
  - [ ] Deploy schema to development environment
  - [ ] Verify schema deployed successfully

- [ ] **Task 1.2**: Update participants schema (optional - consider making site_id required)
  - [ ] Review: Should participants.site_id be required?
  - [ ] If yes: Change from `v.optional(v.id("sites"))` to `v.id("sites")`
  - [ ] Document decision in completion notes

### Phase 2: Data Migration (AC: 8)

- [ ] **Task 2.1**: Create migration script
  - [ ] Create file: `apps/convex/migrations/populateIncidentSites.ts`
  - [ ] Implement smart migration logic:
    ```typescript
    // For each incident without site_id:
    // 1. Get participant from incident.participant_id
    // 2. If participant has site_id → use participant.site_id
    // 3. Else → find company's Primary site, use that
    // 4. Update incident.site_id
    ```
  - [ ] Add logging for migration progress
  - [ ] Add rollback capability (optional)

- [ ] **Task 2.2**: Test migration in development
  - [ ] Run migration on development database
  - [ ] Verify all incidents now have site_id
  - [ ] Check logs for any errors or edge cases
  - [ ] Document migration results

- [ ] **Task 2.3**: Execute migration in production
  - [ ] Backup production database (if possible)
  - [ ] Run migration on production
  - [ ] Verify all production incidents have site_id
  - [ ] Document production migration completion

### Phase 3: Smart Auto-Population Backend (AC: 2)

- [ ] **Task 3.1**: Update incident creation logic
  - [ ] Locate incident creation function: `apps/convex/incidents.ts` (or similar)
  - [ ] Update function signature to accept `site_id`
  - [ ] Add site_id validation (required field, must be valid site in company)
  - [ ] Verify incident.site_id is set during creation
  - [ ] Add error handling for missing/invalid site_id

- [ ] **Task 3.2**: Create site query helper
  - [ ] Add function: `sites.queries.listSitesForCompany(sessionToken, companyId)`
  - [ ] Returns array of sites for dropdown
  - [ ] Includes site name and ID
  - [ ] Sorted alphabetically by name

### Phase 4: Smart Auto-Population Frontend (AC: 2, 3, 4, 5, 6, 7)

- [ ] **Task 4.1**: Add site dropdown to wizard page 1
  - [ ] Locate incident wizard page 1 component
  - [ ] Add site selection dropdown (ShadCN Select component)
  - [ ] Position dropdown just above location text field
  - [ ] Query company's sites using helper from Task 3.2
  - [ ] Add loading state while sites load
  - [ ] Display site names in dropdown options

- [ ] **Task 4.2**: Implement smart auto-population logic
  - [ ] When participant is selected:
    - Get participant object from selection
    - Extract participant.site_id
    - Auto-populate site dropdown with participant.site_id
    - Clear any site validation errors
  - [ ] Add guard against empty values (ShadCN Select lifecycle issue)
  - [ ] Add console logging for debugging (remove before final commit)
  - [ ] Test: Site auto-populates when participant selected

- [ ] **Task 4.3**: Implement site override capability
  - [ ] Frontline worker can manually change site selection
  - [ ] Site dropdown remains enabled (not disabled after auto-population)
  - [ ] onChange handler updates site state
  - [ ] Clear validation errors when user changes site
  - [ ] Test: User can override auto-populated site

- [ ] **Task 4.4**: Add site validation
  - [ ] Mark site as required field
  - [ ] Validate site is selected before proceeding to wizard page 2
  - [ ] Show validation error if site not selected
  - [ ] Prevent form submission without site
  - [ ] Test: Validation blocks progression when site missing

- [ ] **Task 4.5**: Handle edge cases
  - [ ] **No participant selected**: Site dropdown shows all sites, no auto-population
  - [ ] **Participant has no site_id**: Auto-populate with Primary site (fallback)
  - [ ] **Company has only one site**: Auto-select that site (existing behavior)
  - [ ] **Participant deleted during incident capture**: Handle gracefully
  - [ ] Test all edge cases

### Phase 5: Incident Listing Updates (AC: 9, 10)

- [ ] **Task 5.1**: Update incident listing queries
  - [ ] Update incident query to include site information
  - [ ] Join sites table to get site name
  - [ ] Ensure site data included in incident list response

- [ ] **Task 5.2**: Display site in incident listings
  - [ ] Locate incident listing component
  - [ ] Add "Site" column to table (after Participant, before Location)
  - [ ] Display site name from incident.site_id
  - [ ] Handle null site gracefully (should not happen after migration)
  - [ ] Test: Site column shows correct site names

- [ ] **Task 5.3**: Add site filter to incident search
  - [ ] Add site filter dropdown to incident search/filter interface
  - [ ] Filter shows all sites for user's company
  - [ ] Apply site filter to incident query
  - [ ] Support "All Sites" option (default)
  - [ ] Persist filter state in URL/session
  - [ ] Test: Site filter correctly filters incidents

### Phase 6: Testing & Validation (All AC)

- [ ] **Task 6.1**: Test smart auto-population
  - [ ] Test: Selecting participant auto-populates site
  - [ ] Test: Auto-populated site matches participant's site_id
  - [ ] Test: User can override auto-populated site
  - [ ] Test: No site selected shows validation error
  - [ ] Test: Edge cases (no participant, no site_id, one site)

- [ ] **Task 6.2**: Test incident creation flow
  - [ ] Test: Create incident with auto-populated site
  - [ ] Test: Create incident with manually selected site
  - [ ] Test: Validation prevents submission without site
  - [ ] Test: Incident saves with correct site_id
  - [ ] Verify incident appears in database with site association

- [ ] **Task 6.3**: Test incident listing
  - [ ] Test: Incident listing shows site column
  - [ ] Test: Site names display correctly
  - [ ] Test: Site filter works correctly
  - [ ] Test: "All Sites" shows all incidents
  - [ ] Test: Specific site filter shows only that site's incidents

- [ ] **Task 6.4**: Test migration completeness
  - [ ] Verify all development incidents have site_id
  - [ ] Verify all production incidents have site_id
  - [ ] Verify no null site_id values in database
  - [ ] Check migration logs for errors

## Documentation Impact Assessment

### Architectural Patterns
- **Smart Auto-Population Pattern**: Populate form fields from related entity defaults (NEW)
- **Fallback Population Strategy**: Use related entity value, fallback to company default (NEW)
- **Form Field Override Pattern**: Allow user to change auto-populated values (ESTABLISHED)
- **Select Auto-Population Guard**: Guard against ShadCN Select lifecycle issues (ESTABLISHED - Story 7.5)

### Documentation Updates Required
- `docs/patterns/smart-auto-population-pattern.md` - Document auto-population from related entities (CREATE)
- `docs/examples/form-auto-population/` - Example implementation with Select components (CREATE if significant)
- `docs/lessons-learned/` - Capture any migration or data fix insights (UPDATE if significant issues)

### Knowledge Capture Opportunities
- **Migration strategy**: Prefer related entity data over company defaults
- **Production data fixes**: Workflow for fixing data inconsistencies before schema changes
- **Select auto-population**: Complete pattern with guards and validation clearing
- **Edge case handling**: Graceful fallbacks for missing or deleted related data

### Examples to Create
- Smart auto-population from participant to incident
- Site dropdown with auto-population and override
- Migration script with fallback logic

## Dev Notes

### Previous Story Insights

**From Story 7.5 (Company Management):**
- ShadCN Select components fire `onValueChange('')` during lifecycle - guard with `if (value)`
- Always clear validation errors in useEffect when auto-populating
- Both guards needed: empty value guard AND error clearing
- Console logging critical for debugging auto-population issues
- Pattern documented in Story 7.5 completion notes [Source: docs/stories/7.5.story.md]

**From Story 7.4 (Participant Setup):**
- Schema made `site_id` optional for migration compatibility
- Migration pattern: Link existing records to defaults before making fields required
- Auto-selection must clear validation errors to prevent premature display
- Manual testing in dev and production confirmed by user

**From Investigation (October 22, 2025):**
- Development DB: ✅ All participants have site_id populated
- Production DB: ⚠️ 2 participants (Sarah Williams, James Brown) missing site_id
- Participant selector uses REAL database data (NOT mocked)
- Participant objects include full `site_id` field

### Database Investigation Results

**Production Participants Needing Fix:**
```typescript
// These participants need site_id populated before story implementation:
// - Sarah Williams
// - James Brown
// Strategy: Find their company → Find Primary site → Update participant.site_id
```

**Participant Selector Component:**
- Location: `apps/web/components/participants/participant-selector.tsx`
- Data source: `api.participants.list.listParticipants` (real database)
- Returns full participant objects including `site_id`
- Already supports search and active participant filtering

### Incidents Schema (Current)

[Source: apps/convex/schema.ts]

```typescript
incidents: defineTable({
  company_id: v.id("companies"),
  participant_id: v.id("participants"),
  // ⚠️ ADDING: site_id: v.id("sites"),
  incident_datetime: v.string(),
  location: v.string(),
  created_by: v.id("users"),
  created_at: v.number(),
  updated_at: v.number(),
  updated_by: v.id("users"),
  overall_status: v.union(
    v.literal("draft"),
    v.literal("in_progress"),
    v.literal("pending_review"),
    v.literal("completed")
  ),
})
  .index("by_company", ["company_id"])
  .index("by_participant", ["participant_id"])
  // ⚠️ ADDING: .index("by_site", ["site_id"])
  // ⚠️ ADDING: .index("by_company_and_site", ["company_id", "site_id"])
```

**New Field:**
- `site_id`: Site where incident occurred (required, references sites table)

**New Indexes:**
- `by_site`: Query incidents by site
- `by_company_and_site`: Efficient filtering for site-specific incident lists

### Participants Schema (Current)

[Source: apps/convex/schema.ts]

```typescript
participants: defineTable({
  company_id: v.id("companies"),
  site_id: v.optional(v.id("sites")), // ⚠️ CONSIDER: Make required in this story?
  first_name: v.string(),
  last_name: v.string(),
  // ... other fields
})
  .index("by_company", ["company_id"])
  .index("by_site", ["site_id"])
  .index("by_company_and_site", ["company_id", "site_id"])
```

**Decision Point**: Should `site_id` be made required in participants schema?
- **Current**: Optional (for migration compatibility)
- **Option 1**: Keep optional (maintain flexibility)
- **Option 2**: Make required (enforce data integrity)
- **Recommendation**: Document decision in completion notes based on implementation findings

### Smart Auto-Population Logic

**Sequence:**
1. User selects participant from dropdown
2. Frontend receives full participant object (includes `site_id`)
3. Extract `site_id` from participant
4. Set site dropdown value to `site_id`
5. Clear any existing site validation errors
6. User can override if needed

**Edge Cases:**
- **Participant has no site_id**: Fallback to company's Primary site
- **Company has only one site**: Auto-select (existing behavior still applies)
- **Participant selected then cleared**: Clear site selection
- **Multiple participants with different sites**: Use most recent selection

### Migration Strategy

**Smart Migration Algorithm:**
```typescript
async function populateIncidentSites(ctx: MutationCtx) {
  const incidents = await ctx.db.query("incidents").collect();

  for (const incident of incidents) {
    if (!incident.site_id) {
      // Get participant
      const participant = await ctx.db.get(incident.participant_id);

      let siteId: Id<"sites">;

      if (participant?.site_id) {
        // Prefer: Use participant's site
        siteId = participant.site_id;
      } else {
        // Fallback: Use company's Primary site
        const primarySite = await ctx.db
          .query("sites")
          .withIndex("by_company", q => q.eq("company_id", incident.company_id))
          .filter(q => q.eq(q.field("name"), "Primary"))
          .first();

        if (!primarySite) {
          console.error(`No Primary site for company ${incident.company_id}`);
          continue;
        }

        siteId = primarySite._id;
      }

      await ctx.db.patch(incident._id, { site_id: siteId });
    }
  }
}
```

### Form Validation Patterns

[Source: Story 7.5 - ShadCN Select Auto-Population]

**Complete Select Auto-Population Pattern:**
```typescript
// State
const [formData, setFormData] = useState({
  participantId: '' as Id<"participants"> | '',
  siteId: '' as Id<"sites"> | '',
});
const [errors, setErrors] = useState<Record<string, string>>({});

// When participant is selected
const handleParticipantChange = (participantId: Id<"participants">) => {
  // Find participant object
  const participant = participants?.find(p => p._id === participantId);

  if (participant?.site_id) {
    // Auto-populate site from participant
    setFormData({
      ...formData,
      participantId,
      siteId: participant.site_id, // ← Smart auto-population
    });

    // Clear site validation errors
    if (errors.siteId) {
      setErrors({ ...errors, siteId: '' });
    }
  } else {
    // No site_id - fallback to Primary site logic
    const primarySite = sites?.find(s => s.name === "Primary");
    setFormData({
      ...formData,
      participantId,
      siteId: primarySite?._id || '',
    });
  }
};

// Site Select component
<Select
  value={formData.siteId}
  onValueChange={(value) => {
    // CRITICAL: Guard against empty values from Select lifecycle (Story 7.5)
    if (value) {
      setFormData({ ...formData, siteId: value as Id<"sites"> });
      if (errors.siteId) {
        setErrors({ ...errors, siteId: '' });
      }
    }
  }}
>
  <SelectTrigger>
    <SelectValue placeholder="Select site" />
  </SelectTrigger>
  <SelectContent>
    {sites?.map(site => (
      <SelectItem key={site._id} value={site._id}>
        {site.name}
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

### UI Component Patterns

[Source: docs/architecture/coding-standards.md]

**ShadCN Components to Use:**
- `Select` from `@starter/ui/select` - Site dropdown
- `Label` from `@starter/ui/label` - Field labels
- `toast` from `sonner` - User feedback
- `Badge` from `@starter/ui/badge` - Status indicators (if needed)

**Component Export Style:**
```typescript
// ✅ Good - function declaration
export function IncidentWizardPageOne() {
  return <form>...</form>;
}

// ❌ Bad - arrow function
export const IncidentWizardPageOne = () => {
  return <form>...</form>;
};
```

### File Locations

**Backend Files:**
- `apps/convex/schema.ts` - Update incidents schema
- `apps/convex/incidents.ts` (or similar) - Update incident creation logic
- `apps/convex/sites/queries.ts` (or create) - Site query helpers
- `apps/convex/migrations/populateIncidentSites.ts` - Migration script

**Frontend Files:**
- Incident wizard page 1 component (locate existing)
- Incident listing component (update to show site)
- Incident search/filter component (add site filter)

**Component Directories:**
- `apps/web/components/incidents/` - Incident-specific components
- `apps/web/app/incidents/` - Incident pages

### Testing

[Source: docs/testing/technical/test-strategy-and-standards.md]

**Test Location:** Centralized in `tests/` directory

**Test Files to Create:**
- `tests/convex/incidents/site-auto-population.test.ts` - Auto-population logic tests
- `tests/web/integration/incident-site-selection.test.ts` - Site dropdown tests
- `tests/convex/migrations/populate-incident-sites.test.ts` - Migration tests (optional)

**Key Test Scenarios:**
- Smart auto-population from participant
- Site override by frontline worker
- Validation prevents submission without site
- Edge cases (no site_id, one site, no participant)
- Migration populates all incidents correctly
- Incident listing shows site information
- Site filter works correctly

### Pattern Validation

**Existing Patterns to Follow:**

1. **Select Auto-Population Pattern** [Source: Story 7.5]
   - Guard against empty values in onValueChange
   - Clear validation errors when auto-populating
   - Console logging for debugging
   - Both guards required (empty value + error clearing)

2. **Migration Pattern** [Source: Story 7.4]
   - Link existing records to defaults before making fields required
   - Log migration progress
   - Verify completeness after migration

3. **Form Validation Pattern** [Source: Story 7.4, 7.5]
   - Real-time validation on blur
   - Clear errors when auto-populating
   - Toast notifications for success/error

**New Patterns to Establish:**

1. **Smart Auto-Population from Related Entity** (NEW)
   - Populate form field from related entity's default
   - Allow user override after auto-population
   - Fallback to company default if entity has no value

2. **Prefer Related Entity Over Company Default** (NEW)
   - Migration: Try entity's value first, fallback to company default
   - UI: Auto-populate from entity, not just company-level defaults

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Story created using BMAD methodology with smart auto-population approach | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by developer agent_

### Debug Log References
_To be populated by developer agent during implementation_

### Completion Notes List
_To be populated by developer agent after implementation_

### File List
_To be populated by developer agent after implementation_

## Bugs Found During Story Acceptance Testing (SAT)
_To be populated during SAT execution_

## QA Results

### Pattern Compliance Review
_To be populated by QA agent after implementation_

### Knowledge Capture Reference
_To be populated by QA agent after implementation - Must reference knowledge base files per KDD process_

### Velocity Data
_To be populated by QA agent after implementation_
