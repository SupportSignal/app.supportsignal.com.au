# Story 11.0: AI Prompt Admin UI Refactor

## Status
InProgress

## Story
**As an** Angela (AI prompt administrator),
**I want** an improved AI prompt management interface with better organization, visualization, and usability,
**so that** I can efficiently manage existing prompts, create new analysis prompts, and understand prompt performance without navigating a confusing flat list.

## Acceptance Criteria

1. **Grouped UI with Collapsible Sections**: Prompts organized into groups with expand/collapse functionality
2. **Create/Rename/Delete Groups**: Full group management with validation (prevent deleting groups with active prompts)
3. **Drag-Drop Reordering**: Ability to reorder prompts within and between groups
4. **Model Selector Shows Cost Estimates**: Display per-prompt cost estimates (e.g., "gpt-4o: $0.015/prompt")
5. **Template Library**: Provide 3 starter templates (predicate, classification, observation)
6. **DX Toolbar Components Extracted**: Create reusable components for batch testing (Story 11.2)
7. **Migration Script**: Assign existing prompts to default groups based on `workflow_step`
8. **Preserve Epic 6 Functionality**: All existing prompt management features continue to work
9. **Responsive Design**: Interface works on tablet and desktop devices

## Estimation & Planning

### Story Points
**8**

### Estimated Complexity
**Medium-High**

### Estimated Time
**5 days** (1 week)

### Risk Level
**Medium**

**Risk Factors**:
- Drag-drop implementation with React DnD or similar library may require learning curve
- Data migration for existing prompts must be bulletproof (no data loss)
- DX toolbar refactoring must maintain backward compatibility
- Group deletion logic needs careful implementation (cascade handling)

## Tasks / Subtasks

- [x] **Task 1: Create `prompt_groups` Table** (AC: 1, 2)
  - [x] Add schema definition in `apps/convex/schema.ts`
  - [x] Create indexes: `by_name`, `by_display_order`
  - [x] Write Convex mutations: `createGroup`, `updateGroup`, `deleteGroup`
  - [x] Write Convex queries: `listGroups`, `getGroupById`
  - [x] Add validation: prevent deleting groups with active prompts

- [x] **Task 2: Create Migration Script for Existing Prompts** (AC: 7)
  - [x] Write Convex action to seed default groups ("Question Generation", "Narrative Enhancement", "Contributing Analysis")
  - [x] Write migration logic to assign prompts to groups based on `workflow_step` field
  - [x] Add `group_id` field to `ai_prompts` schema (optional, foreign key)
  - [ ] Test migration with production data snapshot (pending deployment)
  - [x] Document rollback procedure

- [x] **Task 3: Build PromptGroupManager Component** (AC: 1, 2, 3)
  - [x] Create `apps/web/components/admin/prompts/PromptGroupManager.tsx`
  - [x] Implement collapsible sections (Accordion from ShadCN UI)
  - [x] Add group CRUD operations (create, rename, delete with confirmation)
  - [x] Implement drag-drop library setup (@dnd-kit selected over react-beautiful-dnd)
  - [x] Connect to Convex queries/mutations
  - [x] Add loading and error states
  - [x] Created `packages/ui/src/accordion.tsx` (new ShadCN component)

- [x] **Task 4: Build Enhanced PromptCard Component** (AC: 1, 3)
  - [x] Create `apps/web/components/admin/prompts/PromptCard.tsx`
  - [x] Display: Name, Type, Model, Status, Usage Count, Success Rate
  - [x] Add drag handle for reordering
  - [x] Add quick actions: Edit, Duplicate, Delete, Toggle Active
  - [x] Implement drag-drop support within cards (useSortable hook)

- [x] **Task 5: Build Enhanced Model Selector** (AC: 4)
  - [x] Enhanced existing `apps/web/components/admin/model-selector.tsx`
  - [x] Add model options with cost indicators (gpt-5: $15, gpt-4o: $5, gpt-4o-mini: $0.15, claude-3.5-sonnet: $3, claude-3-haiku: $0.25 per 1M tokens)
  - [x] Display estimated cost per prompt execution
  - [x] Add tooltips explaining cost calculation
  - [x] Extract cost calculation logic to `apps/web/lib/ai-models.ts`

- [x] **Task 6: Create Template Library** (AC: 5)
  - [x] Created `apps/web/components/admin/prompts/TemplateLibrary.tsx`
  - [x] Defined 3 starter templates with categories:
    - Predicate Template: "Answer with Yes/No based on {{context}}"
    - Classification Template: "Classify {{input}} as one of: {{categories}}"
    - Observation Template: "Provide brief insight about {{data}}"
  - [x] Added "Use Template" button with placeholder handler (full implementation in Story 11.1)
  - [x] Added template descriptions, use cases, variables, and recommended models

- [x] **Task 7: Extract Reusable DX Toolbar Components** (AC: 6)
  - [x] Created `apps/web/components/developer/PromptVariablePreview.tsx`
    - Displays {{variables}} and their values with source indicators
    - Supports both single and batch testing modes
    - Foundation component for prompt testing workflows
  - [x] PromptTestingPanel already exists (created in earlier story)
    - Located at `apps/web/components/developer/prompt-testing-panel.tsx`
    - Full-featured prompt testing with live interpolation
  - [x] Created `apps/web/components/developer/PromptPerformanceMetrics.tsx`
    - Displays timing, token usage, cost per execution
    - Includes comparison view for batch results (Story 11.2)
    - Foundation component ready for enhancement
  - [x] Components created as foundation - integration with toolbar in Story 11.2

- [ ] **Task 8: Update Main Admin Page** (AC: 1, 8)
  - [ ] Modify `apps/web/app/admin/ai-prompts/page.tsx`
  - [ ] Replace flat list with `PromptGroupManager`
  - [ ] Add "Generation Prompts" vs "Analysis Prompts" tab structure (prep for 11.2)
  - [ ] Preserve all existing Epic 6 functionality
  - [ ] Add usage stats dashboard section

- [ ] **Task 9: Add Drag-Drop Reordering Backend** (AC: 3)
  - [ ] Write Convex mutation `reorderPrompts` (bulk update `display_order`)
  - [ ] Write Convex mutation `movePromptToGroup` (change `group_id` and `display_order`)
  - [ ] Add optimistic updates in frontend
  - [ ] Handle race conditions (multiple admins editing simultaneously)

- [ ] **Task 10: Responsive Design Implementation** (AC: 9)
  - [ ] Test on tablet viewport (768px-1024px)
  - [ ] Test on desktop viewport (1024px+)
  - [ ] Adjust drag-drop for touch devices (if supported)
  - [ ] Ensure collapsible sections work on mobile

- [x] **Task 11: Testing** (AC: ALL)
  - [x] Unit tests for group CRUD operations (`tests/convex/src/promptGroups.test.ts`)
  - [x] Unit tests for migration script (`tests/convex/src/migrations/assignPromptsToGroups.test.ts`)
  - [x] Foundation tests created with convex-test framework
  - [ ] Integration tests for drag-drop reordering (deferred to Story 11.1 - requires UI testing)
  - [ ] Integration tests for template library (deferred to Story 11.1 - requires UI testing)
  - [ ] E2E test: Create group, add prompts, reorder, delete group (deferred to Story 11.1)
  - [ ] E2E test: Migration script assigns correct groups (deferred to Story 11.1)
  - [ ] Performance test: Load 50+ prompts with groups <1s (deferred to Story 11.3)

## Documentation Impact Assessment

**Architectural Patterns**:
- Drag-drop pattern for React applications (component library choice, state management)
- Group management pattern (cascade deletion, referential integrity)
- Data migration pattern (backward compatibility, rollback procedures)

**Documentation Files to Update**:
- `docs/patterns/frontend-patterns.md` - Add drag-drop implementation pattern
- `docs/patterns/backend-patterns.md` - Add group management and migration patterns
- `docs/examples/admin-components/` - Create example of PromptGroupManager
- `docs/architecture/components.md` - Document new reusable DX toolbar components

**New Knowledge to Capture**:
- React drag-drop library selection criteria and implementation
- Data migration strategy for adding foreign key relationships
- Extracting reusable components from existing features
- Admin UI organization patterns (tabs, groups, collapsible sections)

**Examples to Create**:
- Complete drag-drop implementation with Convex backend
- Group-based data organization with CRUD operations
- Reusable developer toolbar components

## Dev Notes

### Previous Story Insights

**From Story 6.5 (LLM Model Management)**:
- Model selector already exists at `apps/web/components/admin/model-selector.tsx`
- Must extend existing component to add cost indicators
- Model cost data should be centralized (consider `lib/ai-models.ts` utility)

**From Story 6.4 (Prompt Phase Management)**:
- Existing prompt management UI at `apps/web/app/admin/ai-prompts/page.tsx`
- Current UI uses `prompt-template-list.tsx` component for flat list display
- Workflow step concept already exists in schema (`workflow_step` field)

### Pattern Validation

**Established Patterns to Follow**:

1. **Component Organization** [Source: docs/architecture/coding-standards.md#component-organization]
   - Use `export function ComponentName()` (NOT arrow functions)
   - Components in `apps/web/components/admin/prompts/` directory
   - Barrel exports only for public APIs

2. **TypeScript Standards** [Source: docs/architecture/coding-standards.md#typescript-requirements]
   - Strict mode enabled, no `any` type usage
   - Use `@ts-expect-error` with explanation if unavoidable
   - Prefer interfaces over types for objects

3. **Convex Schema Pattern** [Source: apps/convex/schema.ts]
   - Tables defined with `defineTable({})`
   - Indexes with `.index("by_field", ["field"])`
   - Foreign keys with `v.id("table_name")`
   - Optional fields with `v.optional()`

4. **Route Management** [Source: docs/architecture/coding-standards.md#route-management]
   - All routes in `apps/web/lib/routes.ts`
   - Use typed route constants: `ROUTES.admin.prompts.list`
   - No hardcoded route strings in components

### Data Models

**Current `ai_prompts` Schema** [Source: apps/convex/schema.ts]:
```typescript
ai_prompts: defineTable({
  // Prompt Identity
  prompt_name: v.string(),
  prompt_version: v.string(),

  // Prompt Content
  prompt_template: v.string(),
  description: v.optional(v.string()),
  input_schema: v.optional(v.string()),
  output_schema: v.optional(v.string()),

  // Developer Scoping (backward compatibility)
  scope: v.optional(v.union(v.literal("production"), v.literal("developer"))),
  developer_session_id: v.optional(v.string()),
  parent_prompt_id: v.optional(v.id("ai_prompts")),
  expires_at: v.optional(v.number()),

  // Usage Context
  workflow_step: v.optional(v.string()),
  subsystem: v.optional(v.string()),
  ai_model: v.string(),
  max_tokens: v.optional(v.number()),
  temperature: v.optional(v.number()),

  // Story 6.9: Adaptive Token Management
  baseline_max_tokens: v.optional(v.number()),
  adjusted_at: v.optional(v.number()),
  adjustment_reason: v.optional(v.string()),
  acknowledged_at: v.optional(v.number()),
  acknowledged_by: v.optional(v.id("users")),

  // Versioning
  is_active: v.optional(v.boolean()),
  created_at: v.number(),
  created_by: v.optional(v.id("users")),
  replaced_at: v.optional(v.number()),
  replaced_by: v.optional(v.string()),

  // Performance Metrics
  usage_count: v.optional(v.number()),
  average_response_time: v.optional(v.number()),
  success_rate: v.optional(v.number()),
})
  .index("by_name", ["prompt_name"])
  .index("by_name_version", ["prompt_name", "prompt_version"])
  .index("by_workflow_step", ["workflow_step"])
  .index("by_is_active", ["is_active"])
  .index("by_subsystem", ["subsystem"])
```

**NEW `prompt_groups` Schema to Create**:
```typescript
prompt_groups: defineTable({
  group_name: v.string(), // "Question Generation", "NDIS Compliance"
  description: v.optional(v.string()),
  display_order: v.number(), // For drag-drop reordering
  is_collapsible: v.optional(v.boolean()), // UI hint
  default_collapsed: v.optional(v.boolean()), // UI hint
  created_at: v.number(),
  created_by: v.optional(v.id("users")),
})
  .index("by_name", ["group_name"])
  .index("by_display_order", ["display_order"])
```

**Schema Extension for `ai_prompts`**:
```typescript
// ADD to existing ai_prompts table:
group_id: v.optional(v.id("prompt_groups")), // Foreign key
display_order: v.optional(v.number()), // Order within group
```

### API Specifications

**Convex Functions to Create** [Source: docs/prd/epic-11-multi-prompt-analysis-system.md]:

1. **Group Management**:
   - `createGroup(name, description)` - Mutation
   - `updateGroup(id, { name, description, display_order })` - Mutation
   - `deleteGroup(id)` - Mutation (with validation: reject if has active prompts)
   - `listGroups()` - Query
   - `getGroupById(id)` - Query

2. **Prompt Reordering**:
   - `reorderPrompts(promptIds: Id<"ai_prompts">[], newOrders: number[])` - Mutation (bulk update)
   - `movePromptToGroup(promptId, newGroupId, displayOrder)` - Mutation

3. **Migration**:
   - `seedDefaultGroups()` - Action (one-time seed)
   - `assignPromptsToGroups()` - Action (migration script)

### Component Specifications

**New Components to Create** [Source: docs/prd/epic-11-multi-prompt-analysis-system.md]:

1. **`PromptGroupManager.tsx`**:
   - Props: `groups: Group[], prompts: Prompt[], onReorder, onMoveGroup`
   - Uses ShadCN Accordion for collapsible sections
   - Implements drag-drop context provider
   - Handles optimistic updates

2. **`PromptCard.tsx`**:
   - Props: `prompt: Prompt, isDragging: boolean, dragHandleProps`
   - Displays prompt details in card format
   - Shows usage stats badge
   - Quick action buttons (edit, duplicate, delete, toggle)

3. **`ModelSelector.tsx`** (EXTEND EXISTING):
   - File exists: `apps/web/components/admin/model-selector.tsx`
   - Add cost indicator prop
   - Calculate estimated cost per prompt
   - Show tooltip with cost breakdown

4. **`TemplateLibrary.tsx`**:
   - Props: `onSelectTemplate: (template) => void`
   - Display 3 starter templates
   - "Use Template" button pre-fills create form

5. **Extracted DX Components**:
   - `PromptVariablePreview.tsx` - Shows {{variables}} with values
   - `PromptTestingPanel.tsx` - Execute and view results
   - `PromptPerformanceMetrics.tsx` - Timing, tokens, cost display

### File Locations

**Convex Backend** [Source: docs/architecture/source-tree.md]:
- Schema: `apps/convex/schema.ts` (modify existing, add prompt_groups)
- Group mutations: `apps/convex/promptGroups.ts` (new file)
- Group queries: `apps/convex/promptGroups.ts` (new file)
- Migration: `apps/convex/migrations/assignPromptsToGroups.ts` (new file)

**Frontend Components** [Source: docs/architecture/coding-standards.md]:
- `apps/web/components/admin/prompts/PromptGroupManager.tsx` (new)
- `apps/web/components/admin/prompts/PromptCard.tsx` (new)
- `apps/web/components/admin/prompts/TemplateLibrary.tsx` (new)
- `apps/web/components/admin/model-selector.tsx` (EXTEND existing)
- `apps/web/components/developer/PromptVariablePreview.tsx` (new, extracted)
- `apps/web/components/developer/PromptTestingPanel.tsx` (new, extracted)
- `apps/web/components/developer/PromptPerformanceMetrics.tsx` (new, extracted)

**Pages**:
- `apps/web/app/admin/ai-prompts/page.tsx` (MODIFY existing)

**Utilities**:
- `apps/web/lib/ai-models.ts` (new - centralize model costs)
- `apps/web/lib/routes.ts` (UPDATE if new routes needed)

### Testing

**Test File Locations** [Source: docs/testing/technical/test-strategy-and-standards.md]:
- Unit tests: `tests/web/src/components/admin/prompts/` (new directory)
- Integration tests: `tests/web/integration/prompt-group-management.test.ts` (new file)
- Convex tests: `tests/convex/src/promptGroups.test.ts` (new file)
- Migration tests: `tests/convex/src/migrations/assignPromptsToGroups.test.ts` (new file)

**Testing Frameworks** [Source: docs/architecture/tech-stack.md]:
- Unit tests: Jest + React Testing Library
- Integration tests: Jest + Convex test environment
- E2E tests: Playwright (for drag-drop interactions)

**Test Coverage Requirements** [Source: docs/testing/technical/test-strategy-and-standards.md]:
- Unit test coverage: 90%+ for business logic
- Integration tests: All CRUD operations for groups
- E2E tests: Critical user flows (create group, reorder prompts, use template)

**Specific Testing Requirements**:
1. **Group Deletion Validation**: Test that deletion fails if group has active prompts
2. **Migration Script**: Test assignment logic with mock data (various workflow_step values)
3. **Drag-Drop**: Test reordering within group, moving between groups
4. **Optimistic Updates**: Test race condition handling
5. **Responsive Design**: Visual regression tests for tablet/desktop viewports

### Technical Constraints

**Technology Versions** [Source: docs/architecture/tech-stack.md]:
- Next.js: 14.2.x (App Router)
- React: 18.2.0
- Convex: 1.12.x
- TypeScript: 5.4.x

**Drag-Drop Library Selection**:
- **Options**: react-beautiful-dnd (stable, no longer maintained), @dnd-kit (modern, actively maintained)
- **Recommendation**: Use @dnd-kit for modern React support and active maintenance
- **Installation**: `bun add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities`

**Performance Requirements** [Source: docs/prd/epic-11-multi-prompt-analysis-system.md]:
- Load 50+ prompts with groups: <1 second
- Drag-drop reordering: Immediate UI response (optimistic updates)
- Migration script: <5 seconds for 50 prompts

**Backward Compatibility**:
- All existing Epic 6 prompt management features must continue to work
- Existing prompts without `group_id` should display in "Ungrouped" section
- Migration is optional (system works with or without groups)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-30 | 1.0 | Initial story creation for Epic 11.0 | Bob (SM Agent) |
